{% extends "layout.html" %}

{% block title %}Explore Spots{% endblock %}
{% block extra_css %}
<style>
  body {
    background: #f2f6fb;
  }
  .card {
    border: 1px solid #dbe7f3;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 12px 28px rgba(15, 23, 42, 0.08);
  }
  .spot-logo-badge {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: #eef4ff;
    color: #1d4ed8;
    font-size: 0.95rem;
  }
  .spot-meta-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 0.75rem;
    border: 1px solid #dbeafe;
    color: #1d4ed8;
    background: #eff6ff;
    border-radius: 999px;
    padding: 2px 10px;
    margin-bottom: 8px;
  }
  .spot-marker-wrap {
    background: transparent;
    border: 0;
  }
  .spot-marker-pin {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    border: 2px solid #fff;
    background: #1d4ed8;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
  }
  .spot-photo-trigger {
    display: block;
    width: 100%;
    border: 0;
    padding: 0;
    background: transparent;
    border-radius: 0;
    overflow: hidden;
  }
  .spot-photo-trigger img {
    cursor: zoom-in;
    width: 100%;
  }
  #spotsPhotoCarousel .carousel-control-prev,
  #spotsPhotoCarousel .carousel-control-next {
    width: 12%;
    z-index: 8;
  }
  #spotsPhotoCarousel .carousel-control-prev-icon,
  #spotsPhotoCarousel .carousel-control-next-icon {
    width: 2.2rem;
    height: 2.2rem;
    background-size: 58% 58%;
    background-color: rgba(15, 23, 42, 0.68);
    border-radius: 50%;
    box-shadow: 0 8px 18px rgba(15, 23, 42, 0.35);
  }
  .spot-photo-modal-img {
    height: 460px;
    object-fit: cover;
    width: 100%;
  }
  @media (max-width: 575.98px) {
    #spotsPhotoCarousel .carousel-control-prev,
    #spotsPhotoCarousel .carousel-control-next {
      width: 18%;
    }
    .spot-photo-modal-img {
      height: 280px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
    <h2 class="fw-bold mb-0">Explore Tourist Spots</h2>
    <div class="text-muted small">Discover places without booking any tour</div>
  </div>

  <form method="GET" class="row g-2 mb-4">
    <div class="col-md-4">
      <input type="text" name="search" class="form-control" value="{{ search or '' }}" placeholder="Search spots, city, state">
    </div>
    <div class="col-md-3">
      <select name="state_id" id="spotsStateFilter" class="form-select">
        <option value="0">All States</option>
        {% for s in states %}
        <option value="{{ s.id }}" {% if state_id == s.id %}selected{% endif %}>{{ s.state_name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <select name="city_id" id="spotsCityFilter" class="form-select" {% if not state_id and not city_id %}disabled{% endif %}>
        <option value="0">All Cities</option>
        {% for c in cities %}
        <option value="{{ c.id }}" data-state-id="{{ c.state_id }}" {% if city_id == c.id %}selected{% endif %}>{{ c.city_name }} ({{ c.state_name }})</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2 d-grid">
      <button class="btn btn-primary">Filter</button>
    </div>
  </form>

  {% set geo_spots = map_spots or [] %}
  {% if geo_spots %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="card-title mb-2">Spot Map</h5>
      <div class="text-muted small mb-3">Interactive view of spots with location data</div>
      <div id="spotsMap" style="height: 420px; border-radius: 10px;"></div>
    </div>
  </div>
  {% endif %}

  {% if spots %}
  {% set image_ns = namespace(idx=0) %}
  <div class="row g-3">
    {% for s in spots %}
    <div class="col-md-6 col-lg-4">
      <div class="card h-100 shadow-sm">
        {% if s.image_url %}
          {% if s.photo_source == 'external_url' %}
            {% set spot_img_src = s.image_url %}
          {% else %}
            {% set spot_img_src = url_for('static', filename='uploads/' + s.image_url) %}
          {% endif %}
          <button
            type="button"
            class="spot-photo-trigger"
            data-gallery-index="{{ image_ns.idx }}"
            data-bs-toggle="modal"
            data-bs-target="#spotsPhotoModal"
            aria-label="Open photo for {{ s.spot_name }}"
          >
            <img src="{{ spot_img_src }}" class="card-img-top" style="height:220px;object-fit:cover;"
                 onerror="this.onerror=null;this.src='{{ url_for('static', filename='uploads/demo.jpg') }}';"
                 alt="{{ s.spot_name }}">
          </button>
          {% set image_ns.idx = image_ns.idx + 1 %}
        {% else %}
          <div class="card-img-top d-flex align-items-center justify-content-center text-muted" style="height:220px;background:#f8fafc;">
            <div class="text-center">
              <i class="bi bi-image fs-3 d-block mb-2"></i>
              <small>Photo Not Uploaded</small>
            </div>
          </div>
        {% endif %}
        <div class="card-body">
          <div class="spot-meta-chip"><i class="bi {{ s.logo_icon_class }}"></i> {{ s.logo_label }}</div>
          <h5 class="card-title d-flex align-items-center gap-2">
            <span class="spot-logo-badge"><i class="bi {{ s.logo_icon_class }}"></i></span>
            <span>{{ s.spot_name }}</span>
          </h5>
          <div class="text-muted small mb-2">{{ s.city_name }}, {{ s.state_name }}</div>
          {% if s.spot_details %}
          <p class="small mb-2">{{ s.spot_details }}</p>
          {% endif %}
          {% if s.latitude and s.longitude %}
          <div class="small text-muted">Location: {{ "%.4f"|format(s.latitude) }}, {{ "%.4f"|format(s.longitude) }}</div>
          <div class="small">
            <a target="_blank" rel="noopener" href="https://www.google.com/maps?q={{ s.latitude }},{{ s.longitude }}">
              Open in Maps
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% if image_ns.idx > 0 %}
  <div class="modal fade" id="spotsPhotoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Spot Photos</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="spotsPhotoCarousel" class="carousel slide" data-bs-interval="false">
            <div class="carousel-inner" id="spotsPhotoCarouselInner"></div>
            <button class="carousel-control-prev" type="button" data-bs-target="#spotsPhotoCarousel" data-bs-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#spotsPhotoCarousel" data-bs-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Next</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  {% else %}
  <div class="alert alert-warning">No spots found for this filter.</div>
  {% endif %}
</div>

{% if geo_spots %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
(() => {
  const mapEl = document.getElementById('spotsMap');
  if (!mapEl) return;

  const spots = [
    {% for s in geo_spots %}
    {
      name: {{ s.spot_name|tojson }},
      city: {{ s.city_name|tojson }},
      state: {{ s.state_name|tojson }},
      lat: {{ s.latitude }},
      lng: {{ s.longitude }},
      details: {{ (s.spot_details or '')|tojson }},
      iconClass: {{ (s.logo_icon_class or 'bi-geo-alt-fill')|tojson }},
      iconLabel: {{ (s.logo_label or 'Tourist Spot')|tojson }},
      img: {% if s.image_url %}{% if s.photo_source == 'external_url' %}{{ s.image_url|tojson }}{% else %}{{ url_for('static', filename='uploads/' + s.image_url)|tojson }}{% endif %}{% else %}null{% endif %}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
  ];

  const indiaBounds = L.latLngBounds(
    L.latLng(6.4627, 68.1097),
    L.latLng(37.0841, 97.3956)
  );
  const map = L.map('spotsMap', {
    maxBounds: indiaBounds,
    maxBoundsViscosity: 1.0,
    minZoom: 4
  });
  const bounds = [];
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  spots.forEach((s) => {
    const markerIcon = L.divIcon({
      className: 'spot-marker-wrap',
      html: `<div class="spot-marker-pin"><i class="bi ${s.iconClass}"></i></div>`,
      iconSize: [30, 30],
      iconAnchor: [15, 30],
      popupAnchor: [0, -28]
    });
    const marker = L.marker([s.lat, s.lng], { icon: markerIcon }).addTo(map);
    bounds.push([s.lat, s.lng]);
    const fallbackImg = {{ url_for('static', filename='uploads/demo.jpg')|tojson }};
    const imageHtml = s.img
      ? `<img src="${s.img}" alt="${s.name}" style="width:100%;height:120px;object-fit:cover;border-radius:6px;margin-bottom:8px;" onerror="this.onerror=null;this.src='${fallbackImg}';">`
      : `<div style="width:100%;height:120px;display:flex;align-items:center;justify-content:center;background:#f8fafc;border-radius:6px;margin-bottom:8px;color:#64748b;font-size:12px;">Photo Not Uploaded</div>`;
    marker.bindPopup(`
      <div style="min-width:220px">
        ${imageHtml}
        <div style="font-size:12px;color:#1d4ed8;margin-bottom:3px;"><i class="bi ${s.iconClass}"></i> ${s.iconLabel}</div>
        <div style="font-weight:600">${s.name}</div>
        <div style="font-size:12px;color:#6c757d">${s.city}, ${s.state}</div>
        ${s.details ? `<div style="font-size:12px;margin-top:4px;">${s.details}</div>` : ""}
        <a href="https://www.google.com/maps?q=${s.lat},${s.lng}" target="_blank" rel="noopener">Open in Maps</a>
      </div>
    `);
  });

  if (bounds.length === 1) {
    map.setView(bounds[0], 12);
  } else if (bounds.length > 1) {
    map.fitBounds(bounds, { padding: [30, 30] });
    map.panInsideBounds(indiaBounds, { animate: false });
  } else {
    map.fitBounds(indiaBounds, { padding: [12, 12] });
  }
})();
</script>
{% endif %}
<script>
const spotFallbackImage = {{ url_for('static', filename='uploads/demo.jpg')|tojson }};
const spotGallery = [
  {% for s in spots if s.image_url %}
  {
    name: {{ s.spot_name|tojson }},
    city: {{ s.city_name|tojson }},
    state: {{ s.state_name|tojson }},
    src: {% if s.photo_source == 'external_url' %}{{ s.image_url|tojson }}{% else %}{{ url_for('static', filename='uploads/' + s.image_url)|tojson }}{% endif %}
  }{% if not loop.last %},{% endif %}
  {% endfor %}
];

function buildSpotsPhotoCarousel(){
  const inner = document.getElementById('spotsPhotoCarouselInner');
  if(!inner || !spotGallery.length) return;
  inner.innerHTML = spotGallery.map((item, index) => `
    <div class="carousel-item${index === 0 ? ' active' : ''}">
      <img src="${item.src}" class="spot-photo-modal-img rounded" alt="${item.name}"
           onerror="this.onerror=null;this.src='${spotFallbackImage}';">
      <div class="mt-2 text-center">
        <div class="fw-semibold">${item.name}</div>
        <div class="small text-muted">${item.city}, ${item.state}</div>
      </div>
    </div>
  `).join('');
}

function updateSpotsCityFilter() {
  const stateSelect = document.getElementById('spotsStateFilter');
  const citySelect = document.getElementById('spotsCityFilter');
  if (!stateSelect || !citySelect) return;

  let stateId = stateSelect.value || '0';
  if (stateId === '0' && citySelect.value !== '0') {
    const selected = citySelect.querySelector(`option[value="${citySelect.value}"]`);
    if (selected?.dataset.stateId) {
      stateId = selected.dataset.stateId;
      stateSelect.value = stateId;
    }
  }

  const hasState = stateId !== '0';
  citySelect.querySelectorAll('option[data-state-id]').forEach((opt) => {
    const visible = hasState && opt.dataset.stateId === stateId;
    opt.hidden = !visible;
    opt.disabled = !visible;
    opt.style.display = visible ? '' : 'none';
  });
  citySelect.disabled = !hasState;
  if (!hasState) {
    citySelect.value = '0';
    return;
  }
  if (citySelect.value !== '0') {
    const selected = citySelect.querySelector(`option[value="${citySelect.value}"]`);
    if (selected && (selected.hidden || selected.disabled)) citySelect.value = '0';
  }
}

document.addEventListener('DOMContentLoaded', function () {
  const stateFilter = document.getElementById('spotsStateFilter');
  if (stateFilter) stateFilter.addEventListener('change', updateSpotsCityFilter);
  updateSpotsCityFilter();

  buildSpotsPhotoCarousel();
  const carouselEl = document.getElementById('spotsPhotoCarousel');
  if (carouselEl && typeof bootstrap !== 'undefined') {
    const carousel = bootstrap.Carousel.getOrCreateInstance(carouselEl, { interval: false, ride: false, wrap: true });
    document.querySelectorAll('.spot-photo-trigger').forEach((btn) => {
      btn.addEventListener('click', () => {
        const idx = Number(btn.dataset.galleryIndex || 0);
        carousel.to(idx);
      });
    });
  }
});
</script>
{% endblock %}
