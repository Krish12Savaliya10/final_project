{% extends "layout.html" %}

{% block title %}Explore Spots{% endblock %}
{% block extra_css %}
<style>
  body {
    background: #f2f6fb;
  }
  .card {
    border: 1px solid #dbe7f3;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 12px 28px rgba(15, 23, 42, 0.08);
  }
  .spot-logo-badge {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: #eef4ff;
    color: #1d4ed8;
    font-size: 0.95rem;
  }
  .spot-meta-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 0.75rem;
    border: 1px solid #dbeafe;
    color: #1d4ed8;
    background: #eff6ff;
    border-radius: 999px;
    padding: 2px 10px;
    margin-bottom: 8px;
  }
  .spot-marker-wrap {
    background: transparent;
    border: 0;
  }
  .spot-marker-pin {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    border: 2px solid #fff;
    background: #1d4ed8;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
  }
  .spot-photo-trigger {
    display: block;
    width: 100%;
    border: 0;
    padding: 0;
    background: transparent;
    border-radius: 0;
    overflow: hidden;
  }
  .spot-photo-trigger img {
    cursor: zoom-in;
    width: 100%;
  }
  .spot-card-img {
    height: 220px;
    object-fit: cover;
  }
  .spot-photo-placeholder {
    height: 220px;
    background: #f8fafc;
  }
  .spot-popup-wrap {
    min-width: 220px;
  }
  .spot-popup-img {
    width: 100%;
    height: 120px;
    object-fit: cover;
    border-radius: 6px;
    margin-bottom: 8px;
  }
  .spot-popup-placeholder {
    width: 100%;
    height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8fafc;
    border-radius: 6px;
    margin-bottom: 8px;
    color: #64748b;
    font-size: 12px;
  }
  .spot-popup-label {
    font-size: 12px;
    color: #1d4ed8;
    margin-bottom: 3px;
  }
  .spot-popup-city {
    font-size: 12px;
    color: #6c757d;
  }
  html[data-theme="dark"] .spot-photo-placeholder,
  html[data-theme="dark"] .spot-popup-placeholder {
    background: #0f172a;
    color: #94a3b8;
  }
  html[data-theme="dark"] .spot-popup-city {
    color: #94a3b8;
  }
  html[data-theme="dark"] .spot-meta-chip,
  html[data-theme="dark"] .spot-meta-chip *,
  html[data-theme="dark"] .spot-logo-badge,
  html[data-theme="dark"] .spot-logo-badge * {
    color: #0f172a !important;
  }
  html[data-theme="dark"] .spot-meta-chip {
    background: #e2e8f0;
    border-color: #cbd5e1;
  }
  html[data-theme="dark"] .spot-logo-badge {
    background: #e2e8f0;
  }
  #spotsPhotoCarousel .carousel-control-prev,
  #spotsPhotoCarousel .carousel-control-next {
    width: 12%;
    z-index: 8;
  }
  #spotsPhotoCarousel .carousel-control-prev-icon,
  #spotsPhotoCarousel .carousel-control-next-icon {
    width: 2.2rem;
    height: 2.2rem;
    background-size: 58% 58%;
    background-color: rgba(15, 23, 42, 0.68);
    border-radius: 50%;
    box-shadow: 0 8px 18px rgba(15, 23, 42, 0.35);
  }
  .spot-photo-modal-img {
    height: 460px;
    object-fit: cover;
    width: 100%;
  }
  @media (max-width: 575.98px) {
    #spotsPhotoCarousel .carousel-control-prev,
    #spotsPhotoCarousel .carousel-control-next {
      width: 18%;
    }
    .spot-photo-modal-img {
      height: 280px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
    <h2 class="fw-bold mb-0">Explore Tourist Spots</h2>
    <div class="text-muted small">Discover places without booking any tour</div>
  </div>

  <form method="GET" class="row g-2 mb-4">
    <div class="col-md-4">
      <input type="text" name="search" class="form-control" value="{{ search or '' }}" placeholder="Search spots, city, state">
    </div>
    <div class="col-md-3">
      <select name="state_id" id="spotsStateFilter" class="form-select">
        <option value="0">All States</option>
        {% for s in states %}
        <option value="{{ s.id }}" {% if state_id == s.id %}selected{% endif %}>{{ s.state_name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <select name="city_id" id="spotsCityFilter" class="form-select" {% if not state_id and not city_id %}disabled{% endif %}>
        <option value="0">All Cities</option>
        {% for c in cities %}
        <option value="{{ c.id }}" data-state-id="{{ c.state_id }}" {% if city_id == c.id %}selected{% endif %}>{{ c.city_name }} ({{ c.state_name }})</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2 d-grid">
      <button class="btn btn-primary">Filter</button>
    </div>
  </form>

  {% if spots %}
  {% set image_ns = namespace(idx=0) %}
  <div class="row g-3">
    {% for s in spots %}
    <div class="col-md-6 col-lg-4">
      <div class="card h-100 shadow-sm">
        {% if s.image_url %}
          {% if s.photo_source == 'external_url' %}
            {% set spot_img_src = s.image_url %}
          {% else %}
            {% set spot_img_src = url_for('static', filename='uploads/' + s.image_url) %}
          {% endif %}
          <button
            type="button"
            class="spot-photo-trigger"
            data-gallery-index="{{ image_ns.idx }}"
            data-bs-toggle="modal"
            data-bs-target="#spotsPhotoModal"
            aria-label="Open photo for {{ s.spot_name }}"
          >
            <img src="{{ spot_img_src }}" class="card-img-top spot-card-img"
                 alt="{{ s.spot_name }}">
          </button>
          {% set image_ns.idx = image_ns.idx + 1 %}
        {% else %}
          <div class="card-img-top d-flex align-items-center justify-content-center text-muted spot-photo-placeholder">
            <div class="text-center">
              <i class="bi bi-image fs-3 d-block mb-2"></i>
              <small>Photo Not Uploaded</small>
            </div>
          </div>
        {% endif %}
        <div class="card-body">
          <div class="spot-meta-chip"><i class="bi {{ s.logo_icon_class }}"></i> {{ s.logo_label }}</div>
          <h5 class="card-title d-flex align-items-center gap-2">
            <span class="spot-logo-badge"><i class="bi {{ s.logo_icon_class }}"></i></span>
            <span>{{ s.spot_name }}</span>
          </h5>
          <div class="text-muted small mb-2">{{ s.city_name }}, {{ s.state_name }}</div>
          {% if s.spot_details %}
          <p class="small mb-2">{{ s.spot_details }}</p>
          {% endif %}
          {% if s.latitude and s.longitude %}
          <div class="small text-muted">Location: {{ "%.4f"|format(s.latitude) }}, {{ "%.4f"|format(s.longitude) }}</div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% if image_ns.idx > 0 %}
  <div class="modal fade" id="spotsPhotoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Spot Photos</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="spotsPhotoCarousel" class="carousel slide" data-bs-interval="false">
            <div class="carousel-inner" id="spotsPhotoCarouselInner"></div>
            <button class="carousel-control-prev" type="button" data-bs-target="#spotsPhotoCarousel" data-bs-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#spotsPhotoCarousel" data-bs-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Next</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  {% else %}
  <div class="alert alert-warning">No spots found for this filter.</div>
  {% endif %}
</div>

<script>

function buildSpotsPhotoCarousel(){
  const inner = document.getElementById('spotsPhotoCarouselInner');
  if(!inner || !spotGallery.length) return;
  inner.innerHTML = spotGallery.map((item, index) => `
    <div class="carousel-item${index === 0 ? ' active' : ''}">
      <img src="${item.src}" class="spot-photo-modal-img rounded" alt="${item.name}"
           onerror="this.onerror=null;this.src='${spotFallbackImage}';">
      <div class="mt-2 text-center">
        <div class="fw-semibold">${item.name}</div>
        <div class="small text-muted">${item.city}, ${item.state}</div>
      </div>
    </div>
  `).join('');
}

function updateSpotsCityFilter() {
  const stateSelect = document.getElementById('spotsStateFilter');
  const citySelect = document.getElementById('spotsCityFilter');
  if (!stateSelect || !citySelect) return;

  let stateId = stateSelect.value || '0';
  if (stateId === '0' && citySelect.value !== '0') {
    const selected = citySelect.querySelector(`option[value="${citySelect.value}"]`);
    if (selected?.dataset.stateId) {
      stateId = selected.dataset.stateId;
      stateSelect.value = stateId;
    }
  }

  const hasState = stateId !== '0';
  citySelect.querySelectorAll('option[data-state-id]').forEach((opt) => {
    const visible = hasState && opt.dataset.stateId === stateId;
    opt.hidden = !visible;
    opt.disabled = !visible;
    opt.style.display = visible ? '' : 'none';
  });
  citySelect.disabled = !hasState;
  if (!hasState) {
    citySelect.value = '0';
    return;
  }
  if (citySelect.value !== '0') {
    const selected = citySelect.querySelector(`option[value="${citySelect.value}"]`);
    if (selected && (selected.hidden || selected.disabled)) citySelect.value = '0';
  }
}

document.addEventListener('DOMContentLoaded', function () {
  const stateFilter = document.getElementById('spotsStateFilter');
  if (stateFilter) stateFilter.addEventListener('change', updateSpotsCityFilter);
  updateSpotsCityFilter();

  buildSpotsPhotoCarousel();
  const carouselEl = document.getElementById('spotsPhotoCarousel');
  if (carouselEl && typeof bootstrap !== 'undefined') {
    const carousel = bootstrap.Carousel.getOrCreateInstance(carouselEl, { interval: false, ride: false, wrap: true });
    document.querySelectorAll('.spot-photo-trigger').forEach((btn) => {
      btn.addEventListener('click', () => {
        const idx = Number(btn.dataset.galleryIndex || 0);
        carousel.to(idx);
      });
    });
  }
});
</script>
{% endblock %}
