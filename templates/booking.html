<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TourGen | Join Trip</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

<style>
body{
    background:#f1f5f9;
    font-family:'Segoe UI',system-ui,sans-serif;
    padding-top:80px;
}

/* NAVBAR */
.custom-navbar{
    background:rgba(15,23,42,0.85);
    backdrop-filter:blur(12px);
}
.brand-logo{font-weight:700;font-size:24px;color:white !important;}
.nav-link{color:#e2e8f0 !important;margin-left:18px;}
.nav-link:hover{color:#60a5fa !important;}
.user-badge{margin-left:15px;background:rgba(255,255,255,.15);padding:6px 14px;border-radius:50px;color:white;}
.btn-login{background:#2563eb;border-radius:40px;padding:7px 18px;margin-left:15px;color:white;}
.btn-logout{background:#ef4444;border-radius:40px;padding:7px 18px;margin-left:10px;color:white;}

/* HERO */
.hero{height:460px;position:relative;overflow:hidden;}
.hero img{width:100%;height:100%;object-fit:cover;}
.hero::after{content:"";position:absolute;inset:0;background:linear-gradient(to bottom, rgba(0,0,0,.25), rgba(0,0,0,.65));}
.hero-content{position:absolute;bottom:50px;left:60px;color:white;z-index:2;}
.hero-title{font-size:44px;font-weight:800;}
.hero-meta span{background:rgba(255,255,255,.15);padding:8px 14px;border-radius:40px;margin-right:10px;font-size:14px;}

/* SECTION CARD */
.section-card{background:white;padding:30px;border-radius:18px;box-shadow:0 12px 30px rgba(0,0,0,.08);}

/* TIMELINE */
.timeline{position:relative;padding-left:55px;max-height:420px;overflow-y:auto;padding-right:10px;}
.timeline::before{content:"";position:absolute;left:25px;top:0;bottom:0;width:3px;background:#3b82f6;}
.timeline-item{padding:16px 18px;border-radius:12px;cursor:pointer;transition:.25s;margin-bottom:18px;border:1px solid transparent;}
.timeline-item:hover{background:#f1f5f9;border-color:#3b82f6;transform:translateX(5px);}
.timeline-dot{position:absolute;left:-5px;margin-top:18px;width:20px;height:20px;background:#2563eb;border-radius:50%;border:4px solid white;}

/* SLIDESHOW */
.slideshow{height:420px;border-radius:18px;overflow:hidden;box-shadow:0 10px 25px rgba(0,0,0,.15);}
.slideshow img{width:100%;height:100%;object-fit:cover;transition:.35s ease;}

/* PAYMENT */
.payment-card{background:white;border-radius:20px;padding:35px;box-shadow:0 20px 50px rgba(0,0,0,.12);text-align:center;}
.total{font-size:36px;font-weight:800;color:#2563eb;}
.pay-btn{margin-top:20px;background:#2563eb;border:none;padding:16px;border-radius:50px;font-size:18px;font-weight:700;width:100%;}
.pay-btn:hover{background:#1d4ed8;}
</style>
</head>

<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark fixed-top custom-navbar">
<div class="container">
<a class="navbar-brand brand-logo" href="{{ url_for('home') }}">
<i class="bi bi-compass"></i> TourGen
</a>

<div class="collapse navbar-collapse">
<ul class="navbar-nav ms-auto align-items-center">
<li class="nav-item"><a class="nav-link" href="{{ url_for('home') }}">Home</a></li>
<li class="nav-item"><a class="nav-link" href="{{ url_for('tour') }}">Tours</a></li>

{% if session.get('user_id') %}
<li class="nav-item"><a class="nav-link" href="{{ url_for('mybookings') }}">My Bookings</a></li>
<li class="nav-item"><span class="user-badge">{{ session.username }}</span></li>
<li class="nav-item"><a class="btn btn-logout" href="{{ url_for('logout') }}">Logout</a></li>
{% else %}
<li class="nav-item"><a class="btn btn-login" href="{{ url_for('login') }}">Login</a></li>
{% endif %}
</ul>
</div>
</div>
</nav>

<!-- HERO -->
<div class="hero">
<img src="{{ url_for('static', filename='uploads/' + (tour.image_path or 'demo.jpg')) }}">
<div class="hero-content">
<div class="hero-title">{{ tour.title }}</div>
<div class="hero-meta mt-2">
<span><i class="bi bi-calendar-event"></i> {{ tour.start_date }}</span>
<span><i class="bi bi-geo-alt"></i> {{ tour.start_point }} → {{ tour.end_point }}</span>
</div>
</div>
</div>

<!-- ===== CONFIRMED BOOKING PANEL ===== -->
{% if readonly %}
<div class="container mt-4">
<div class="section-card border border-success">
<h3 class="fw-bold text-success">
<i class="bi bi-check-circle-fill"></i> Booking Confirmed
</h3>

<div class="row mt-3">
<div class="col-md-6">
<p><b>Passenger:</b> {{ session.username }}</p>
<p><b>Tour:</b> {{ tour.title }}</p>
<p><b>Departure:</b> {{ tour.start_date }}</p>
</div>
<div class="col-md-6">
<p><b>Status:</b> Confirmed</p>
<p><b>Booking ID:</b> {{ booking_id }}</p>
</div>
</div>

<div class="text-end">
<a href="{{ url_for('invoice', booking_id=booking_id) }}" class="btn btn-dark rounded-pill">
<i class="bi bi-download"></i> Download Ticket
</a>
</div>
</div>
</div>
{% endif %}

<div class="container my-5">

<!-- ABOUT -->
<div class="section-card mb-5">
<h3 class="fw-bold mb-3">About This Tour</h3>
<p class="text-muted">{{ tour.description }}</p>
</div>

<!-- ROADMAP -->
<div class="section-card mb-5">
<h3 class="fw-bold mb-4">Travel Roadmap</h3>

<div class="row">

<div class="col-lg-6">
<div class="timeline">
{% for item in itinerary %}
<div class="timeline-item"
     data-img="{{ url_for('static', filename='uploads/' ~ item.image_url) }}"
     onclick="showSlide(this)">
<div class="timeline-dot"></div>
<span class="badge bg-primary mb-1">Day {{ item.day_number }}</span>
<h6 class="fw-bold">{{ item.spot_name }}</h6>
</div>
{% endfor %}
</div>
</div>

<div class="col-lg-6">
<div class="slideshow">
<img id="slideImage"
src="{{ url_for('static', filename='uploads/' ~ itinerary[0].image_url) if itinerary else url_for('static', filename='uploads/demo.jpg') }}">
</div>
</div>

</div>
</div>

<!-- CUSTOMIZE + PAYMENT ONLY BEFORE BOOKING -->
{% if not readonly %}
<div class="section-card mb-5">
<h3 class="fw-bold mb-4">Customize Your Trip</h3>

<label class="fw-bold small">Number of People</label>
<input type="number" id="people" class="form-control mb-3" value="1" min="1" oninput="calculateTotal()">
</div>

<div class="payment-card mb-5">
<h4 class="fw-bold">Trip Total</h4>
<div class="total">₹<span id="totalPrice">0</span></div>

<form method="POST">
<input type="hidden" name="final_amount" id="finalAmountInput">
<button class="pay-btn">Proceed to Payment</button>
</form>
</div>
{% else %}
<div class="text-center text-success fw-bold mb-5">
<i class="bi bi-check-circle-fill"></i>
This trip is already booked. Enjoy your itinerary above!
</div>
{% endif %}

</div>

<div id="tour-data" data-price="{{ tour.price | default(0) }}"></div>

<script>
const basePrice = Number(document.getElementById('tour-data').dataset.price);

function calculateTotal(){
let people=document.getElementById("people").value||1;
let total=(Number(basePrice))*Number(people);
document.getElementById("totalPrice").textContent=total.toLocaleString();
document.getElementById("finalAmountInput").value=total;
}
calculateTotal();

function showSlide(el){
const src = el.dataset.img;
const img = document.getElementById("slideImage");
img.style.opacity=0;
setTimeout(()=>{img.src=src;img.style.opacity=1;},150);
}
</script>

</body>
</html>