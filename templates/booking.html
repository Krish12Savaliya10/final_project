<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TourGen | Join Trip</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/booking.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
</head>

<body>

<nav class="navbar navbar-expand-lg navbar-dark fixed-top custom-navbar">
<div class="container">
<a class="navbar-brand brand-logo" href="{{ url_for('home') }}">
<i class="bi bi-compass"></i> TourGen
</a>

<div class="collapse navbar-collapse">
<ul class="navbar-nav ms-auto align-items-center">
<li class="nav-item me-2">
<button class="btn btn-outline-light btn-sm rounded-pill" type="button" data-theme-toggle>
<i class="bi bi-moon-stars"></i> <span data-theme-label>Dark Mode</span>
</button>
</li>
<li class="nav-item"><a class="nav-link" href="{{ url_for('home') }}">Home</a></li>
<li class="nav-item"><a class="nav-link" href="{{ url_for('tour') }}">Tours</a></li>

{% if session.get('user_id') %}
<li class="nav-item"><a class="nav-link" href="{{ url_for('mybookings') }}">My Bookings</a></li>
<li class="nav-item"><span class="user-badge">{{ session.username }}</span></li>
<li class="nav-item"><a class="btn btn-logout" href="{{ url_for('logout') }}">Logout</a></li>
{% else %}
<li class="nav-item"><a class="btn btn-login" href="{{ url_for('login') }}">Login</a></li>
{% endif %}
</ul>
</div>
</div>
</nav>

<div class="hero">
<img src="{{ url_for('static', filename='uploads/' + (tour.image_path or 'demo.jpg')) }}">
<div class="hero-content">
<div class="hero-title">{{ tour.title }}</div>
<div class="hero-meta mt-2">
<span><i class="bi bi-calendar-event"></i> {{ tour.start_date }}</span>
<span><i class="bi bi-geo-alt"></i> {{ tour.start_point }} → {{ tour.end_point }}</span>
</div>
</div>
</div>

{% if readonly %}
<div class="container mt-4">
<div class="section-card border border-success">
<h3 class="fw-bold text-success">
<i class="bi bi-check-circle-fill"></i> Booking Confirmed
</h3>

<div class="row mt-3">
<div class="col-md-6">
<p><b>Passenger:</b> {{ session.username }}</p>
<p><b>Tour:</b> {{ tour.title }}</p>
<p><b>Departure:</b> {{ tour.start_date }}</p>
</div>
<div class="col-md-6">
<p><b>Status:</b> Confirmed</p>
<p><b>Booking ID:</b> {{ booking_id }}</p>
</div>
</div>

<div class="text-end">
<i class="bi bi-download"></i> Download Ticket
</a>
</div>
</div>
</div>
{% endif %}

<div class="container my-5">

<div class="section-card mb-5">
<h3 class="fw-bold mb-3">About This Tour</h3>
<p class="text-muted">{{ tour.description }}</p>
</div>

<div class="section-card mb-5">
<h3 class="fw-bold mb-4">Trip Essentials</h3>
<div class="row g-3">
<div class="col-md-4">
<div class="meta-box"><small class="text-muted d-block">Travel Mode</small><strong>{{ tour.travel_mode or 'Will be shared by organizer' }}</strong></div>
</div>
<div class="col-md-4">
<div class="meta-box"><small class="text-muted d-block">Food Plan</small><strong>{{ tour.food_plan or 'Custom / Optional' }}</strong></div>
</div>
<div class="col-md-4">
<div class="meta-box"><small class="text-muted d-block">Group Size</small><strong>{% if tour.max_group_size %}Up to {{ tour.max_group_size }}{% else %}Flexible{% endif %}</strong></div>
</div>
<div class="col-md-6">
<div class="meta-box"><small class="text-muted d-block">Pickup</small><strong>{{ tour.pickup_city_name or tour.start_point }}{% if tour.pickup_state_name %}, {{ tour.pickup_state_name }}{% endif %}</strong></div>
</div>
<div class="col-md-6">
<div class="meta-box"><small class="text-muted d-block">Drop</small><strong>{{ tour.drop_city_name or tour.end_point }}{% if tour.drop_state_name %}, {{ tour.drop_state_name }}{% endif %}</strong></div>
</div>
</div>
{% if tour.transport_details %}
<p class="mt-3 mb-0"><span class="fw-semibold">Transport:</span> {{ tour.transport_details }}</p>
{% endif %}
</div>

{% if linked_hotels %}
<div class="section-card mb-5">
<h3 class="fw-bold mb-4">Stay Options From Our Platform</h3>
<div class="row g-3">
{% for h in linked_hotels %}
<div class="col-md-6">
<div class="hotel-mini-card">
<h6 class="fw-bold mb-1">{{ h.hotel_name }}</h6>
<p class="small text-muted mb-1">{{ h.city_name or '' }}{% if h.state_name %}, {{ h.state_name }}{% endif %}</p>
<div class="d-flex justify-content-between align-items-center">
<span class="small">Star Rating: {{ h.star_rating or 0 }}★</span>
<span class="fw-semibold">From ₹{{ h.from_price }}</span>
</div>
</div>
</div>
{% endfor %}
</div>
</div>
{% endif %}

{% if linked_transports %}
<div class="section-card mb-5">
<h3 class="fw-bold mb-4">Transport Options For This Tour</h3>
<div class="row g-3">
{% for tr in linked_transports %}
<div class="col-md-6">
<div class="hotel-mini-card">
<h6 class="fw-bold mb-1">{{ tr.service_name }}</h6>
<p class="small text-muted mb-1">{{ tr.transport_type }}{% if tr.vehicle_model %} - {{ tr.vehicle_model }}{% endif %}</p>
<p class="small text-muted mb-1">{{ tr.city_name or '' }}{% if tr.state_name %}, {{ tr.state_name }}{% endif %}</p>
<div class="d-flex justify-content-between align-items-center">
<span class="small">{% if tr.seating_capacity %}{{ tr.seating_capacity }} seats{% endif %}{% if tr.driver_available %} • Driver Included{% endif %}</span>
<span class="fw-semibold">₹{{ tr.price_per_day or 0 }}/day</span>
</div>
{% if tr.price_per_km %}
<div class="small mt-1">₹{{ tr.price_per_km }}/km</div>
{% endif %}
</div>
</div>
{% endfor %}
</div>
</div>
{% endif %}

{% if linked_guides %}
<div class="section-card mb-5">
<h3 class="fw-bold mb-4">Guide Options</h3>
<div class="row g-3">
{% for g in linked_guides %}
<div class="col-md-6">
<div class="hotel-mini-card">
<h6 class="fw-bold mb-1">{{ g.service_name }}</h6>
<p class="small text-muted mb-1">{{ g.city_name or '' }}{% if g.state_name %}, {{ g.state_name }}{% endif %}</p>
{% if g.description %}
<p class="small mb-2">{{ g.description }}</p>
{% endif %}
<span class="fw-semibold">From ₹{{ g.price }}</span>
</div>
</div>
{% endfor %}
</div>
</div>
{% endif %}

{% if tour.inclusions or tour.exclusions or tour.hotel_notes %}
<div class="section-card mb-5">
<h3 class="fw-bold mb-4">What Is Included</h3>
{% if tour.inclusions %}
<p class="mb-2"><span class="fw-semibold">Inclusions:</span> {{ tour.inclusions }}</p>
{% endif %}
{% if tour.exclusions %}
<p class="mb-2"><span class="fw-semibold">Exclusions:</span> {{ tour.exclusions }}</p>
{% endif %}
{% if tour.hotel_notes %}
<p class="mb-0"><span class="fw-semibold">Hotel Notes:</span> {{ tour.hotel_notes }}</p>
{% endif %}
</div>
{% endif %}

<div class="section-card mb-5">
<h3 class="fw-bold mb-4">Travel Roadmap</h3>

<div class="row">

<div class="col-lg-6">
<div class="timeline">
{% for item in itinerary %}
<div class="timeline-item"
     data-img="{{ url_for('static', filename='uploads/' ~ item.image_url) }}"
     onclick="showSlide(this)">
<div class="timeline-dot"></div>
<span class="badge bg-primary mb-1">Day {{ item.day_number }}</span>
<h6 class="fw-bold">{{ item.spot_name }}</h6>
</div>
{% endfor %}
</div>
</div>

<div class="col-lg-6">
<div class="slideshow">
<img id="slideImage"
src="{{ url_for('static', filename='uploads/' ~ itinerary[0].image_url) if itinerary else url_for('static', filename='uploads/demo.jpg') }}">
</div>
</div>

</div>
</div>

{% if not readonly %}
<div class="section-card mb-5">
<h3 class="fw-bold mb-4">Customize Your Trip</h3>

<label class="fw-bold small">Number of People</label>
<input type="number" id="people" class="form-control mb-3" value="1" min="1" oninput="calculateTotal()">
</div>

<div class="payment-card mb-5">
<h4 class="fw-bold">Trip Total</h4>
<div class="total">₹<span id="totalPrice">0</span></div>

<form method="POST">
{% if linked_guides %}
<div class="form-check text-start mt-3">
<input class="form-check-input" type="checkbox" id="needGuide" name="need_individual_guide" value="1">
<label class="form-check-label" for="needGuide">Need individual guide support</label>
</div>
<select name="guide_service_id" class="form-select mt-2">
<option value="">Select preferred guide (optional)</option>
{% for g in linked_guides %}
<option value="{{ g.service_id }}">{{ g.service_name }} - ₹{{ g.price }}</option>
{% endfor %}
</select>
<input type="text" name="guide_note" class="form-control mt-2" placeholder="Guide language or special request (optional)">
{% endif %}
<input type="hidden" name="final_amount" id="finalAmountInput">
<button class="pay-btn">Proceed to Payment</button>
</form>
</div>
{% else %}
<div class="text-center text-success fw-bold mb-5">
<i class="bi bi-check-circle-fill"></i>
This trip is already booked. Enjoy your itinerary above!
</div>
{% endif %}

</div>

<div id="tour-data" data-price="{{ tour.price | default(0) }}"></div>

<script>
const basePrice = Number(document.getElementById('tour-data').dataset.price);

function calculateTotal(){
let people=document.getElementById("people").value||1;
let total=(Number(basePrice))*Number(people);
document.getElementById("totalPrice").textContent=total.toLocaleString();
document.getElementById("finalAmountInput").value=total;
}
calculateTotal();

function showSlide(el){
const src = el.dataset.img;
const img = document.getElementById("slideImage");
img.style.opacity=0;
setTimeout(()=>{img.src=src;img.style.opacity=1;},150);
}
</script>
<script src="{{ url_for('static', filename='js/theme.js') }}"></script>

</body>
</html>
