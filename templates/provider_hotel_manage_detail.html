{% extends "layout.html" %}
{% block title %}Manage Hotel{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/provider_dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/role_dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/provider_hotels_management.css') }}">
{% endblock %}

{% block content %}
{% set provider_sidebar_active = 'manage_hotel_detail' %}
<div class="container mt-5 pb-5 dashboard-shell dashboard-page provider-dashboard-page">
  <div class="provider-shell">
    {% include "provider_sidebar.html" %}
    <main class="provider-main">
      {% set status = (hotel.listing_status or 'active') %}
      <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2 provider-header">
        <div>
          <h2 class="fw-bold mb-0">{{ hotel.hotel_name or 'Manage Hotel' }}</h2>
          <span class="badge status-badge text-capitalize status-{{ status }} mt-2">{{ status }}</span>
        </div>
        <div class="d-flex flex-wrap gap-2">
          <a href="{{ url_for('provider_hotels_management') }}" class="btn btn-outline-primary btn-sm rounded-pill">Back to Hotels</a>
          <a href="{{ url_for('hotel_detail', service_id=hotel.service_id) }}" class="btn btn-outline-secondary btn-sm rounded-pill">Public View</a>
        </div>
      </div>

      {% with messages = get_flashed_messages() %}
      {% if messages %}
      <div class="alert alert-info border-0 shadow-sm">{{ messages[0] }}</div>
      {% endif %}
      {% endwith %}

      <div class="card panel-card mb-4">
        <div class="card-body">
          <h5 class="fw-bold mb-3">View Details</h5>
          <ul class="list-group list-group-flush simple-detail-list">
            <li class="list-group-item"><strong>Hotel Name:</strong> {{ hotel.hotel_name or '-' }}</li>
            <li class="list-group-item"><strong>Brand:</strong> {{ hotel.brand_name or '-' }}</li>
            <li class="list-group-item"><strong>Star Rating:</strong> {{ hotel.star_rating or 0 }}★</li>
            <li class="list-group-item"><strong>Location:</strong> {{ hotel.city_name or '-' }}, {{ hotel.state_name or '-' }}</li>
            <li class="list-group-item"><strong>Address:</strong> {{ hotel.address_line1 or '-' }}</li>
            <li class="list-group-item"><strong>Locality:</strong> {{ hotel.locality or '-' }}</li>
            <li class="list-group-item"><strong>Owner:</strong> {{ hotel.owner_name or '-' }}</li>
            <li class="list-group-item"><strong>Contact:</strong> {{ hotel.hotel_contact_phone or '-' }}{% if hotel.hotel_contact_email %} | {{ hotel.hotel_contact_email }}{% endif %}</li>
            <li class="list-group-item"><strong>Starting Price:</strong> ₹{{ hotel.price or 0 }}</li>
            <li class="list-group-item"><strong>Amenities:</strong> {{ selected_amenity_names|join(', ') if selected_amenity_names else '-' }}</li>
            <li class="list-group-item"><strong>Description:</strong> {{ hotel.hotel_description or '-' }}</li>
            <li class="list-group-item"><strong>House Rules:</strong> {{ hotel.house_rules or '-' }}</li>
            <li class="list-group-item"><strong>Terms:</strong> {{ hotel.terms_conditions or '-' }}</li>
          </ul>
        </div>
      </div>

      <div class="card panel-card mb-4">
        <div class="card-body">
          <h5 class="fw-bold mb-3">Hotel Photos</h5>
          <form method="POST" enctype="multipart/form-data" class="row g-2 align-items-end mb-3">
            <input type="hidden" name="action" value="add_photos">
            <div class="col-md-9">
              <label class="form-label">Add Photos</label>
              <input type="file" name="hotel_photos" class="form-control" accept=".jpg,.jpeg,.png,.webp" multiple required>
            </div>
            <div class="col-md-3">
              <button class="btn btn-primary w-100">Upload Photos</button>
            </div>
          </form>

          {% if hotel_images %}
          <div class="row g-3">
            {% for img in hotel_images %}
            {% set image_src = img.image_url if img.image_url and (img.image_url.startswith('http://') or img.image_url.startswith('https://')) else url_for('static', filename='uploads/' + (img.image_url or 'demo.jpg')) %}
            <div class="col-md-4 col-lg-3">
              <div class="border rounded p-2 h-100">
                <img src="{{ image_src }}" alt="Hotel photo" class="hotel-detail-photo">
                <div class="d-flex justify-content-between align-items-center mt-2">
                  {% if img.is_cover %}
                  <span class="badge bg-success">Cover</span>
                  {% else %}
                  <span class="badge bg-light text-dark border">Photo</span>
                  {% endif %}
                </div>
                <div class="d-flex gap-2 mt-2">
                  {% if not img.is_cover %}
                  <form method="POST" class="flex-fill">
                    <input type="hidden" name="action" value="set_cover_photo">
                    <input type="hidden" name="image_id" value="{{ img.id }}">
                    <button class="btn btn-sm btn-outline-primary w-100">Set Cover</button>
                  </form>
                  {% endif %}
                  <form method="POST" class="flex-fill">
                    <input type="hidden" name="action" value="delete_photo">
                    <input type="hidden" name="image_id" value="{{ img.id }}">
                    <button class="btn btn-sm btn-outline-danger w-100">Delete</button>
                  </form>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="alert alert-light border mb-0">No photos uploaded yet.</div>
          {% endif %}
        </div>
      </div>

      <div class="card panel-card mb-4">
        <div class="card-body">
          <h5 class="fw-bold mb-3">Edit Hotel</h5>
          <form method="POST" enctype="multipart/form-data">
            <input type="hidden" name="action" value="update_hotel">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Hotel Name</label>
                <input type="text" name="hotel_name" class="form-control" value="{{ hotel.hotel_name or '' }}" required>
              </div>
              <div class="col-md-3">
                <label class="form-label">Brand Name</label>
                <input type="text" name="brand_name" class="form-control" value="{{ hotel.brand_name or '' }}">
              </div>
              <div class="col-md-3">
                <label class="form-label">Star Rating</label>
                <select name="star_rating" class="form-select">
                  {% for value in [0,1,2,3,4,5] %}
                  <option value="{{ value }}" {% if (hotel.star_rating or 0)|int == value %}selected{% endif %}>{{ value }} Star</option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-3">
                <label class="form-label">State</label>
                <select class="form-select js-state-filter" data-city-target="hotelCitySelect" required>
                  <option value="">Select state</option>
                  {% for s in states %}
                  <option value="{{ s.id }}" {% if hotel.city_state_id and hotel.city_state_id == s.id %}selected{% endif %}>{{ s.state_name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">City</label>
                <select name="city_id" id="hotelCitySelect" class="form-select" required>
                  <option value="">Select city</option>
                  {% for c in cities %}
                  <option value="{{ c.id }}" data-state-id="{{ c.state_id }}" {% if c.id == hotel.city_id %}selected{% endif %}>{{ c.city_name }} ({{ c.state_name }})</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Starting Price</label>
                <input type="number" step="0.01" name="base_price" class="form-control" value="{{ hotel.price or 0 }}" required>
              </div>
              <div class="col-md-3">
                <label class="form-label">Hotel Status</label>
                <select name="listing_status" class="form-select">
                  <option value="active" {% if status == 'active' %}selected{% endif %}>Active</option>
                  <option value="inactive" {% if status == 'inactive' %}selected{% endif %}>Inactive</option>
                  <option value="maintenance" {% if status == 'maintenance' %}selected{% endif %}>Maintenance</option>
                </select>
              </div>

              <div class="col-md-6">
                <label class="form-label">Address</label>
                <input type="text" name="address_line1" class="form-control" value="{{ hotel.address_line1 or '' }}" required>
              </div>
              <div class="col-md-3">
                <label class="form-label">Locality</label>
                <input type="text" name="locality" class="form-control" value="{{ hotel.locality or '' }}">
              </div>
              <div class="col-md-3">
                <label class="form-label">Pincode</label>
                <input type="text" name="pincode" class="form-control" value="{{ hotel.pincode or '' }}" maxlength="6">
              </div>

              <div class="col-md-4">
                <label class="form-label">Owner Name</label>
                <input type="text" name="owner_name" class="form-control" value="{{ hotel.owner_name or '' }}" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Hotel Contact Phone</label>
                <input type="text" name="hotel_contact_phone" class="form-control" value="{{ hotel.hotel_contact_phone or '' }}" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Hotel Contact Email</label>
                <input type="email" name="hotel_contact_email" class="form-control" value="{{ hotel.hotel_contact_email or '' }}">
              </div>

              <div class="col-12">
                <label class="form-label">Amenities</label>
                <div class="row g-2 border rounded p-2 bg-body-tertiary">
                  {% for a in amenities %}
                  <div class="col-md-4 col-sm-6">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="amenity_ids" value="{{ a.id }}" id="amenity{{ a.id }}" {% if a.id in selected_amenity_ids %}checked{% endif %}>
                      <label class="form-check-label" for="amenity{{ a.id }}">{{ a.amenity_name }}</label>
                    </div>
                  </div>
                  {% endfor %}
                </div>
              </div>

              <div class="col-12">
                <label class="form-label">Hotel Description</label>
                <textarea name="hotel_description" rows="3" class="form-control">{{ hotel.hotel_description or '' }}</textarea>
              </div>
              <div class="col-md-6">
                <label class="form-label">House Rules</label>
                <textarea name="house_rules" rows="2" class="form-control">{{ hotel.house_rules or '' }}</textarea>
              </div>
              <div class="col-md-6">
                <label class="form-label">Terms & Conditions</label>
                <textarea name="terms_conditions" rows="2" class="form-control">{{ hotel.terms_conditions or '' }}</textarea>
              </div>

              <div class="col-12">
                <div class="d-flex flex-wrap gap-3">
                  <div class="form-check"><input class="form-check-input" type="checkbox" name="couple_friendly" id="cf" {% if hotel.couple_friendly %}checked{% endif %}><label class="form-check-label" for="cf">Couple Friendly</label></div>
                  <div class="form-check"><input class="form-check-input" type="checkbox" name="pets_allowed" id="pa" {% if hotel.pets_allowed %}checked{% endif %}><label class="form-check-label" for="pa">Pets Allowed</label></div>
                  <div class="form-check"><input class="form-check-input" type="checkbox" name="parking_available" id="pk" {% if hotel.parking_available %}checked{% endif %}><label class="form-check-label" for="pk">Parking</label></div>
                  <div class="form-check"><input class="form-check-input" type="checkbox" name="breakfast_available" id="bf" {% if hotel.breakfast_available %}checked{% endif %}><label class="form-check-label" for="bf">Breakfast</label></div>
                </div>
              </div>

              <div class="col-12">
                <button class="btn btn-primary rounded-pill px-4">Save Hotel Changes</button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <div class="card panel-card">
        <div class="card-body">
          <h5 class="fw-bold mb-3">Room Inventory</h5>
          {% if room_types %}
          <div class="table-responsive">
            <table class="table table-striped align-middle mb-0">
              <thead>
                <tr><th>Room Type</th><th>Price</th><th>Total Rooms</th><th>Available</th></tr>
              </thead>
              <tbody>
                {% for rt in room_types %}
                <tr>
                  <td>{{ rt.room_type_name }}</td>
                  <td>₹{{ rt.base_price }}</td>
                  <td>{{ rt.total_rooms }}</td>
                  <td>{{ rt.available_rooms }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="alert alert-light border mb-0">No room types added yet.</div>
          {% endif %}
        </div>
      </div>
    </main>
  </div>
</div>

<script>
  (function () {
    function syncCityOptions(stateSelect) {
      const citySelect = document.getElementById(stateSelect.dataset.cityTarget || "");
      if (!citySelect) return;
      const stateId = (stateSelect.value || "").trim();
      citySelect.querySelectorAll("option[data-state-id]").forEach((opt) => {
        const visible = !!stateId && String(opt.dataset.stateId) === String(stateId);
        opt.hidden = !visible;
        opt.disabled = !visible;
        opt.style.display = visible ? "" : "none";
      });
      if (!stateId) {
        citySelect.value = "";
        citySelect.disabled = true;
        return;
      }
      citySelect.disabled = false;
      const selected = citySelect.options[citySelect.selectedIndex];
      if (selected && selected.value && (selected.disabled || String(selected.dataset.stateId || "") !== stateId)) {
        citySelect.value = "";
      }
    }

    document.querySelectorAll(".js-state-filter[data-city-target]").forEach((stateSelect) => {
      stateSelect.addEventListener("change", () => syncCityOptions(stateSelect));
      syncCityOptions(stateSelect);
    });
  })();
</script>
{% endblock %}
