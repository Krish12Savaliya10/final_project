{% extends "layout.html" %}
{% block title %}Provider Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/provider_dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/role_dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="container mt-5 pb-5 dashboard-shell dashboard-page provider-dashboard-page">
  {% set role = session.get('role') %}
  {% set provider_sidebar_active = 'dashboard' %}
  <div class="provider-shell">
    {% include "provider_sidebar.html" %}
    <main class="provider-main">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2 provider-header">
    <div class="d-flex flex-wrap align-items-center gap-2 provider-header-title">
      <h2 class="fw-bold mb-0">Hotel & Services Dashboard</h2>
      <a href="{{ url_for('provider_add_hotel') }}" class="btn btn-primary btn-sm rounded-pill">Add Hotel</a>
      <a href="{{ url_for('provider_hotels_management') }}" class="btn btn-outline-primary btn-sm rounded-pill">Manage All Hotels</a>
    </div>
    {% if profile and profile.provider_category %}
      <span class="badge badge-soft">Category: {{ profile.provider_category }}</span>
    {% endif %}
  </div>

  {% with messages = get_flashed_messages() %}
  {% if messages %}
  <div class="alert alert-info border-0 shadow-sm">{{ messages[0] }}</div>
  {% endif %}
  {% endwith %}

  <div class="card panel-card mb-4">
    <div class="card-body d-flex flex-wrap justify-content-between align-items-center gap-3">
      <div>
        <h5 class="fw-bold mb-1">Hotel Owner Pages</h5>
        <div class="text-muted small">Use dedicated pages to add new hotels and manage all existing hotels.</div>
      </div>
      <div class="d-flex flex-wrap gap-2">
        <a href="{{ url_for('provider_add_hotel') }}" class="btn btn-primary rounded-pill">Open Add Hotel</a>
        <a href="{{ url_for('provider_hotels_management') }}" class="btn btn-outline-primary rounded-pill">Open Manage Hotel</a>
      </div>
    </div>
  </div>

  <div class="card panel-card mb-4">
    <div class="card-body">
      <h5 class="fw-bold mb-3">Add Room Type</h5>
      <form method="POST">
        <input type="hidden" name="action" value="add_room_type">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Hotel</label>
            <select name="service_id" class="form-select" required>
              <option value="">Select hotel</option>
              {% for h in hotel_services %}
              <option value="{{ h.id }}">{{ h.hotel_name }} ({{ h.city_name or '-' }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Room Type</label>
            <input type="text" name="room_type_name" class="form-control" placeholder="Deluxe Room" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Bed Type</label>
            <input type="text" name="bed_type" class="form-control" placeholder="King / Queen / Twin">
          </div>

          <div class="col-md-2">
            <label class="form-label">Room Size (sqft)</label>
            <input type="number" name="room_size_sqft" class="form-control">
          </div>
          <div class="col-md-2">
            <label class="form-label">Max Guests</label>
            <input type="number" name="max_guests" class="form-control" value="2">
          </div>
          <div class="col-md-2">
            <label class="form-label">Total Rooms</label>
            <input type="number" name="total_rooms" class="form-control" value="10">
          </div>
          <div class="col-md-2">
            <label class="form-label">Available Rooms</label>
            <input type="number" name="available_rooms" class="form-control" value="10">
          </div>
          <div class="col-md-2">
            <label class="form-label">Base Price</label>
            <input type="number" step="0.01" name="room_base_price" class="form-control" required>
          </div>
          <div class="col-md-2">
            <label class="form-label">Strike Price</label>
            <input type="number" step="0.01" name="strike_price" class="form-control">
          </div>

          <div class="col-md-3">
            <label class="form-label">Tax %</label>
            <input type="number" step="0.01" name="tax_percent" class="form-control" value="0">
          </div>
          <div class="col-md-9 d-flex flex-wrap align-items-end gap-3">
            <div class="form-check"><input class="form-check-input" type="checkbox" name="breakfast_included" id="rbf"><label class="form-check-label" for="rbf">Breakfast Included</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" name="ac_available" id="rac" checked><label class="form-check-label" for="rac">AC</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" name="wifi_available" id="rwi" checked><label class="form-check-label" for="rwi">WiFi</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" name="refundable" id="rrf"><label class="form-check-label" for="rrf">Refundable</label></div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Cancellation Policy</label>
            <input type="text" name="cancellation_policy" class="form-control" placeholder="Free cancellation till 24 hrs">
          </div>
          <div class="col-md-6">
            <label class="form-label">Room Description</label>
            <input type="text" name="room_description" class="form-control">
          </div>

          <div class="col-12">
            <button class="btn btn-success">Add Room Type</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="card panel-card mb-4">
    <div class="card-body">
      <h5 class="fw-bold mb-3">Room Availability Management</h5>
      {% if room_types %}
      <div class="table-responsive">
        <table class="table table-striped align-middle mb-0">
          <thead>
            <tr>
              <th>Hotel</th>
              <th>Room Type</th>
              <th>Total</th>
              <th>Available</th>
              <th>Update Availability</th>
            </tr>
          </thead>
          <tbody>
            {% for rt in room_types %}
            <tr>
              <td>{{ rt.hotel_name }}</td>
              <td>{{ rt.room_type_name }}</td>
              <td>{{ rt.total_rooms }}</td>
              <td><span class="badge bg-info text-dark">{{ rt.available_rooms }}</span></td>
              <td>
                <form method="POST" class="d-flex flex-wrap gap-2 align-items-center">
                  <input type="hidden" name="action" value="update_inventory">
                  <input type="hidden" name="room_type_id" value="{{ rt.id }}">
                  <input type="number" name="new_available" min="0" class="form-control form-control-sm inv-count-input" value="{{ rt.available_rooms }}" required>
                  <input type="text" name="note" class="form-control form-control-sm inv-note-input" placeholder="reason (optional)">
                  <button class="btn btn-sm btn-primary">Update</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert alert-light border mb-0">No room types added yet.</div>
      {% endif %}
    </div>
  </div>

  <div class="card panel-card mb-4">
    <div class="card-body">
      <h5 class="fw-bold mb-3">My Hotel Listings</h5>
      {% if hotel_services %}
      <div class="row g-3">
        {% for h in hotel_services %}
        <div class="col-md-6 col-lg-4">
          <div class="border rounded p-3 h-100">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="fw-bold mb-1">{{ h.hotel_name }}</h6>
              <span class="badge bg-warning text-dark">{{ h.star_rating }}★</span>
            </div>
            <div class="small text-muted">{{ h.city_name or '-' }}</div>
            <div class="mt-2 small">Starting at Rs {{ h.min_price }}</div>
            <div class="small text-success">Available Rooms: {{ h.total_available }}</div>
            <a href="{{ url_for('provider_hotel_manage_detail', service_id=h.id) }}" class="btn btn-primary btn-sm mt-2">Manage Hotel</a>
            <a href="{{ url_for('hotel_detail', service_id=h.id) }}" class="btn btn-outline-primary btn-sm mt-2">View Public Page</a>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="alert alert-light border mb-0">No hotels listed yet.</div>
      {% endif %}
    </div>
  </div>

  <div class="card panel-card mb-4">
    <div class="card-body">
      <h5 class="fw-bold mb-3">Hotel Booking Requests</h5>
      {% if hotel_bookings %}
      <div class="table-responsive">
        <table class="table table-striped align-middle mb-0">
          <thead>
            <tr>
              <th>ID</th>
              <th>Traveler</th>
              <th>Hotel / Room</th>
              <th>Stay Dates</th>
              <th>Rooms</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Update</th>
            </tr>
          </thead>
          <tbody>
            {% for hb in hotel_bookings %}
            <tr>
              <td>#{{ hb.id }}</td>
              <td>
                {{ hb.traveler_name }}<br>
                <small class="text-muted">{{ hb.traveler_phone or '-' }}</small>
              </td>
              <td>
                <strong>{{ hb.hotel_name }}</strong><br>
                <small class="text-muted">{{ hb.room_type_name or 'Room type' }}</small>
              </td>
              <td>{{ hb.check_in_date }} → {{ hb.check_out_date }}</td>
              <td>{{ hb.rooms_booked }} room(s), {{ hb.guests_count }} guest(s)</td>
              <td>₹{{ hb.total_amount }}</td>
              <td><span class="badge bg-light text-dark border text-capitalize">{{ hb.status }}</span></td>
              <td>
                <form method="POST" class="d-flex gap-2 align-items-center">
                  <input type="hidden" name="action" value="update_hotel_booking_status">
                  <input type="hidden" name="booking_id" value="{{ hb.id }}">
                  <select name="next_status" class="form-select form-select-sm">
                    <option value="confirmed" {% if hb.status == 'confirmed' %}selected{% endif %}>Confirmed</option>
                    <option value="checked_in" {% if hb.status == 'checked_in' %}selected{% endif %}>Checked In</option>
                    <option value="completed" {% if hb.status == 'completed' %}selected{% endif %}>Completed</option>
                    <option value="cancelled" {% if hb.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                  </select>
                  <button class="btn btn-sm btn-primary">Save</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert alert-light border mb-0">No hotel bookings yet.</div>
      {% endif %}
    </div>
  </div>

  <div class="card panel-card">
    <div class="card-body">
      <h5 class="fw-bold mb-3">Publish Transport Service (For Organizers)</h5>
      <form method="POST" enctype="multipart/form-data">
        <input type="hidden" name="action" value="add_transport">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Service Name</label>
            <input type="text" name="service_name" class="form-control" placeholder="Krish Travel Fleet" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Transport Type</label>
            <select name="transport_type" class="form-select" required>
              <option value="">Select type</option>
              <option value="Tour Bus">Tour Bus</option>
              <option value="Mini Bus">Mini Bus</option>
              <option value="Tempo Traveller">Tempo Traveller</option>
              <option value="Taxi">Taxi</option>
              <option value="Car Rental">Car Rental</option>
              <option value="Bike Rental">Bike Rental</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">State</label>
            <select class="form-select js-state-filter" data-city-target="transportCitySelect" required>
              <option value="">Select state</option>
              {% for s in states %}
              <option value="{{ s.id }}">{{ s.state_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">City</label>
            <select name="city_id" id="transportCitySelect" class="form-select" required disabled>
              <option value="">Select city</option>
              {% for c in cities %}
              <option value="{{ c.id }}" data-state-id="{{ c.state_id }}">{{ c.city_name }} ({{ c.state_name }})</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">Vehicle Model</label>
            <input type="text" name="vehicle_model" class="form-control" placeholder="Force Urbania / Swift Dzire">
          </div>
          <div class="col-md-4">
            <label class="form-label">Registration Number</label>
            <input type="text" name="registration_number" class="form-control" placeholder="GJ01AB1234" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Seating Capacity</label>
            <input type="number" name="seating_capacity" class="form-control" min="1">
          </div>
          <div class="col-md-4">
            <label class="form-label">Total Vehicles</label>
            <input type="number" name="total_units" class="form-control" min="1" value="1" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Available Vehicles</label>
            <input type="number" name="available_units" class="form-control" min="0" value="1" required>
          </div>

          <div class="col-md-4">
            <label class="form-label">Luggage Capacity</label>
            <input type="text" name="luggage_capacity" class="form-control" placeholder="3 Large + 2 Cabin">
          </div>
          <div class="col-md-4">
            <label class="form-label">Price Per Day</label>
            <input type="number" name="price_per_day" step="0.01" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Price Per KM</label>
            <input type="number" name="price_per_km" step="0.01" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">Vehicle Photo (Required: Upload or URL)</label>
            <input type="file" name="vehicle_photo" class="form-control" accept=".jpg,.jpeg,.png,.webp">
          </div>
          <div class="col-md-6">
            <label class="form-label">Vehicle Photo URL (Required: Upload or URL)</label>
            <input type="url" name="vehicle_image_url" class="form-control" placeholder="https://example.com/vehicle.jpg">
          </div>

          <div class="col-md-4">
            <label class="form-label">Driver Name</label>
            <input type="text" name="driver_name" class="form-control">
          </div>
          <div class="col-md-4">
            <label class="form-label">Driver Phone</label>
            <input type="text" name="driver_phone" class="form-control">
          </div>
          <div class="col-md-4 d-flex flex-wrap align-items-end gap-3">
            <div class="form-check"><input class="form-check-input" type="checkbox" name="ac_available" id="trAc" checked><label class="form-check-label" for="trAc">AC Available</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" name="driver_available" id="trDrv" checked><label class="form-check-label" for="trDrv">Driver Included</label></div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Permit Document (Required)</label>
            <input type="file" name="permit_doc" class="form-control" accept=".pdf,.jpg,.jpeg,.png" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Insurance Document (Required)</label>
            <input type="file" name="insurance_doc" class="form-control" accept=".pdf,.jpg,.jpeg,.png" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Driver License Copy (Required if Driver Included)</label>
            <input type="file" name="license_doc" class="form-control" accept=".pdf,.jpg,.jpeg,.png">
          </div>
          <div class="col-md-6">
            <label class="form-label">RC Book / Vehicle Registration (Required)</label>
            <input type="file" name="rc_doc" class="form-control" accept=".pdf,.jpg,.jpeg,.png" required>
          </div>

          <div class="col-12">
            <label class="form-label">Notes for Organizer</label>
            <input type="text" name="description" class="form-control" placeholder="Fuel policy, extra charges, route limits...">
          </div>

          <div class="col-12">
            <button class="btn btn-primary">Publish Transport Service</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  <div class="card panel-card mt-4 mb-4">
    <div class="card-body">
      <h5 class="fw-bold mb-3">My Transport Listings</h5>
      {% if transport_services %}
      <div class="table-responsive">
        <table class="table table-striped align-middle mb-0">
          <thead>
            <tr>
              <th>Service</th>
              <th>Type</th>
              <th>Vehicle</th>
              <th>Route City</th>
              <th>Capacity / Inventory</th>
              <th>Price</th>
              <th>Update Availability</th>
            </tr>
          </thead>
          <tbody>
            {% for tr in transport_services %}
            <tr>
              <td>
                {% set tr_img = tr.vehicle_image_url if tr.vehicle_image_url and (tr.vehicle_image_url.startswith('http://') or tr.vehicle_image_url.startswith('https://')) else url_for('static', filename='uploads/' ~ (tr.vehicle_image_url or 'demo.jpg')) %}
                <img src="{{ tr_img }}" alt="{{ tr.service_name }}" style="width:80px;height:52px;object-fit:cover;border-radius:8px;" class="mb-1"
                     onerror="this.onerror=null;this.src='{{ url_for('static', filename='uploads/demo.jpg') }}';">
                <br><strong>{{ tr.service_name }}</strong><br><small class="text-muted">{{ tr.registration_number }}</small>
              </td>
              <td>{{ tr.transport_type }}</td>
              <td>{{ tr.vehicle_model or '-' }}</td>
              <td>{{ tr.city_name or '-' }}{% if tr.state_name %}, {{ tr.state_name }}{% endif %}</td>
              <td>
                {% if tr.seating_capacity %}{{ tr.seating_capacity }} seats{% else %}-{% endif %}
                {% if tr.driver_available %}<br><small class="text-success">Driver included</small>{% endif %}
                <br><small class="text-muted">Vehicles: {{ tr.available_units or 0 }} / {{ tr.total_units or 0 }}</small>
              </td>
              <td>₹{{ tr.price_per_day or 0 }}/day{% if tr.price_per_km %}<br><small>₹{{ tr.price_per_km }}/km</small>{% endif %}</td>
              <td>
                <form method="POST" class="d-flex flex-wrap gap-2 align-items-center">
                  <input type="hidden" name="action" value="update_transport_inventory">
                  <input type="hidden" name="service_id" value="{{ tr.service_id }}">
                  <input type="number" name="new_available" min="0" class="form-control form-control-sm inv-count-input" value="{{ tr.available_units or 0 }}" required>
                  <input type="text" name="note" class="form-control form-control-sm inv-note-input" placeholder="reason (optional)">
                  <button class="btn btn-sm btn-primary">Update</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert alert-light border mb-0">No transport services listed yet.</div>
      {% endif %}
    </div>
  </div>
  <div class="card panel-card mt-4 mb-4">
    <div class="card-body">
      <h5 class="fw-bold mb-3">Transport Inventory Logs</h5>
      {% if transport_logs %}
      <div class="table-responsive">
        <table class="table table-striped align-middle mb-0">
          <thead>
            <tr>
              <th>Time</th>
              <th>Service</th>
              <th>Availability</th>
              <th>Note</th>
            </tr>
          </thead>
          <tbody>
            {% for log in transport_logs %}
            <tr>
              <td>{{ log.created_at }}</td>
              <td>{{ log.service_name }}<br><small class="text-muted">{{ log.registration_number }}</small></td>
              <td>{{ log.old_available }} → {{ log.new_available }}</td>
              <td>{{ log.note or '-' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert alert-light border mb-0">No transport inventory updates yet.</div>
      {% endif %}
    </div>
  </div>

  {% if role == 'hotel_provider' %}
  <div class="card panel-card">
    <div class="card-body">
      <h5 class="fw-bold mb-3">Publish Non-Hotel Service</h5>
      <form method="POST">
        <input type="hidden" name="action" value="add_service">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Service Type</label>
            <select name="service_type" class="form-select" required>
              <option value="">Select type</option>
              <option value="Guides">Guides</option>
              <option value="Food">Food</option>
            </select>
          </div>

          <div class="col-md-3">
            <label class="form-label">Service Name</label>
            <input type="text" name="service_name" class="form-control" required>
          </div>

          <div class="col-md-3">
            <label class="form-label">State</label>
            <select class="form-select js-state-filter" data-city-target="serviceCitySelect" required>
              <option value="">Select state</option>
              {% for s in states %}
              <option value="{{ s.id }}">{{ s.state_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">City</label>
            <select name="city_id" id="serviceCitySelect" class="form-select" required disabled>
              <option value="">Select city</option>
              {% for c in cities %}
              <option value="{{ c.id }}" data-state-id="{{ c.state_id }}">{{ c.city_name }} ({{ c.state_name }})</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">Price</label>
            <input type="number" name="price" step="0.01" class="form-control" required>
          </div>

          <div class="col-md-8">
            <label class="form-label">Description</label>
            <input type="text" name="description" class="form-control">
          </div>

          <div class="col-12">
            <button class="btn btn-success">Publish Service</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  {% endif %}

    </main>
  </div>
</div>
<script>
  (function () {
    function syncCityOptions(stateSelect) {
      const citySelect = document.getElementById(stateSelect.dataset.cityTarget || "");
      if (!citySelect) return;
      const stateId = (stateSelect.value || "").trim();
      citySelect.querySelectorAll("option[data-state-id]").forEach((opt) => {
        const visible = !!stateId && String(opt.dataset.stateId) === String(stateId);
        opt.hidden = !visible;
        opt.disabled = !visible;
        opt.style.display = visible ? "" : "none";
      });
      if (!stateId) {
        citySelect.value = "";
        citySelect.disabled = true;
        return;
      }
      citySelect.disabled = false;
      const selected = citySelect.options[citySelect.selectedIndex];
      if (selected && selected.value && (selected.disabled || String(selected.dataset.stateId || "") !== stateId)) {
        citySelect.value = "";
      }
    }

    document.querySelectorAll(".js-state-filter[data-city-target]").forEach((stateSelect) => {
      stateSelect.addEventListener("change", () => syncCityOptions(stateSelect));
      syncCityOptions(stateSelect);
    });
  })();

  (function () {
    const form = document.querySelector("form input[name='action'][value='add_transport']")?.closest("form");
    if (!form) return;

    const driverCheckbox = form.querySelector("input[name='driver_available']");
    const driverName = form.querySelector("input[name='driver_name']");
    const driverPhone = form.querySelector("input[name='driver_phone']");
    const licenseDoc = form.querySelector("input[name='license_doc']");
    const vehiclePhoto = form.querySelector("input[name='vehicle_photo']");
    const vehicleImageUrl = form.querySelector("input[name='vehicle_image_url']");

    const syncTransportRequirements = () => {
      const driverRequired = !!(driverCheckbox && driverCheckbox.checked);
      if (driverName) driverName.required = driverRequired;
      if (driverPhone) driverPhone.required = driverRequired;
      if (licenseDoc) licenseDoc.required = driverRequired;

      const hasPhoto = !!(vehiclePhoto && vehiclePhoto.files && vehiclePhoto.files.length > 0);
      const hasUrl = !!(vehicleImageUrl && vehicleImageUrl.value.trim());
      if (vehiclePhoto) vehiclePhoto.required = !hasUrl;
      if (vehicleImageUrl) vehicleImageUrl.required = !hasPhoto;
    };

    if (driverCheckbox) driverCheckbox.addEventListener("change", syncTransportRequirements);
    if (vehiclePhoto) vehiclePhoto.addEventListener("change", syncTransportRequirements);
    if (vehicleImageUrl) vehicleImageUrl.addEventListener("input", syncTransportRequirements);
    syncTransportRequirements();
  })();
</script>
{% endblock %}
