{% extends "layout.html" %}
{% block title %}Provider Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/provider_dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/role_dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="container mt-5 pb-5 dashboard-shell dashboard-page provider-dashboard-page">
  <div class="dashboard-toolbar-card d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
    <div class="dashboard-brand"><i class="bi bi-buildings me-1"></i> TourGen Hotel Owner Dashboard</div>
    <div class="d-flex flex-wrap align-items-center gap-2">
      <button type="button" class="btn btn-outline-light btn-sm rounded-pill" data-theme-toggle>
        <i class="bi bi-moon-stars me-1"></i> <span data-theme-label>Dark Mode</span>
      </button>
      <a href="{{ url_for('home') }}" class="btn btn-outline-light btn-sm rounded-pill">
        <i class="bi bi-globe me-1"></i> Public Website
      </a>
      <a href="{{ url_for('logout') }}" class="btn btn-danger btn-sm rounded-pill">
        <i class="bi bi-box-arrow-right me-1"></i> Logout
      </a>
    </div>
  </div>
  {% set provider_sidebar_active = 'dashboard' %}
  <div class="provider-shell">
    {% include "provider_sidebar.html" %}
    <main class="provider-main">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2 provider-header">
    <div class="d-flex flex-wrap align-items-center gap-2 provider-header-title">
      <h2 class="fw-bold mb-0">Hotel Owner Workspace</h2>
      <a href="{{ url_for('provider_add_hotel') }}" class="btn btn-primary btn-sm rounded-pill">Add Hotel</a>
      <a href="{{ url_for('provider_hotels_management') }}" class="btn btn-outline-primary btn-sm rounded-pill">Manage All Hotels</a>
    </div>
    {% if profile and profile.provider_category %}
      <span class="badge badge-soft">Category: {{ profile.provider_category }}</span>
    {% endif %}
  </div>

  {% with messages = get_flashed_messages() %}
  {% if messages %}
  <div class="alert alert-info border-0 shadow-sm">{{ messages[0] }}</div>
  {% endif %}
  {% endwith %}

  <div class="card panel-card mb-4">
    <div class="card-body d-flex flex-wrap justify-content-between align-items-center gap-3">
      <div>
        <h5 class="fw-bold mb-1">Hotel Owner Pages</h5>
        <div class="text-muted small">Use dedicated pages to add new hotels and manage all existing hotels.</div>
      </div>
      <div class="d-flex flex-wrap gap-2">
        <a href="{{ url_for('provider_add_hotel') }}" class="btn btn-primary rounded-pill">Open Add Hotel</a>
        <a href="{{ url_for('provider_hotels_management') }}" class="btn btn-outline-primary rounded-pill">Open Manage Hotel</a>
      </div>
    </div>
  </div>

  <div class="card panel-card mb-4">
    <div class="card-body">
      <h5 class="fw-bold mb-3">Add Room Type</h5>
      <form method="POST">
        <input type="hidden" name="action" value="add_room_type">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Hotel</label>
            <select name="service_id" class="form-select" required>
              <option value="">Select hotel</option>
              {% for h in hotel_services %}
              <option value="{{ h.id }}">{{ h.hotel_name }} ({{ h.city_name or '-' }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Room Type</label>
            <input type="text" name="room_type_name" class="form-control" placeholder="Deluxe Room" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Bed Type</label>
            <input type="text" name="bed_type" class="form-control" placeholder="King / Queen / Twin">
          </div>

          <div class="col-md-2">
            <label class="form-label">Room Size (sqft)</label>
            <input type="number" name="room_size_sqft" class="form-control">
          </div>
          <div class="col-md-2">
            <label class="form-label">Max Guests</label>
            <input type="number" name="max_guests" class="form-control" value="2">
          </div>
          <div class="col-md-2">
            <label class="form-label">Total Rooms</label>
            <input type="number" name="total_rooms" class="form-control" value="10">
          </div>
          <div class="col-md-2">
            <label class="form-label">Available Rooms</label>
            <input type="number" name="available_rooms" class="form-control" value="10">
          </div>
          <div class="col-md-2">
            <label class="form-label">Base Price</label>
            <input type="number" step="0.01" name="room_base_price" class="form-control" required>
          </div>
          <div class="col-md-2">
            <label class="form-label">Strike Price</label>
            <input type="number" step="0.01" name="strike_price" class="form-control">
          </div>

          <div class="col-md-3">
            <label class="form-label">Tax %</label>
            <input type="number" step="0.01" name="tax_percent" class="form-control" value="0">
          </div>
          <div class="col-md-9 d-flex flex-wrap align-items-end gap-3">
            <div class="form-check"><input class="form-check-input" type="checkbox" name="breakfast_included" id="rbf"><label class="form-check-label" for="rbf">Breakfast Included</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" name="ac_available" id="rac" checked><label class="form-check-label" for="rac">AC</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" name="wifi_available" id="rwi" checked><label class="form-check-label" for="rwi">WiFi</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" name="refundable" id="rrf"><label class="form-check-label" for="rrf">Refundable</label></div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Cancellation Policy</label>
            <input type="text" name="cancellation_policy" class="form-control" placeholder="Free cancellation till 24 hrs">
          </div>
          <div class="col-md-6">
            <label class="form-label">Room Description</label>
            <input type="text" name="room_description" class="form-control">
          </div>

          <div class="col-12">
            <button class="btn btn-success">Add Room Type</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="card panel-card mb-4">
    <div class="card-body">
      <h5 class="fw-bold mb-3">Room Availability Management</h5>
      {% if room_types %}
      <div class="table-responsive">
        <table class="table table-striped align-middle mb-0">
          <thead>
            <tr>
              <th>Hotel</th>
              <th>Room Type</th>
              <th>Total</th>
              <th>Available</th>
              <th>Update Availability</th>
            </tr>
          </thead>
          <tbody>
            {% for rt in room_types %}
            <tr>
              <td>{{ rt.hotel_name }}</td>
              <td>{{ rt.room_type_name }}</td>
              <td>{{ rt.total_rooms }}</td>
              <td><span class="badge bg-info text-dark">{{ rt.available_rooms }}</span></td>
              <td>
                <form method="POST" class="d-flex flex-wrap gap-2 align-items-center">
                  <input type="hidden" name="action" value="update_inventory">
                  <input type="hidden" name="room_type_id" value="{{ rt.id }}">
                  <input type="number" name="new_available" min="0" class="form-control form-control-sm inv-count-input" value="{{ rt.available_rooms }}" required>
                  <input type="text" name="note" class="form-control form-control-sm inv-note-input" placeholder="reason (optional)">
                  <button class="btn btn-sm btn-primary">Update</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert alert-light border mb-0">No room types added yet.</div>
      {% endif %}
    </div>
  </div>

  <div class="card panel-card mb-4">
    <div class="card-body">
      <h5 class="fw-bold mb-3">My Hotel Listings</h5>
      {% if hotel_services %}
      <div class="row g-3">
        {% for h in hotel_services %}
        <div class="col-md-6 col-lg-4">
          <div class="border rounded p-3 h-100">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="fw-bold mb-1">{{ h.hotel_name }}</h6>
              <span class="badge bg-warning text-dark">{{ h.star_rating }}★</span>
            </div>
            <div class="small text-muted">{{ h.city_name or '-' }}</div>
            <div class="mt-2 small">Starting at Rs {{ h.min_price }}</div>
            <div class="small text-success">Available Rooms: {{ h.total_available }}</div>
            <a href="{{ url_for('provider_hotel_manage_detail', service_id=h.id) }}" class="btn btn-primary btn-sm mt-2">Manage Hotel</a>
            <a href="{{ url_for('hotel_detail', service_id=h.id) }}" class="btn btn-outline-primary btn-sm mt-2">View Public Page</a>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="alert alert-light border mb-0">No hotels listed yet.</div>
      {% endif %}
    </div>
  </div>

  <div class="card panel-card mb-4">
    <div class="card-body">
      <h5 class="fw-bold mb-3">Hotel Booking Requests</h5>
      {% if hotel_bookings %}
      <div class="table-responsive">
        <table class="table table-striped align-middle mb-0">
          <thead>
            <tr>
              <th>ID</th>
              <th>Traveler</th>
              <th>Hotel / Room</th>
              <th>Stay Dates</th>
              <th>Rooms</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Update</th>
            </tr>
          </thead>
          <tbody>
            {% for hb in hotel_bookings %}
            <tr>
              <td>#{{ hb.id }}</td>
              <td>
                {{ hb.traveler_name }}<br>
                <small class="text-muted">{{ hb.traveler_phone or '-' }}</small>
              </td>
              <td>
                <strong>{{ hb.hotel_name }}</strong><br>
                <small class="text-muted">{{ hb.room_type_name or 'Room type' }}</small>
              </td>
              <td>{{ hb.check_in_date }} → {{ hb.check_out_date }}</td>
              <td>{{ hb.rooms_booked }} room(s), {{ hb.guests_count }} guest(s)</td>
              <td>₹{{ hb.total_amount }}</td>
              <td><span class="badge bg-light text-dark border text-capitalize">{{ hb.status }}</span></td>
              <td>
                <form method="POST" class="d-flex gap-2 align-items-center">
                  <input type="hidden" name="action" value="update_hotel_booking_status">
                  <input type="hidden" name="booking_id" value="{{ hb.id }}">
                  <select name="next_status" class="form-select form-select-sm">
                    <option value="confirmed" {% if hb.status == 'confirmed' %}selected{% endif %}>Confirmed</option>
                    <option value="checked_in" {% if hb.status == 'checked_in' %}selected{% endif %}>Checked In</option>
                    <option value="completed" {% if hb.status == 'completed' %}selected{% endif %}>Completed</option>
                    <option value="cancelled" {% if hb.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                  </select>
                  <button class="btn btn-sm btn-primary">Save</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert alert-light border mb-0">No hotel bookings yet.</div>
      {% endif %}
    </div>
  </div>

    </main>
  </div>
</div>
{% endblock %}
