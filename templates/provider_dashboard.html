{% extends "layout.html" %}
{% block title %}Provider Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/provider_dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="container mt-5 pb-5">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
    <div class="d-flex flex-wrap align-items-center gap-2">
      <h2 class="fw-bold mb-0">Service Provider Dashboard</h2>
      <a href="{{ url_for('provider_hotels_management') }}" class="btn btn-dark btn-sm rounded-pill">Manage All Hotels</a>
    </div>
    {% if profile and profile.provider_category %}
      <span class="badge badge-soft">Category: {{ profile.provider_category }}</span>
    {% endif %}
  </div>

  {% with messages = get_flashed_messages() %}
  {% if messages %}
  <div class="alert alert-info border-0 shadow-sm">{{ messages[0] }}</div>
  {% endif %}
  {% endwith %}

  <div class="card panel-card mb-4">
    <div class="card-body">
      <h5 class="fw-bold mb-3">Create Hotel Listing</h5>
      <form method="POST" enctype="multipart/form-data">
        <input type="hidden" name="action" value="add_hotel">

        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Hotel Name</label>
            <input type="text" name="hotel_name" class="form-control" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Brand Name</label>
            <input type="text" name="brand_name" class="form-control">
          </div>
          <div class="col-md-3">
            <label class="form-label">Star Rating</label>
            <select name="star_rating" class="form-select">
              <option value="0">0 Star</option>
              <option value="1">1 Star</option>
              <option value="2">2 Star</option>
              <option value="3">3 Star</option>
              <option value="4">4 Star</option>
              <option value="5">5 Star</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">City</label>
            <select name="city_id" class="form-select" required>
              <option value="">Select city</option>
              {% for c in cities %}
              <option value="{{ c.id }}">{{ c.state_name }} -> {{ c.city_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Starting Price</label>
            <input type="number" step="0.01" name="base_price" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Pincode</label>
            <input type="text" name="pincode" class="form-control">
          </div>

          <div class="col-md-6">
            <label class="form-label">Address Line 1</label>
            <input type="text" name="address_line1" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Address Line 2</label>
            <input type="text" name="address_line2" class="form-control">
          </div>

          <div class="col-md-4">
            <label class="form-label">Locality</label>
            <input type="text" name="locality" class="form-control">
          </div>
          <div class="col-md-4">
            <label class="form-label">Landmark</label>
            <input type="text" name="landmark" class="form-control">
          </div>
          <div class="col-md-2">
            <label class="form-label">Check-In</label>
            <input type="time" name="check_in_time" class="form-control">
          </div>
          <div class="col-md-2">
            <label class="form-label">Check-Out</label>
            <input type="time" name="check_out_time" class="form-control">
          </div>

          <div class="col-md-3">
            <label class="form-label">Latitude</label>
            <input type="text" name="latitude" class="form-control" placeholder="23.0225">
          </div>
          <div class="col-md-3">
            <label class="form-label">Longitude</label>
            <input type="text" name="longitude" class="form-control" placeholder="72.5714">
          </div>

          <div class="col-md-6">
            <label class="form-label">Hotel Photos</label>
            <input type="file" name="hotel_images" class="form-control" multiple accept="image/*">
            <div class="small-muted mt-1">First uploaded image will be used as cover.</div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Amenities</label>
            <div class="amenities-box border rounded p-2">
              {% for a in amenities %}
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="amenity_ids" value="{{ a.id }}" id="amenity{{ a.id }}">
                <label class="form-check-label" for="amenity{{ a.id }}">{{ a.amenity_name }}</label>
              </div>
              {% endfor %}
            </div>
          </div>

          <div class="col-md-12">
            <label class="form-label">Hotel Description</label>
            <textarea name="hotel_description" rows="3" class="form-control"></textarea>
          </div>
          <div class="col-md-12">
            <label class="form-label">House Rules</label>
            <textarea name="house_rules" rows="2" class="form-control"></textarea>
          </div>

          <div class="col-md-12">
            <div class="d-flex flex-wrap gap-3">
              <div class="form-check"><input class="form-check-input" type="checkbox" name="couple_friendly" id="cf"><label class="form-check-label" for="cf">Couple Friendly</label></div>
              <div class="form-check"><input class="form-check-input" type="checkbox" name="pets_allowed" id="pa"><label class="form-check-label" for="pa">Pets Allowed</label></div>
              <div class="form-check"><input class="form-check-input" type="checkbox" name="parking_available" id="pk"><label class="form-check-label" for="pk">Parking</label></div>
              <div class="form-check"><input class="form-check-input" type="checkbox" name="breakfast_available" id="bf"><label class="form-check-label" for="bf">Breakfast</label></div>
            </div>
          </div>

          <div class="col-12">
            <button class="btn btn-primary">Create Hotel Listing</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="card panel-card mb-4">
    <div class="card-body">
      <h5 class="fw-bold mb-3">Add Room Type</h5>
      <form method="POST">
        <input type="hidden" name="action" value="add_room_type">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Hotel</label>
            <select name="service_id" class="form-select" required>
              <option value="">Select hotel</option>
              {% for h in hotel_services %}
              <option value="{{ h.id }}">{{ h.hotel_name }} ({{ h.city_name or '-' }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Room Type</label>
            <input type="text" name="room_type_name" class="form-control" placeholder="Deluxe Room" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Bed Type</label>
            <input type="text" name="bed_type" class="form-control" placeholder="King / Queen / Twin">
          </div>

          <div class="col-md-2">
            <label class="form-label">Room Size (sqft)</label>
            <input type="number" name="room_size_sqft" class="form-control">
          </div>
          <div class="col-md-2">
            <label class="form-label">Max Guests</label>
            <input type="number" name="max_guests" class="form-control" value="2">
          </div>
          <div class="col-md-2">
            <label class="form-label">Total Rooms</label>
            <input type="number" name="total_rooms" class="form-control" value="10">
          </div>
          <div class="col-md-2">
            <label class="form-label">Available Rooms</label>
            <input type="number" name="available_rooms" class="form-control" value="10">
          </div>
          <div class="col-md-2">
            <label class="form-label">Base Price</label>
            <input type="number" step="0.01" name="room_base_price" class="form-control" required>
          </div>
          <div class="col-md-2">
            <label class="form-label">Strike Price</label>
            <input type="number" step="0.01" name="strike_price" class="form-control">
          </div>

          <div class="col-md-3">
            <label class="form-label">Tax %</label>
            <input type="number" step="0.01" name="tax_percent" class="form-control" value="0">
          </div>
          <div class="col-md-9 d-flex flex-wrap align-items-end gap-3">
            <div class="form-check"><input class="form-check-input" type="checkbox" name="breakfast_included" id="rbf"><label class="form-check-label" for="rbf">Breakfast Included</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" name="ac_available" id="rac" checked><label class="form-check-label" for="rac">AC</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" name="wifi_available" id="rwi" checked><label class="form-check-label" for="rwi">WiFi</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" name="refundable" id="rrf"><label class="form-check-label" for="rrf">Refundable</label></div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Cancellation Policy</label>
            <input type="text" name="cancellation_policy" class="form-control" placeholder="Free cancellation till 24 hrs">
          </div>
          <div class="col-md-6">
            <label class="form-label">Room Description</label>
            <input type="text" name="room_description" class="form-control">
          </div>

          <div class="col-12">
            <button class="btn btn-success">Add Room Type</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="card panel-card mb-4">
    <div class="card-body">
      <h5 class="fw-bold mb-3">Room Availability Management</h5>
      {% if room_types %}
      <div class="table-responsive">
        <table class="table table-striped align-middle mb-0">
          <thead>
            <tr>
              <th>Hotel</th>
              <th>Room Type</th>
              <th>Total</th>
              <th>Available</th>
              <th>Update Availability</th>
            </tr>
          </thead>
          <tbody>
            {% for rt in room_types %}
            <tr>
              <td>{{ rt.hotel_name }}</td>
              <td>{{ rt.room_type_name }}</td>
              <td>{{ rt.total_rooms }}</td>
              <td><span class="badge bg-info text-dark">{{ rt.available_rooms }}</span></td>
              <td>
                <form method="POST" class="d-flex flex-wrap gap-2 align-items-center">
                  <input type="hidden" name="action" value="update_inventory">
                  <input type="hidden" name="room_type_id" value="{{ rt.id }}">
                  <input type="number" name="new_available" min="0" class="form-control form-control-sm inv-count-input" value="{{ rt.available_rooms }}" required>
                  <input type="text" name="note" class="form-control form-control-sm inv-note-input" placeholder="reason (optional)">
                  <button class="btn btn-sm btn-primary">Update</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert alert-light border mb-0">No room types added yet.</div>
      {% endif %}
    </div>
  </div>

  <div class="card panel-card mb-4">
    <div class="card-body">
      <h5 class="fw-bold mb-3">My Hotel Listings</h5>
      {% if hotel_services %}
      <div class="row g-3">
        {% for h in hotel_services %}
        <div class="col-md-6 col-lg-4">
          <div class="border rounded p-3 h-100">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="fw-bold mb-1">{{ h.hotel_name }}</h6>
              <span class="badge bg-warning text-dark">{{ h.star_rating }}★</span>
            </div>
            <div class="small text-muted">{{ h.city_name or '-' }}</div>
            <div class="mt-2 small">Starting at Rs {{ h.min_price }}</div>
            <div class="small text-success">Available Rooms: {{ h.total_available }}</div>
            <a href="{{ url_for('hotel_detail', service_id=h.id) }}" class="btn btn-outline-primary btn-sm mt-2">View Public Page</a>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="alert alert-light border mb-0">No hotels listed yet.</div>
      {% endif %}
    </div>
  </div>

  <div class="card panel-card">
    <div class="card-body">
      <h5 class="fw-bold mb-3">Publish Transport Service (For Organizers)</h5>
      <form method="POST" enctype="multipart/form-data">
        <input type="hidden" name="action" value="add_transport">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Service Name</label>
            <input type="text" name="service_name" class="form-control" placeholder="Krish Travel Fleet" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Transport Type</label>
            <select name="transport_type" class="form-select" required>
              <option value="">Select type</option>
              <option value="Tour Bus">Tour Bus</option>
              <option value="Mini Bus">Mini Bus</option>
              <option value="Tempo Traveller">Tempo Traveller</option>
              <option value="Taxi">Taxi</option>
              <option value="Car Rental">Car Rental</option>
              <option value="Bike Rental">Bike Rental</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">City</label>
            <select name="city_id" class="form-select" required>
              <option value="">Select city</option>
              {% for c in cities %}
              <option value="{{ c.id }}">{{ c.state_name }} -> {{ c.city_name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">Vehicle Model</label>
            <input type="text" name="vehicle_model" class="form-control" placeholder="Force Urbania / Swift Dzire">
          </div>
          <div class="col-md-4">
            <label class="form-label">Registration Number</label>
            <input type="text" name="registration_number" class="form-control" placeholder="GJ01AB1234" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Seating Capacity</label>
            <input type="number" name="seating_capacity" class="form-control" min="1">
          </div>

          <div class="col-md-4">
            <label class="form-label">Luggage Capacity</label>
            <input type="text" name="luggage_capacity" class="form-control" placeholder="3 Large + 2 Cabin">
          </div>
          <div class="col-md-4">
            <label class="form-label">Price Per Day</label>
            <input type="number" name="price_per_day" step="0.01" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Price Per KM</label>
            <input type="number" name="price_per_km" step="0.01" class="form-control">
          </div>

          <div class="col-md-4">
            <label class="form-label">Driver Name</label>
            <input type="text" name="driver_name" class="form-control">
          </div>
          <div class="col-md-4">
            <label class="form-label">Driver Phone</label>
            <input type="text" name="driver_phone" class="form-control">
          </div>
          <div class="col-md-4 d-flex flex-wrap align-items-end gap-3">
            <div class="form-check"><input class="form-check-input" type="checkbox" name="ac_available" id="trAc" checked><label class="form-check-label" for="trAc">AC Available</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" name="driver_available" id="trDrv" checked><label class="form-check-label" for="trDrv">Driver Included</label></div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Permit Document (Required)</label>
            <input type="file" name="permit_doc" class="form-control" accept=".pdf,.jpg,.jpeg,.png" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Insurance Document (Required)</label>
            <input type="file" name="insurance_doc" class="form-control" accept=".pdf,.jpg,.jpeg,.png" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Driver License Copy (Required)</label>
            <input type="file" name="license_doc" class="form-control" accept=".pdf,.jpg,.jpeg,.png" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">RC Book / Vehicle Registration (Required)</label>
            <input type="file" name="rc_doc" class="form-control" accept=".pdf,.jpg,.jpeg,.png" required>
          </div>

          <div class="col-12">
            <label class="form-label">Notes for Organizer</label>
            <input type="text" name="description" class="form-control" placeholder="Fuel policy, extra charges, route limits...">
          </div>

          <div class="col-12">
            <button class="btn btn-primary">Publish Transport Service</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="card panel-card mt-4 mb-4">
    <div class="card-body">
      <h5 class="fw-bold mb-3">My Transport Listings</h5>
      {% if transport_services %}
      <div class="table-responsive">
        <table class="table table-striped align-middle mb-0">
          <thead>
            <tr>
              <th>Service</th>
              <th>Type</th>
              <th>Vehicle</th>
              <th>Route City</th>
              <th>Capacity</th>
              <th>Price</th>
            </tr>
          </thead>
          <tbody>
            {% for tr in transport_services %}
            <tr>
              <td><strong>{{ tr.service_name }}</strong><br><small class="text-muted">{{ tr.registration_number }}</small></td>
              <td>{{ tr.transport_type }}</td>
              <td>{{ tr.vehicle_model or '-' }}</td>
              <td>{{ tr.city_name or '-' }}{% if tr.state_name %}, {{ tr.state_name }}{% endif %}</td>
              <td>{% if tr.seating_capacity %}{{ tr.seating_capacity }} seats{% else %}-{% endif %}{% if tr.driver_available %}<br><small class="text-success">Driver included</small>{% endif %}</td>
              <td>₹{{ tr.price_per_day or 0 }}/day{% if tr.price_per_km %}<br><small>₹{{ tr.price_per_km }}/km</small>{% endif %}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert alert-light border mb-0">No transport services listed yet.</div>
      {% endif %}
    </div>
  </div>

  <div class="card panel-card">
    <div class="card-body">
      <h5 class="fw-bold mb-3">Publish Non-Hotel Service</h5>
      <form method="POST">
        <input type="hidden" name="action" value="add_service">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Service Type</label>
            <select name="service_type" class="form-select" required>
              <option value="">Select type</option>
              <option value="Transport">Transport</option>
              <option value="Guides">Guides</option>
              <option value="Food">Food</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">Service Name</label>
            <input type="text" name="service_name" class="form-control" required>
          </div>

          <div class="col-md-4">
            <label class="form-label">City</label>
            <select name="city_id" class="form-select" required>
              <option value="">Select city</option>
              {% for c in cities %}
              <option value="{{ c.id }}">{{ c.state_name }} -> {{ c.city_name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">Price</label>
            <input type="number" name="price" step="0.01" class="form-control" required>
          </div>

          <div class="col-md-8">
            <label class="form-label">Description</label>
            <input type="text" name="description" class="form-control">
          </div>

          <div class="col-12">
            <button class="btn btn-success">Publish Service</button>
          </div>
        </div>
      </form>
    </div>
  </div>

</div>
{% endblock %}
