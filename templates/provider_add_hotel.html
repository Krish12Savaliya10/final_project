{% extends "layout.html" %}
{% block title %}Add Hotel{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/provider_dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/role_dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/oyo_hotel_hub.css') }}">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
{% endblock %}

{% block content %}
{% set provider_sidebar_active = 'add_hotel' %}
<div class="container mt-5 pb-5 dashboard-shell dashboard-page provider-dashboard-page">
  <div class="provider-shell">
    {% include "provider_sidebar.html" %}
    <main class="provider-main">
      <div class="oyo-page">
  <div class="oyo-hero d-flex flex-wrap justify-content-between align-items-start gap-3">
    <div>
      <h2>OYO-Style Property Registration</h2>
      <div class="sub">Add your hotel with detailed property profile, registration details, policies and media.</div>
    </div>
    <div class="oyo-actions">
      <a href="{{ url_for('provider_hotels_management') }}" class="oyo-btn light"><i class="bi bi-buildings"></i> Manage Hotels</a>
      <a href="{{ url_for('provider_dashboard') }}" class="oyo-btn outline"><i class="bi bi-grid"></i> Dashboard</a>
    </div>
  </div>

  {% with messages = get_flashed_messages() %}
  {% if messages %}
  <div class="alert alert-info border-0 shadow-sm">{{ messages[0] }}</div>
  {% endif %}
  {% endwith %}

  <div class="oyo-panel">
    <div class="panel-head">
      <h5>Create New Property</h5>
      <div class="muted">Complete all major sections. Mandatory fields are validated before creating the hotel.</div>
    </div>
    <div class="panel-body">
      <form method="POST" enctype="multipart/form-data">
        <div class="row g-3">
          <div class="col-12">
            <div class="oyo-section-title"><span class="dot"></span> Property Basics</div>
          </div>

          <div class="col-md-6">
            <label class="oyo-label">Hotel Name</label>
            <input type="text" name="hotel_name" class="form-control oyo-input" required>
          </div>
          <div class="col-md-3">
            <label class="oyo-label">Brand Name</label>
            <input type="text" name="brand_name" class="form-control oyo-input">
          </div>
          <div class="col-md-3">
            <label class="oyo-label">Star Rating</label>
            <select name="star_rating" class="form-select oyo-select">
              <option value="0">0 Star</option>
              <option value="1">1 Star</option>
              <option value="2">2 Star</option>
              <option value="3">3 Star</option>
              <option value="4">4 Star</option>
              <option value="5">5 Star</option>
            </select>
          </div>

          <div class="col-md-3">
            <label class="oyo-label">State</label>
            <select class="form-select oyo-select js-state-filter" data-city-target="hotelCitySelect" required>
              <option value="">Select state</option>
              {% for s in states %}
              <option value="{{ s.id }}">{{ s.state_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <label class="oyo-label">City</label>
            <select name="city_id" id="hotelCitySelect" class="form-select oyo-select" required disabled>
              <option value="">Select city</option>
              {% for c in cities %}
              <option value="{{ c.id }}" data-state-id="{{ c.state_id }}">{{ c.city_name }} ({{ c.state_name }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <label class="oyo-label">Starting Price</label>
            <input type="number" step="0.01" name="base_price" class="form-control oyo-input" required>
          </div>
          <div class="col-md-3">
            <label class="oyo-label">Hotel Status</label>
            <select name="listing_status" class="form-select oyo-select">
              <option value="active" selected>Active</option>
              <option value="inactive">Inactive</option>
              <option value="maintenance">Maintenance</option>
            </select>
          </div>

          <div class="col-12 mt-2">
            <div class="oyo-section-title"><span class="dot"></span> Address & Geo Details</div>
          </div>
          <div class="col-md-6">
            <label class="oyo-label">Address Line 1</label>
            <input type="text" name="address_line1" class="form-control oyo-input" required>
          </div>
          <div class="col-md-6">
            <label class="oyo-label">Address Line 2</label>
            <input type="text" name="address_line2" class="form-control oyo-input">
          </div>

          <div class="col-md-4">
            <label class="oyo-label">Locality</label>
            <input type="text" name="locality" class="form-control oyo-input">
          </div>
          <div class="col-md-4">
            <label class="oyo-label">Landmark</label>
            <input type="text" name="landmark" class="form-control oyo-input">
          </div>
          <div class="col-md-4">
            <label class="oyo-label">Pincode</label>
            <input type="text" name="pincode" class="form-control oyo-input">
          </div>

          <div class="col-md-2">
            <label class="oyo-label">Check-In</label>
            <input type="time" name="check_in_time" class="form-control oyo-input">
          </div>
          <div class="col-md-2">
            <label class="oyo-label">Check-Out</label>
            <input type="time" name="check_out_time" class="form-control oyo-input">
          </div>
          <div class="col-md-4">
            <label class="oyo-label">Latitude</label>
            <input type="text" id="hotelLatitudeInput" name="latitude" class="form-control oyo-input" placeholder="23.0225">
          </div>
          <div class="col-md-4">
            <label class="oyo-label">Longitude</label>
            <input type="text" id="hotelLongitudeInput" name="longitude" class="form-control oyo-input" placeholder="72.5714">
          </div>
          <div class="col-12">
            <div id="hotelLocationMap" class="hotel-location-map"></div>
            <div class="small-muted mt-1">Click on map to set hotel location inside India.</div>
          </div>

          <div class="col-12 mt-2">
            <div class="oyo-section-title"><span class="dot"></span> Registration Details</div>
          </div>

          <div class="col-md-4">
            <label class="oyo-label">Owner Name</label>
            <input type="text" name="owner_name" class="form-control oyo-input" required>
          </div>
          <div class="col-md-4">
            <label class="oyo-label">Hotel Contact Phone</label>
            <input type="text" name="hotel_contact_phone" class="form-control oyo-input" placeholder="10 digit number" required>
          </div>
          <div class="col-md-4">
            <label class="oyo-label">Hotel Contact Email</label>
            <input type="email" name="hotel_contact_email" class="form-control oyo-input" placeholder="reservations@example.com">
          </div>
          <div class="col-md-4">
            <label class="oyo-label">GST Number</label>
            <input type="text" name="gst_number" class="form-control oyo-input" placeholder="GSTIN">
          </div>
          <div class="col-md-4">
            <label class="oyo-label">Trade License Number</label>
            <input type="text" name="trade_license_number" class="form-control oyo-input">
          </div>
          <div class="col-md-4">
            <label class="oyo-label">Registration Document (PDF/JPG)</label>
            <input type="file" name="registration_doc" class="form-control oyo-input" accept=".pdf,.jpg,.jpeg,.png,.webp">
          </div>

          <div class="col-12 mt-2">
            <div class="oyo-section-title"><span class="dot"></span> Services & Policies</div>
          </div>

          <div class="col-md-6">
            <label class="oyo-label">Services / Amenities</label>
            <div class="amenities-box border rounded p-2">
              {% for a in amenities %}
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="amenity_ids" value="{{ a.id }}" id="amenity{{ a.id }}">
                <label class="form-check-label" for="amenity{{ a.id }}">{{ a.amenity_name }}</label>
              </div>
              {% endfor %}
            </div>
          </div>
          <div class="col-md-6">
            <label class="oyo-label">Gallery Management</label>
            <div class="oyo-reg-box mt-3">
              <div class="title">Note</div>
              <div class="text">Hotel image upload option is removed from this page.</div>
            </div>
          </div>

          <div class="col-md-12">
            <label class="oyo-label">Hotel Description</label>
            <textarea name="hotel_description" rows="3" class="form-control oyo-textarea"></textarea>
          </div>
          <div class="col-md-12">
            <label class="oyo-label">House Rules</label>
            <textarea name="house_rules" rows="2" class="form-control oyo-textarea"></textarea>
          </div>
          <div class="col-md-12">
            <label class="oyo-label">Terms & Conditions</label>
            <textarea name="terms_conditions" rows="3" class="form-control oyo-textarea"></textarea>
          </div>

          <div class="col-md-12">
            <div class="oyo-checkbox-row">
              <div class="form-check"><input class="form-check-input" type="checkbox" name="couple_friendly" id="cf"><label class="form-check-label" for="cf">Couple Friendly</label></div>
              <div class="form-check"><input class="form-check-input" type="checkbox" name="pets_allowed" id="pa"><label class="form-check-label" for="pa">Pets Allowed</label></div>
              <div class="form-check"><input class="form-check-input" type="checkbox" name="parking_available" id="pk"><label class="form-check-label" for="pk">Parking</label></div>
              <div class="form-check"><input class="form-check-input" type="checkbox" name="breakfast_available" id="bf"><label class="form-check-label" for="bf">Breakfast</label></div>
            </div>
          </div>

          <div class="col-12">
            <button class="btn btn-danger rounded-pill px-4"><i class="bi bi-check2-circle"></i> Create Hotel Listing</button>
          </div>
        </div>
      </form>
    </div>
  </div>
      </div>
    </main>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
  (function () {
    const indiaBoundsRaw = {
      south: 6.4627,
      west: 68.1097,
      north: 37.0841,
      east: 97.3956
    };

    let hotelMap = null;
    let hotelMarker = null;

    function parseCoord(value) {
      const parsed = Number(value);
      return Number.isFinite(parsed) ? parsed : null;
    }

    function isIndiaCoord(lat, lng) {
      return lat !== null
        && lng !== null
        && lat >= indiaBoundsRaw.south
        && lat <= indiaBoundsRaw.north
        && lng >= indiaBoundsRaw.west
        && lng <= indiaBoundsRaw.east;
    }

    function setCoordinateInputs(lat, lng) {
      const latInput = document.getElementById("hotelLatitudeInput");
      const lngInput = document.getElementById("hotelLongitudeInput");
      if (!latInput || !lngInput) return;
      latInput.value = Number(lat).toFixed(6);
      lngInput.value = Number(lng).toFixed(6);
    }

    function setMarker(lat, lng, panTo = false) {
      if (!hotelMap) return;
      if (!hotelMarker) {
        hotelMarker = L.marker([lat, lng], { draggable: true }).addTo(hotelMap);
        hotelMarker.on("dragend", () => {
          const pos = hotelMarker.getLatLng();
          if (!isIndiaCoord(pos.lat, pos.lng)) return;
          setCoordinateInputs(pos.lat, pos.lng);
        });
      } else {
        hotelMarker.setLatLng([lat, lng]);
      }
      if (panTo) {
        hotelMap.panTo([lat, lng]);
      }
    }

    function syncMarkerFromInputs() {
      const latInput = document.getElementById("hotelLatitudeInput");
      const lngInput = document.getElementById("hotelLongitudeInput");
      if (!latInput || !lngInput) return;
      const lat = parseCoord(latInput.value);
      const lng = parseCoord(lngInput.value);
      if (!isIndiaCoord(lat, lng)) return;
      setMarker(lat, lng, false);
    }

    function initHotelLocationMap() {
      if (hotelMap || !window.L) return;
      const mapEl = document.getElementById("hotelLocationMap");
      if (!mapEl) return;

      const indiaBounds = L.latLngBounds(
        L.latLng(indiaBoundsRaw.south, indiaBoundsRaw.west),
        L.latLng(indiaBoundsRaw.north, indiaBoundsRaw.east)
      );
      hotelMap = L.map("hotelLocationMap", {
        maxBounds: indiaBounds,
        maxBoundsViscosity: 1.0,
        minZoom: 4
      });
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(hotelMap);
      hotelMap.fitBounds(indiaBounds, { padding: [14, 14] });
      hotelMap.on("click", (evt) => {
        const lat = Number(evt.latlng.lat);
        const lng = Number(evt.latlng.lng);
        if (!isIndiaCoord(lat, lng)) return;
        setMarker(lat, lng, true);
        setCoordinateInputs(lat, lng);
      });

      const latInput = document.getElementById("hotelLatitudeInput");
      const lngInput = document.getElementById("hotelLongitudeInput");
      if (latInput) latInput.addEventListener("input", syncMarkerFromInputs);
      if (lngInput) lngInput.addEventListener("input", syncMarkerFromInputs);

      syncMarkerFromInputs();
      hotelMap.invalidateSize();
    }

    function syncCityOptions(stateSelect) {
      const citySelect = document.getElementById(stateSelect.dataset.cityTarget || "");
      if (!citySelect) return;
      const stateId = (stateSelect.value || "").trim();
      citySelect.querySelectorAll("option[data-state-id]").forEach((opt) => {
        const visible = !!stateId && String(opt.dataset.stateId) === String(stateId);
        opt.hidden = !visible;
        opt.disabled = !visible;
        opt.style.display = visible ? "" : "none";
      });
      if (!stateId) {
        citySelect.value = "";
        citySelect.disabled = true;
        return;
      }
      citySelect.disabled = false;
      const selected = citySelect.options[citySelect.selectedIndex];
      if (selected && selected.value && (selected.disabled || String(selected.dataset.stateId || "") !== stateId)) {
        citySelect.value = "";
      }
    }

    document.querySelectorAll(".js-state-filter[data-city-target]").forEach((stateSelect) => {
      stateSelect.addEventListener("change", () => syncCityOptions(stateSelect));
      syncCityOptions(stateSelect);
    });

    initHotelLocationMap();
  })();
</script>
{% endblock %}
