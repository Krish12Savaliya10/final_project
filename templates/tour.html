{% extends "layout.html" %}
{% block title %}TourGen | All Destinations{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/tour.css') }}">
{% endblock %}

{% block content %}

<div class="container">

    <div class="search-container text-center mb-5">
        <h1 class="fw-bold mb-3">Explore All Tour Packages</h1>
        <p class="text-muted mb-4">Find your perfect journey across India</p>

        <form method="GET" action="{{ url_for('tour') }}" class="col-lg-10 mx-auto" id="tourFilterForm">
            <div class="input-group">
                <input type="text" name="search" value="{{ search }}"
                       class="form-control custom-search"
                       placeholder="Search title, location, destination or state...">
                <button class="btn btn-primary px-4 rounded-end" type="submit">
                    <i class="bi bi-search"></i>
                </button>
            </div>
            {% if date_filter_error %}
            <div class="alert alert-warning py-2 mt-2 mb-0">{{ date_filter_error }}</div>
            {% endif %}

            <div class="row g-2 mt-2">
                <div class="col-md-3">
                    <select name="state_id" id="tourStateFilter" class="form-select">
                        <option value="">All States</option>
                        {% for s in states %}
                        <option value="{{ s.id }}" {% if state_id == s.id %}selected{% endif %}>{{ s.state_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <select name="city_id" id="tourCityFilter" class="form-select" {% if not state_id and not city_id %}disabled{% endif %}>
                        <option value="">Any City (Pickup / Drop)</option>
                        {% for c in cities %}
                        <option value="{{ c.id }}" data-state-id="{{ c.state_id }}" {% if city_id == c.id %}selected{% endif %}>
                            {{ c.city_name }} ({{ c.state_name }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <select name="departure_city_id" id="tourDepartureCityFilter" class="form-select">
                        <option value="">Departure City</option>
                        {% for c in cities %}
                        <option value="{{ c.id }}" {% if departure_city_id == c.id %}selected{% endif %}>
                            {{ c.city_name }} ({{ c.state_name }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <select name="destination_city_id" id="tourDestinationCityFilter" class="form-select">
                        <option value="">Destination City</option>
                        {% for c in cities %}
                        <option value="{{ c.id }}" {% if destination_city_id == c.id %}selected{% endif %}>
                            {{ c.city_name }} ({{ c.state_name }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="row g-2 mt-2">
                <div class="col-md-3">
                    <input type="number" name="min_price" value="{{ min_price }}" min="0" step="0.01" class="form-control" placeholder="Min Price">
                </div>
                <div class="col-md-3">
                    <input type="number" name="max_price" value="{{ max_price }}" min="0" step="0.01" class="form-control" placeholder="Max Price">
                </div>
                <div class="col-md-3">
                    <input type="date" name="start_date" id="tourStartDateFilter" value="{{ start_date }}" class="form-control" placeholder="Start Date">
                </div>
                <div class="col-md-3">
                    <input type="date" name="end_date" id="tourEndDateFilter" value="{{ end_date }}" class="form-control" placeholder="End Date">
                </div>
            </div>

            <div class="row g-2 mt-2">
                <div class="col-md-6">
                    <input type="number" name="group_members" value="{{ group_members if group_members > 0 else '' }}" min="1" class="form-control" placeholder="Group Members">
                </div>
                <div class="col-md-6">
                    <select name="sort_by" class="form-select">
                        <option value="latest" {% if sort_by == 'latest' %}selected{% endif %}>Sort: Latest</option>
                        <option value="date_soon" {% if sort_by == 'date_soon' %}selected{% endif %}>Date: Nearest First</option>
                        <option value="price_low" {% if sort_by == 'price_low' %}selected{% endif %}>Price: Low to High</option>
                        <option value="price_high" {% if sort_by == 'price_high' %}selected{% endif %}>Price: High to Low</option>
                        <option value="group_small" {% if sort_by == 'group_small' %}selected{% endif %}>Group: Smaller First</option>
                        <option value="group_large" {% if sort_by == 'group_large' %}selected{% endif %}>Group: Larger First</option>
                    </select>
                </div>
            </div>

            <div class="d-flex flex-wrap gap-2 mt-2 justify-content-center">
                <button class="btn btn-primary px-4" type="submit">Apply Filters</button>
                <a class="btn btn-outline-secondary px-4" href="{{ url_for('tour') }}">Reset</a>
            </div>
        </form>
    </div>

    <div class="row row-cols-1 row-cols-md-3 g-5 pb-5">

        {% if tours %}
            {% for tour in tours %}
            <div class="col">
                <div class="card h-100 tour-card">

                    <img src="{{ url_for('static', filename='uploads/' + (tour.image_path or 'demo.jpg')) }}"
                         class="card-img-top" alt="{{ tour.title }}">

                    <div class="card-body d-flex flex-column">

                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h4 class="mb-0">{{ tour.title }}</h4>
                            <span class="badge bg-light text-dark border small">
                                {{ tour.departure_datetime or tour.start_date or '-' }}
                            </span>
                        </div>

                        <p class="text-primary small fw-bold mb-2">
                            <i class="bi bi-geo-alt"></i>
                            {{ tour.start_point }} ➔ {{ tour.end_point }}
                        </p>

                        <p class="text-muted small flex-grow-1">
                            {{ (tour.description or '')[:90] }}{% if tour.description and tour.description|length > 90 %}...{% endif %}
                        </p>

                        <div class="tour-points mb-3">
                            <div class="small"><span class="text-muted">Departure:</span> <span class="fw-semibold">{{ tour.pickup_city_name or tour.start_point }}{% if tour.pickup_state_name %}, {{ tour.pickup_state_name }}{% endif %}</span></div>
                            <div class="small"><span class="text-muted">Destination:</span> <span class="fw-semibold">{{ tour.drop_city_name or tour.end_point }}{% if tour.drop_state_name %}, {{ tour.drop_state_name }}{% endif %}</span></div>
                            <div class="small">
                                <span class="text-muted">Group:</span>
                                <span class="fw-semibold">
                                    Min {{ tour.min_group_size or 1 }}{% if tour.max_group_size %} • Max {{ tour.max_group_size }}{% else %} • Flexible{% endif %}
                                </span>
                            </div>
                        </div>

                        <div class="d-flex flex-wrap gap-2 mb-3">
                            {% if tour.travel_mode %}
                            <span class="badge bg-light text-primary border">Vehicle: {{ tour.travel_mode }}</span>
                            {% endif %}
                            {% if tour.food_plan %}
                            <span class="badge bg-light text-success border">Meals: {{ tour.food_plan }}</span>
                            {% endif %}
                            {% if tour.linked_hotels_count %}
                            <span class="badge bg-warning text-dark">Stay Included</span>
                            {% endif %}
                            {% if tour.linked_guides_count %}
                            <span class="badge bg-secondary">Guides: {{ tour.linked_guides_count }}</span>
                            {% endif %}
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">

                            <div class="price-box">
                                <small class="text-muted d-block">Starting at</small>
                                <span class="h5 fw-bold mb-0">₹{{ tour.price }}</span>
                            </div>

                            <a href="{{ url_for('booking', tour_id=tour.id) }}" class="btn join-btn">
                                View Full Details
                            </a>

                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}

        {% else %}
            <div class="col-12 text-center py-5">
                <i class="bi bi-search display-1 text-muted"></i>
                <h4 class="mt-3 text-muted">No tours found</h4>
                <a href="{{ url_for('tour') }}" class="btn btn-link">Show all tours</a>
            </div>
        {% endif %}

    </div>

</div>

<script>
function updateTourCityFilter(){
const stateSelect = document.getElementById('tourStateFilter');
const citySelect = document.getElementById('tourCityFilter');
if(!stateSelect || !citySelect) return;

let stateId = stateSelect.value || '';
if(!stateId && citySelect.value){
const selected = citySelect.querySelector(`option[value="${citySelect.value}"]`);
if(selected && selected.dataset.stateId){
stateId = selected.dataset.stateId;
stateSelect.value = stateId;
}
}

const hasState = !!stateId;
citySelect.querySelectorAll('option[data-state-id]').forEach((opt) => {
const visible = hasState && opt.dataset.stateId === stateId;
opt.hidden = !visible;
opt.disabled = !visible;
opt.style.display = visible ? '' : 'none';
});
citySelect.disabled = !hasState;
if(!hasState){
citySelect.value = '';
return;
}
if(citySelect.value){
const selected = citySelect.querySelector(`option[value="${citySelect.value}"]`);
if(selected && (selected.hidden || selected.disabled)){
citySelect.value = '';
}
}
}

function updateTourDateBounds(){
const startDateInput = document.getElementById('tourStartDateFilter');
const endDateInput = document.getElementById('tourEndDateFilter');
if(!startDateInput || !endDateInput) return;
endDateInput.min = startDateInput.value || '';
startDateInput.max = endDateInput.value || '';
}

function validateTourDateRange(event){
const startDateInput = document.getElementById('tourStartDateFilter');
const endDateInput = document.getElementById('tourEndDateFilter');
if(!startDateInput || !endDateInput) return true;

endDateInput.setCustomValidity('');
if(startDateInput.value && endDateInput.value && startDateInput.value > endDateInput.value){
endDateInput.setCustomValidity('End date must be on or after start date.');
if(event){
event.preventDefault();
}
endDateInput.reportValidity();
return false;
}
return true;
}

document.addEventListener('DOMContentLoaded', function(){
const stateFilter = document.getElementById('tourStateFilter');
const startDateInput = document.getElementById('tourStartDateFilter');
const endDateInput = document.getElementById('tourEndDateFilter');
const filterForm = document.getElementById('tourFilterForm');
if(stateFilter){
stateFilter.addEventListener('change', updateTourCityFilter);
}
if(startDateInput){
startDateInput.addEventListener('change', function(){
updateTourDateBounds();
validateTourDateRange();
});
}
if(endDateInput){
endDateInput.addEventListener('change', function(){
updateTourDateBounds();
validateTourDateRange();
});
}
if(filterForm){
filterForm.addEventListener('submit', validateTourDateRange);
}
updateTourCityFilter();
updateTourDateBounds();
validateTourDateRange();
});
</script>

{% endblock %}
