{% extends "layout.html" %}
{% block title %}TourGen | All Destinations{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/tour.css') }}">
{% endblock %}

{% block content %}

<div class="container">

    <div class="search-container text-center mb-5">
        <h1 class="fw-bold mb-3">Explore All Tour Packages</h1>
        <p class="text-muted mb-4">Find your perfect journey across India</p>

        <form method="GET" action="{{ url_for('tour') }}" class="col-md-7 mx-auto">
            <div class="input-group">
                <input type="text" name="search" value="{{ search }}"
                       class="form-control custom-search"
                       placeholder="Search destination, city or state...">
                <button class="btn btn-primary px-4 rounded-end" type="submit">
                    <i class="bi bi-search"></i>
                </button>
            </div>
            <div class="row g-2 mt-2">
                <div class="col-md-6">
                    <select name="state_id" id="tourStateFilter" class="form-select">
                        <option value="">All States</option>
                        {% for s in states %}
                        <option value="{{ s.id }}" {% if state_id == s.id %}selected{% endif %}>{{ s.state_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <select name="city_id" id="tourCityFilter" class="form-select" {% if not state_id and not city_id %}disabled{% endif %}>
                        <option value="">All Cities</option>
                        {% for c in cities %}
                        <option value="{{ c.id }}" data-state-id="{{ c.state_id }}" {% if city_id == c.id %}selected{% endif %}>
                            {{ c.city_name }} ({{ c.state_name }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </form>
    </div>

    <div class="row row-cols-1 row-cols-md-3 g-5 pb-5">

        {% if tours %}
            {% for tour in tours %}
            <div class="col">
                <div class="card h-100 tour-card">

                    <img src="{{ url_for('static', filename='uploads/' + (tour.image_path or 'demo.jpg')) }}"
                         class="card-img-top"
                         onerror="this.onerror=null;this.src='{{ url_for('static', filename='uploads/demo.jpg') }}';">

                    <div class="card-body d-flex flex-column">

                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h4 class="mb-0">{{ tour.title }}</h4>
                            <span class="badge bg-light text-dark border small">
                                {{ tour.start_date }}
                            </span>
                        </div>

                        <p class="text-primary small fw-bold mb-2">
                            <i class="bi bi-geo-alt"></i>
                            {{ tour.start_point }} ➔ {{ tour.end_point }}
                        </p>

                        <p class="text-muted small flex-grow-1">
                            {{ (tour.description or '')[:90] }}{% if tour.description and tour.description|length > 90 %}...{% endif %}
                        </p>

                        <div class="tour-points mb-3">
                            <div class="small"><span class="text-muted">Departure:</span> <span class="fw-semibold">{{ tour.pickup_city_name or tour.start_point }}{% if tour.pickup_state_name %}, {{ tour.pickup_state_name }}{% endif %}</span></div>
                            <div class="small"><span class="text-muted">Destination:</span> <span class="fw-semibold">{{ tour.drop_city_name or tour.end_point }}{% if tour.drop_state_name %}, {{ tour.drop_state_name }}{% endif %}</span></div>
                        </div>

                        <div class="d-flex flex-wrap gap-2 mb-3">
                            {% if tour.travel_mode %}
                            <span class="badge bg-light text-primary border">Travel: {{ tour.travel_mode }}</span>
                            {% endif %}
                            {% if tour.food_plan %}
                            <span class="badge bg-light text-success border">Meals: {{ tour.food_plan }}</span>
                            {% endif %}
                            {% if tour.linked_hotels_count %}
                            <span class="badge bg-warning text-dark">Stay Included</span>
                            {% endif %}
                            {% if tour.linked_guides_count %}
                            <span class="badge bg-secondary">Guides: {{ tour.linked_guides_count }}</span>
                            {% endif %}
                        </div>
                        {% if tour.transport_details %}
                        <div class="small text-muted mb-2"><span class="fw-semibold">Transport Details:</span> {{ tour.transport_details }}</div>
                        {% endif %}
                        {% if tour.transport_vehicle_image %}
                        {% set tr_img = tour.transport_vehicle_image if tour.transport_vehicle_image.startswith('http://') or tour.transport_vehicle_image.startswith('https://') else url_for('static', filename='uploads/' ~ tour.transport_vehicle_image) %}
                        <img src="{{ tr_img }}"
                             class="img-fluid rounded border mb-2"
                             style="height:72px; width:100%; object-fit:cover;"
                             alt="Transport vehicle"
                             onerror="this.onerror=null;this.src='{{ url_for('static', filename='uploads/demo.jpg') }}';">
                        {% endif %}

                        <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">

                            <div class="price-box">
                                <small class="text-muted d-block">Starting at</small>
                                <span class="h5 fw-bold mb-0">₹{{ tour.price }}</span>
                            </div>

                            <a href="{{ url_for('booking', tour_id=tour.id) }}" class="btn join-btn">
                                View Full Details
                            </a>

                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}

        {% else %}
            <div class="col-12 text-center py-5">
                <i class="bi bi-search display-1 text-muted"></i>
                <h4 class="mt-3 text-muted">No tours found</h4>
                <a href="{{ url_for('tour') }}" class="btn btn-link">Show all tours</a>
            </div>
        {% endif %}

    </div>

</div>

<script>
function updateTourCityFilter(){
const stateSelect = document.getElementById('tourStateFilter');
const citySelect = document.getElementById('tourCityFilter');
if(!stateSelect || !citySelect) return;

let stateId = stateSelect.value || '';
if(!stateId && citySelect.value){
const selected = citySelect.querySelector(`option[value="${citySelect.value}"]`);
if(selected && selected.dataset.stateId){
stateId = selected.dataset.stateId;
stateSelect.value = stateId;
}
}

const hasState = !!stateId;
citySelect.querySelectorAll('option[data-state-id]').forEach((opt) => {
const visible = hasState && opt.dataset.stateId === stateId;
opt.hidden = !visible;
opt.disabled = !visible;
opt.style.display = visible ? '' : 'none';
});
citySelect.disabled = !hasState;
if(!hasState){
citySelect.value = '';
return;
}
if(citySelect.value){
const selected = citySelect.querySelector(`option[value="${citySelect.value}"]`);
if(selected && (selected.hidden || selected.disabled)){
citySelect.value = '';
}
}
}

document.addEventListener('DOMContentLoaded', function(){
const stateFilter = document.getElementById('tourStateFilter');
if(stateFilter){
stateFilter.addEventListener('change', updateTourCityFilter);
}
updateTourCityFilter();
});
</script>

{% endblock %}
