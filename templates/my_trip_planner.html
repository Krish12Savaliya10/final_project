{% extends "layout.html" %}

{% block title %}My Trip Planner{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="fw-bold mb-0">Plan My Trip (Self Organized)</h2>
  </div>

  {% with messages = get_flashed_messages() %}
  {% if messages %}
  <div class="alert alert-info">{{ messages[0] }}</div>
  {% endif %}
  {% endwith %}

  <div class="card shadow-sm mb-4">
    <div class="card-body border-bottom">
      <h5 class="fw-bold mb-3">Smart Ideal Tour Generator</h5>
      <form method="POST" class="row g-3">
        <input type="hidden" name="action" value="generate_ideal_plan">
        <div class="col-md-3">
          <label class="form-label">Departure State</label>
          <select id="plannerDepartureStateFilter" class="form-select">
            <option value="">Select state</option>
            {% for s in states %}
            <option value="{{ s.id }}">{{ s.state_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Departure City</label>
          <select name="departure_city_id" id="plannerDepartureCityFilter" class="form-select" disabled>
            <option value="">Select departure</option>
            {% for c in cities %}
            <option value="{{ c.id }}" data-state-id="{{ c.state_id }}">{{ c.city_name }} ({{ c.state_name }})</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Destination State</label>
          <select id="plannerDestinationStateFilter" class="form-select" required>
            <option value="">Select state</option>
            {% for s in states %}
            <option value="{{ s.id }}">{{ s.state_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Destination City</label>
          <select name="destination_city_id" id="plannerDestinationCityFilter" class="form-select" required disabled>
            <option value="">Select destination</option>
            {% for c in cities %}
            <option value="{{ c.id }}" data-state-id="{{ c.state_id }}">{{ c.city_name }} ({{ c.state_name }})</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Duration (Days)</label>
          <input type="number" name="duration_days" class="form-control" min="1" max="15" value="3" required>
        </div>
        <div class="col-md-2">
          <label class="form-label">Program</label>
          <select name="program_mode" class="form-select">
            <option value="relaxed">Relaxed</option>
            <option value="balanced" selected>Balanced</option>
            <option value="intensive">Intensive</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Spots / Day</label>
          <input type="number" name="spots_per_day" class="form-control" min="1" max="6" placeholder="Auto">
        </div>
        <div class="col-md-2">
          <label class="form-label">Budget (Optional)</label>
          <input type="number" name="budget" class="form-control" min="0" step="0.01" placeholder="15000">
        </div>
        <div class="col-12">
          <button class="btn btn-primary">Generate Ideal Plan</button>
        </div>
      </form>
    </div>
    <div class="card-body">
      <h5 class="fw-bold mb-3">{% if edit_plan %}Edit Plan{% else %}Create New Plan{% endif %}</h5>
      <form method="POST">
        <input type="hidden" name="action" value="{% if edit_plan %}update_plan{% else %}create_plan{% endif %}">
        {% if edit_plan %}
        <input type="hidden" name="plan_id" value="{{ edit_plan.id }}">
        {% endif %}
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Plan Title</label>
            <input type="text" name="plan_title" class="form-control" placeholder="My Kerala 5-Day Plan" value="{{ edit_plan.plan_title if edit_plan else '' }}" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Primary State (Optional)</label>
            <select id="plannerPrimaryStateFilter" class="form-select">
              <option value="">Select state</option>
              {% for s in states %}
              <option value="{{ s.id }}">{{ s.state_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Primary City (Optional)</label>
            <select name="city_id" id="plannerPrimaryCityFilter" class="form-select" {% if not (edit_plan and edit_plan.city_id) %}disabled{% endif %}>
              <option value="">Select city</option>
              {% for c in cities %}
              <option value="{{ c.id }}" data-state-id="{{ c.state_id }}" {% if edit_plan and edit_plan.city_id == c.id %}selected{% endif %}>{{ c.state_name }} -> {{ c.city_name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">Attach Hotel (Optional)</label>
            <select name="hotel_service_id" class="form-select">
              <option value="">Select hotel</option>
              {% for h in hotel_options %}
              <option value="{{ h.id }}" {% if edit_plan and edit_plan.hotel_service_id == h.id %}selected{% endif %}>{{ h.service_name }} ({{ h.city_name or '-' }}, {{ h.state_name or '-' }})</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">Start Date</label>
            <input type="date" name="start_date" class="form-control" value="{{ edit_plan.start_date if edit_plan and edit_plan.start_date else '' }}">
          </div>
          <div class="col-md-6">
            <label class="form-label">End Date</label>
            <input type="date" name="end_date" class="form-control" value="{{ edit_plan.end_date if edit_plan and edit_plan.end_date else '' }}">
          </div>

          <div class="col-12">
            <label class="form-label">Notes</label>
            <textarea name="notes" class="form-control" rows="2" placeholder="Budget, food plan, special preferences...">{{ edit_plan.notes if edit_plan and edit_plan.notes else '' }}</textarea>
          </div>
        </div>

        <hr class="my-4">

        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="fw-bold mb-0">Day-wise Spot Selection (Manual)</h6>
          <button type="button" class="btn btn-outline-primary btn-sm" onclick="addPlannerRow()">+ Add Spot</button>
        </div>
        <div class="small text-muted mb-2">Add spots with day number (Day 1, Day 2, etc.) for your custom schedule.</div>

        <div id="plannerRows" class="d-grid gap-2"></div>

        <div class="mt-4">
          <button class="btn btn-success">{% if edit_plan %}Update Plan{% else %}Save Plan{% endif %}</button>
          {% if edit_plan %}
          <a href="{{ url_for('my_trip_planner') }}" class="btn btn-outline-secondary">Cancel Edit</a>
          {% endif %}
        </div>
      </form>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="fw-bold mb-3">My Saved Plans</h5>
      {% if plans %}
        {% for p in plans %}
        <div class="border rounded p-3 mb-3">
          <div class="d-flex flex-wrap justify-content-between align-items-start gap-2 mb-2">
            <div>
              <div class="fw-bold">{{ p.plan_title }}</div>
              <div class="small text-muted">
                {% if p.city_name %}{{ p.city_name }}{% if p.state_name %}, {{ p.state_name }}{% endif %}{% else %}Multi-city{% endif %}
                {% if p.start_date %} | {{ p.start_date }}{% endif %}
                {% if p.end_date %} to {{ p.end_date }}{% endif %}
                | Spots: {{ p.total_items or 0 }}
              </div>
              {% if p.hotel_service_name %}
              <div class="small">
                <span class="badge bg-light text-dark border me-1">Hotel: {{ p.hotel_service_name }}</span>
              </div>
              {% endif %}
            </div>
            <div class="d-flex gap-2">
              <a class="btn btn-sm btn-outline-primary" href="{{ url_for('my_trip_planner', edit_plan_id=p.id) }}">Edit</a>
              <a class="btn btn-sm btn-outline-dark" href="{{ url_for('my_trip_planner_export', plan_id=p.id) }}" target="_blank">Export PDF</a>
              <form method="POST" onsubmit="return confirm('Delete this plan?');">
                <input type="hidden" name="action" value="delete_plan">
                <input type="hidden" name="plan_id" value="{{ p.id }}">
                <button class="btn btn-sm btn-outline-danger">Delete</button>
              </form>
            </div>
          </div>
          {% if p.notes %}
          <div class="small mb-2"><strong>Notes:</strong> {{ p.notes }}</div>
          {% endif %}
          {% set items = items_by_plan.get(p.id, []) %}
          {% if items %}
          <div class="row g-2">
            {% for it in items %}
            <div class="col-md-6 col-lg-4">
              <div class="card h-100">
                {% if it.photo_source == 'external_url' %}
                <img src="{{ it.image_url }}" class="card-img-top" style="height:130px;object-fit:cover;"
                     onerror="this.onerror=null;this.src='{{ url_for('static', filename='uploads/demo.jpg') }}';"
                     alt="{{ it.spot_name }}">
                {% else %}
                <img src="{{ url_for('static', filename='uploads/' + (it.image_url or 'demo.jpg')) }}" class="card-img-top" style="height:130px;object-fit:cover;"
                     onerror="this.onerror=null;this.src='{{ url_for('static', filename='uploads/demo.jpg') }}';"
                     alt="{{ it.spot_name }}">
                {% endif %}
                <div class="card-body p-2">
                  <div class="small text-muted">Day {{ it.day_number }}</div>
                  <div class="fw-semibold">{{ it.spot_name }}</div>
                  <div class="small text-muted">{{ it.city_name }}, {{ it.state_name }}</div>
                  {% if it.note %}<div class="small mt-1">{{ it.note }}</div>{% endif %}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% endif %}
        </div>
        {% endfor %}
      {% else %}
      <div class="alert alert-light border mb-0">No self trip plans yet. Create your first one above.</div>
      {% endif %}
    </div>
  </div>
</div>

<script id="planner-spots-json" type="application/json">{{ spots|tojson }}</script>
<script id="planner-edit-items-json" type="application/json">{{ edit_items|tojson }}</script>
<script>
function initStateCityPair(stateSelectId, citySelectId) {
  const stateSelect = document.getElementById(stateSelectId);
  const citySelect = document.getElementById(citySelectId);
  if (!stateSelect || !citySelect) return;

  const sync = () => {
    const stateId = (stateSelect.value || "").trim();
    citySelect.querySelectorAll("option[data-state-id]").forEach((opt) => {
      const visible = !!stateId && String(opt.dataset.stateId) === stateId;
      opt.hidden = !visible;
      opt.disabled = !visible;
      opt.style.display = visible ? "" : "none";
    });
    if (!stateId) {
      citySelect.value = "";
      citySelect.disabled = true;
      return;
    }
    citySelect.disabled = false;
    const selectedOption = citySelect.options[citySelect.selectedIndex];
    if (selectedOption && selectedOption.value && (selectedOption.disabled || String(selectedOption.dataset.stateId || "") !== stateId)) {
      citySelect.value = "";
    }
  };

  const selectedOption = citySelect.options[citySelect.selectedIndex];
  if (selectedOption && selectedOption.dataset.stateId && !stateSelect.value) {
    stateSelect.value = selectedOption.dataset.stateId;
  }

  stateSelect.addEventListener("change", sync);
  sync();
}

initStateCityPair("plannerDepartureStateFilter", "plannerDepartureCityFilter");
initStateCityPair("plannerDestinationStateFilter", "plannerDestinationCityFilter");
initStateCityPair("plannerPrimaryStateFilter", "plannerPrimaryCityFilter");

const plannerSpots = JSON.parse(document.getElementById('planner-spots-json').textContent || '[]');
const plannerEditItems = JSON.parse(document.getElementById('planner-edit-items-json').textContent || '[]');

function buildSpotOptions() {
  const opts = ['<option value=\"\">Select spot</option>'];
  plannerSpots.forEach((s) => {
    const label = `${s.spot_name} (${s.city_name}, ${s.state_name})`;
    opts.push(`<option value=\"${s.id}\">${label}</option>`);
  });
  return opts.join('');
}

function addPlannerRow(prefill = null) {
  const wrap = document.getElementById('plannerRows');
  const row = document.createElement('div');
  row.className = 'row g-2 align-items-center border rounded p-2';
  row.innerHTML = `
    <div class=\"col-md-2\">
      <input type=\"number\" name=\"day_numbers[]\" class=\"form-control\" min=\"1\" value=\"${prefill?.day_number || 1}\" required>
    </div>
    <div class=\"col-md-6\">
      <select name=\"spot_ids[]\" class=\"form-select\" required>
        ${buildSpotOptions()}
      </select>
    </div>
    <div class=\"col-md-3\">
      <input type=\"text\" name=\"item_notes[]\" class=\"form-control\" placeholder=\"Note (optional)\" value=\"${prefill?.note || ''}\">
    </div>
    <div class=\"col-md-1 d-grid\">
      <button type=\"button\" class=\"btn btn-outline-danger\" onclick=\"this.closest('.row').remove()\">X</button>
    </div>
  `;
  const sel = row.querySelector('select[name=\"spot_ids[]\"]');
  if (prefill?.spot_id) sel.value = String(prefill.spot_id);
  wrap.appendChild(row);
}

if (plannerEditItems.length) {
  plannerEditItems.forEach((it) => addPlannerRow(it));
} else {
  addPlannerRow();
}
</script>
{% endblock %}
