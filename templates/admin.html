<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TourGen Organizer Panel</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/role_dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
</head>

<body class="dashboard-shell organizer-dashboard">

<div class="admin-topbar dashboard-topbar">
    <div class="container-fluid d-flex justify-content-between align-items-center gap-2">
        <div class="dashboard-brand">
            <i class="bi bi-compass"></i> TourGen {{ panel_title or 'Organizer Panel' }}
        </div>

        <div class="d-flex align-items-center topbar-actions">
            <div class="dropdown me-2">
                <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-person-circle"></i> Profile
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
                    <li class="px-3 py-2 profile-summary">
                        <div class="small text-muted">Signed in as</div>
                        <div class="fw-semibold">{{ session.get('username', 'Organizer') }}</div>
                        <div class="small text-uppercase text-muted">{{ session.get('role', 'organizer') }}</div>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <button class="dropdown-item" type="button" data-bs-toggle="modal" data-bs-target="#profileModal">
                            <i class="bi bi-person-lines-fill me-1"></i> View Profile
                        </button>
                    </li>
                    <li>
                        <button class="dropdown-item" type="button" data-theme-toggle>
                            <i class="bi bi-moon-stars me-1"></i> <span data-theme-label>Dark Mode</span>
                        </button>
                    </li>
                </ul>
            </div>
            <a href="{{ url_for('home') }}" class="btn btn-outline-light btn-sm me-2">
                <i class="bi bi-globe"></i> View Public Website
            </a>
            <a href="{{ url_for('logout') }}" class="btn btn-danger btn-sm">
                Logout
            </a>
        </div>
    </div>
</div>

<div class="container py-4 dashboard-page">
<div class="admin-layout">
<aside class="admin-sidebar">
    <button class="sidebar-link active" data-section="tours" onclick="showSection('tours')">
        <i class="bi bi-briefcase me-2"></i>Manage Tours
    </button>
    <button class="sidebar-link" data-section="library" onclick="showSection('library')">
        <i class="bi bi-geo-alt me-2"></i>Places Library
    </button>
    <button class="sidebar-link" data-section="analytics" onclick="showSection('analytics')">
        <i class="bi bi-graph-up-arrow me-2"></i>Analytics
    </button>
</aside>

<main class="admin-main">

<div id="tours" class="section-pane">

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="fw-bold">Active Tour Packages</h3>
    <button class="btn btn-success rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#tourModal">
        <i class="bi bi-plus-lg"></i> Create Tour
    </button>
</div>

{% with messages = get_flashed_messages() %}
{% if messages %}
<div class="alert alert-info">{{ messages[0] }}</div>
{% endif %}
{% endwith %}

<div class="row g-4">
{% for tour in tours %}
<div class="col-md-4">
<div class="card shadow-sm h-100 tour-card">
	
{% set tour_image_src = url_for('static', filename='uploads/' + (tour.image_path or 'demo.jpg')) %}
<a href="{{ tour_image_src }}" target="_blank" rel="noopener" class="tour-photo-link" title="Open full image">
<img src="{{ tour_image_src }}"
     class="tour-card-img"
     onerror="this.onerror=null;this.src='{{ url_for('static', filename='uploads/demo.jpg') }}';">
</a>
	
<div class="card-body">
<h5 class="fw-bold">{{ tour.title }}</h5>
<p class="text-muted small">{{ tour.start_point }} ➜ {{ tour.end_point }}</p>
<div class="small mb-1"><span class="text-muted">Departure City:</span> <span class="fw-semibold">{{ tour.pickup_city_name or '-' }}{% if tour.pickup_state_name %}, {{ tour.pickup_state_name }}{% endif %}</span></div>
<div class="small mb-2"><span class="text-muted">Destination City:</span> <span class="fw-semibold">{{ tour.drop_city_name or '-' }}{% if tour.drop_state_name %}, {{ tour.drop_state_name }}{% endif %}</span></div>

<div class="d-flex justify-content-between align-items-center">
<span class="text-primary fw-bold">₹{{ tour.price }}</span>
<span class="badge bg-light text-dark border">{{ tour.departure_datetime or tour.start_date or '-' }}</span>
</div>
<div class="small mt-2">
Seats: {{ tour.booked_pax or 0 }}{% if tour.max_group_size %} / {{ tour.max_group_size }}{% endif %}
</div>
<div class="small">
Bookings: {{ tour.total_booking_count or 0 }} (App {{ tour.internal_booking_count or 0 }}, External {{ tour.external_booking_count or 0 }})
</div>
<div class="small">
Booked Pax: {{ tour.total_pax_count or 0 }} (App {{ tour.internal_pax or 0 }}, External {{ tour.external_pax or 0 }})
</div>
<div class="small">
Tour Start Message: Minimum {{ tour.min_group_size or 6 }} people
</div>
<div class="small">
Profit: ₹{{ '%.2f'|format((tour.organizer_profit or 0)|float) }}
</div>
<div class="small mb-2">
Status:
{% set is_full = (tour.max_group_size and (tour.booked_pax or 0) >= tour.max_group_size) or (tour.tour_status == 'full') %}
<span class="badge {% if is_full %}bg-danger{% elif tour.tour_status == 'closed' %}bg-secondary{% else %}bg-success{% endif %}">
{{ 'full' if is_full else (tour.tour_status or 'open') }}
</span>
</div>
<form method="POST" class="d-flex gap-2">
<input type="hidden" name="action" value="update_tour_status">
<input type="hidden" name="tour_id" value="{{ tour.id }}">
<select name="tour_status" class="form-select form-select-sm">
<option value="open" {% if (tour.tour_status or 'open') == 'open' %}selected{% endif %}>Open</option>
<option value="full" {% if tour.tour_status == 'full' %}selected{% endif %}>Full</option>
<option value="closed" {% if tour.tour_status == 'closed' %}selected{% endif %}>Closed</option>
</select>
<button class="btn btn-sm btn-outline-primary" type="submit">Update</button>
</form>
<form method="POST" enctype="multipart/form-data" class="mt-2">
<input type="hidden" name="action" value="update_tour_image">
<input type="hidden" name="tour_id" value="{{ tour.id }}">
<label class="form-label small fw-semibold mb-1">Change Tour Image</label>
<div class="d-flex gap-2">
<input type="file" name="tour_image" class="form-control form-control-sm" accept="image/*" required>
<button class="btn btn-sm btn-outline-success" type="submit">Upload</button>
</div>
</form>

</div>
</div>
</div>
{% endfor %}
</div>

<div class="card p-3 shadow-sm mt-4">
  <h5 class="fw-bold mb-3">Tour-wise Booking Summary</h5>
  {% if tour_booking_summaries %}
  <div class="table-responsive">
    <table class="table table-sm align-middle mb-0">
      <thead>
        <tr>
          <th>Tour</th>
          <th>City Route</th>
          <th>App Bookings</th>
          <th>App Pax</th>
          <th>Paid App Bookings</th>
          <th>Paid App Pax</th>
          <th>External Bookings</th>
          <th>External Pax</th>
          <th>Total Pax</th>
          <th>Capacity</th>
        </tr>
      </thead>
      <tbody>
        {% for row in tour_booking_summaries %}
        <tr>
          <td>
            <div class="fw-semibold">{{ row.title }}</div>
            <div class="small text-muted text-capitalize">{{ row.tour_status or 'open' }}</div>
          </td>
          <td>
            <div class="small">{{ row.pickup_city_name or '-' }}{% if row.pickup_state_name %}, {{ row.pickup_state_name }}{% endif %}</div>
            <div class="small text-muted">to {{ row.drop_city_name or '-' }}{% if row.drop_state_name %}, {{ row.drop_state_name }}{% endif %}</div>
          </td>
          <td>{{ row.internal_booking_count }}</td>
          <td>{{ row.internal_pax }}</td>
          <td>{{ row.paid_booking_count }}</td>
          <td>{{ row.paid_pax }}</td>
          <td>{{ row.external_booking_count }}</td>
          <td>{{ row.external_pax }}</td>
          <td><strong>{{ row.total_pax_count }}</strong></td>
          <td>{% if row.max_group_size %}{{ row.max_group_size }}{% else %}-{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="text-muted small">No tours found for booking summary.</div>
  {% endif %}
</div>

<div class="card p-3 shadow-sm mt-4">
  <h5 class="fw-bold mb-3">Joined Travelers Details (App Bookings)</h5>
  {% if joined_travelers %}
  <div class="table-responsive">
    <table class="table table-sm align-middle mb-0">
      <thead>
        <tr>
          <th>Date</th>
          <th>Tour</th>
          <th>Booking</th>
          <th>Traveler</th>
          <th>Age</th>
          <th>Category</th>
          <th>Contact</th>
          <th>ID Proof</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for tr in joined_travelers %}
        <tr>
          <td>{{ tr.booking_date }}</td>
          <td>{{ tr.tour_title }}</td>
          <td>#{{ tr.booking_id }}</td>
          <td>
            <div class="fw-semibold">{{ tr.traveler_name }}</div>
            <div class="small text-muted">Lead: {{ tr.lead_traveler_name }}</div>
          </td>
          <td>{{ tr.age or '-' }}</td>
          <td>
            {% if tr.is_child %}
            <span class="badge bg-info text-dark">Child</span>
            {% else %}
            <span class="badge bg-secondary">Adult</span>
            {% endif %}
          </td>
          <td>{{ tr.contact_number or tr.lead_traveler_phone or '-' }}</td>
          <td>
            {% if tr.id_proof_type or tr.id_proof_number %}
            {{ tr.id_proof_type or 'ID' }}{% if tr.id_proof_number %}: {{ tr.id_proof_number }}{% endif %}
            {% else %}
            -
            {% endif %}
          </td>
          <td>
            {% set row_status = (tr.booking_status or '').lower() %}
            {% if row_status == 'paid' %}
            <span class="badge bg-success">paid</span>
            {% elif row_status == 'pending' %}
            <span class="badge bg-warning text-dark">pending</span>
            {% elif row_status == 'cancelled' %}
            <span class="badge bg-danger">cancelled</span>
            {% else %}
            <span class="badge bg-secondary">{{ tr.booking_status or '-' }}</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="text-muted small">No joined traveler details found yet.</div>
  {% endif %}
</div>

<div class="card p-3 shadow-sm mt-4">
  <h5 class="fw-bold mb-3">Add Outside Booking (Manual Entry)</h5>
  <form method="POST" class="row g-2 align-items-end">
    <input type="hidden" name="action" value="add_external_booking">
    <div class="col-md-3">
      <label class="form-label small">Tour</label>
      <select name="tour_id" class="form-select" required>
        <option value="">Select Tour</option>
        {% for t in tours %}
        <option value="{{ t.id }}">{{ t.title }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label small">Traveler Name</label>
      <input type="text" name="traveler_name" class="form-control" required>
    </div>
    <div class="col-md-2">
      <label class="form-label small">Contact</label>
      <input type="text" name="contact_number" class="form-control">
    </div>
    <div class="col-md-1">
      <label class="form-label small">Pax</label>
      <input type="number" name="pax_count" min="1" class="form-control" value="1" required>
    </div>
    <div class="col-md-2">
      <label class="form-label small">Amount</label>
      <input type="number" name="amount_received" min="0" step="0.01" class="form-control" required>
    </div>
    <div class="col-md-2">
      <label class="form-label small">Notes</label>
      <input type="text" name="notes" class="form-control" maxlength="255">
    </div>
    <div class="col-md-12 d-grid">
      <button class="btn btn-outline-success">Save External Booking</button>
    </div>
  </form>
</div>
</div>

<div id="library" class="section-pane d-none">

<h3 class="fw-bold mb-3">Hierarchy Library</h3>

<div class="row g-3 mb-4">
<div class="col-md-6">
<button class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#cityModal">Add City</button>
</div>
<div class="col-md-6">
<button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#spotModal">Request New Spot</button>
</div>
</div>

<div class="alert alert-info">
Spot creation and spot image changes now require admin approval. Submit request from here, then wait for admin action.
</div>

<div class="card p-3 shadow-sm mb-4">
<h6 class="fw-bold mb-2">Bulk Import Spots (CSV + Photo Filename)</h6>
<p class="small text-muted mb-2">
CSV columns: <code>spot_name</code> (required), <code>state_name</code>, <code>city_name</code>, <code>image_file</code> or external <code>image_url</code>, <code>latitude</code>, <code>longitude</code>.
If using local photo, keep the file in <code>static/uploads/spots/</code> (or <code>static/uploads/</code>) and set <code>image_file</code> to its filename.
</p>
<form method="POST" enctype="multipart/form-data" class="row g-2 align-items-end">
<input type="hidden" name="action" value="add_spots_csv">
<div class="col-md-5">
<label class="form-label small">CSV File</label>
<input type="file" name="spots_csv" class="form-control" accept=".csv" required>
</div>
<div class="col-md-3">
<label class="form-label small">Default State</label>
<select id="defaultCityState" class="form-select">
<option value="">Select state</option>
{% for s in states %}
<option value="{{ s.id }}">{{ s.state_name }}</option>
{% endfor %}
</select>
</div>
<div class="col-md-3">
<label class="form-label small">Default City (optional fallback)</label>
<select name="default_city_id" id="defaultCity" class="form-select" data-require-state="1">
<option value="">Select city</option>
{% for c in cities %}
<option value="{{ c.id }}" data-state-id="{{ c.state_id }}">{{ c.city_name }} ({{ c.state_name }})</option>
{% endfor %}
</select>
</div>
<div class="col-md-2 d-grid">
<button class="btn btn-success">Import</button>
</div>
</form>
</div>

<div class="card p-4 shadow-sm">
<div class="table-responsive">
<table class="table table-hover align-middle">

<thead class="table-dark">
<tr>
<th>State</th>
<th>City</th>
<th>Spot</th>
<th>Image</th>
<th>Update Image</th>
</tr>
</thead>

<tbody>
{% for s in spots %}
<tr>
<td><span class="badge bg-secondary">{{ s.state_name }}</span></td>
<td>{{ s.city_name }}</td>
<td>{{ s.spot_name }}</td>
<td>
{% if s.photo_source == 'external_url' %}
<a href="{{ s.image_url }}" target="_blank" rel="noopener" class="dashboard-thumb-link" title="Open full image">
<img src="{{ s.image_url }}"
     onerror="this.onerror=null;this.src='{{ url_for('static', filename='uploads/demo.jpg') }}';"
     class="dashboard-thumb-img">
</a>
{% else %}
{% set spot_image_src = url_for('static', filename='uploads/' + (s.image_url or 'demo.jpg')) %}
<a href="{{ spot_image_src }}" target="_blank" rel="noopener" class="dashboard-thumb-link" title="Open full image">
<img src="{{ spot_image_src }}"
     onerror="this.onerror=null;this.src='{{ url_for('static', filename='uploads/demo.jpg') }}';"
     class="dashboard-thumb-img">
</a>
{% endif %}
</td>
<td style="min-width:290px;">
<form method="POST" enctype="multipart/form-data" class="d-flex flex-column gap-1">
<input type="hidden" name="action" value="update_spot_image">
<input type="hidden" name="spot_id" value="{{ s.spot_id }}">
<input type="file" name="spot_image" class="form-control form-control-sm" accept="image/*">
<input type="url" name="external_image_url" class="form-control form-control-sm" placeholder="Or external image URL">
<button class="btn btn-sm btn-outline-primary" type="submit">Submit Image Change Request</button>
</form>
</td>
</tr>
{% endfor %}
</tbody>

</table>
</div>
</div>

<div class="card p-4 shadow-sm mt-4">
<h6 class="fw-bold mb-2">My Spot/Image Requests</h6>
<div class="row g-2 mb-3">
<div class="col-6 col-md-2"><div class="border rounded p-2"><div class="small text-muted">Total</div><div class="fw-bold">{{ request_stats.total }}</div></div></div>
<div class="col-6 col-md-2"><div class="border rounded p-2"><div class="small text-muted">Pending</div><div class="fw-bold text-secondary">{{ request_stats.pending }}</div></div></div>
<div class="col-6 col-md-2"><div class="border rounded p-2"><div class="small text-muted">Approved</div><div class="fw-bold text-success">{{ request_stats.approved }}</div></div></div>
<div class="col-6 col-md-2"><div class="border rounded p-2"><div class="small text-muted">Rejected</div><div class="fw-bold text-danger">{{ request_stats.rejected }}</div></div></div>
<div class="col-6 col-md-2"><div class="border rounded p-2"><div class="small text-muted">Add Spot</div><div class="fw-bold">{{ request_stats.add_spot }}</div></div></div>
<div class="col-6 col-md-2"><div class="border rounded p-2"><div class="small text-muted">Image Update</div><div class="fw-bold">{{ request_stats.update_image }}</div></div></div>
</div>
{% if spot_requests %}
<div class="table-responsive">
<table class="table table-sm table-hover align-middle">
<thead class="table-light">
<tr>
<th>ID</th>
<th>Request Type</th>
<th>Spot</th>
<th>Location</th>
<th>Status</th>
<th>Submitted</th>
<th>Admin Note</th>
</tr>
</thead>
<tbody>
{% for req in spot_requests %}
<tr>
<td>#{{ req.id }}</td>
<td>
{% if req.request_type == 'add_spot' %}
<span class="badge bg-primary">Add Spot</span>
{% else %}
<span class="badge bg-warning text-dark">Update Spot Image</span>
{% endif %}
</td>
<td>{{ req.spot_name }}</td>
<td>{{ req.city_name or '-' }}{% if req.state_name %}, {{ req.state_name }}{% endif %}</td>
<td>
{% if req.status == 'approved' %}
<span class="badge bg-success">approved</span>
{% elif req.status == 'rejected' %}
<span class="badge bg-danger">rejected</span>
{% else %}
<span class="badge bg-secondary">pending</span>
{% endif %}
</td>
<td><small>{{ req.created_at }}</small></td>
<td>{{ req.admin_note or '-' }}</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% else %}
<div class="text-muted small">No spot/image requests yet.</div>
{% endif %}
</div>
</div>

<div id="analytics" class="section-pane d-none">
<h3 class="fw-bold mb-3">Organizer Analytics</h3>

<div class="row g-3 mb-4">
<div class="col-md-4 col-lg-2">
<div class="card p-3 shadow-sm stat-box"><div class="small text-muted">Tours</div><div class="fw-bold fs-4">{{ analytics.total_tours }}</div></div>
</div>
<div class="col-md-4 col-lg-2">
<div class="card p-3 shadow-sm stat-box"><div class="small text-muted">Bookings</div><div class="fw-bold fs-4">{{ analytics.total_bookings }}</div></div>
</div>
<div class="col-md-4 col-lg-2">
<div class="card p-3 shadow-sm stat-box"><div class="small text-muted">Paid</div><div class="fw-bold fs-4">{{ analytics.paid_bookings }}</div></div>
</div>
<div class="col-md-4 col-lg-2">
<div class="card p-3 shadow-sm stat-box"><div class="small text-muted">Full Tours</div><div class="fw-bold fs-4">{{ analytics.full_tours }}</div></div>
</div>
<div class="col-md-4 col-lg-2">
<div class="card p-3 shadow-sm stat-box"><div class="small text-muted">External Bookings</div><div class="fw-bold fs-4">{{ analytics.external_bookings }}</div></div>
</div>
<div class="col-md-4 col-lg-2">
<div class="card p-3 shadow-sm stat-box"><div class="small text-muted">Spots</div><div class="fw-bold fs-4">{{ analytics.total_spots }}</div></div>
</div>
<div class="col-md-4 col-lg-1">
<div class="card p-3 shadow-sm stat-box"><div class="small text-muted">Hotels</div><div class="fw-bold fs-4">{{ analytics.partner_hotels }}</div></div>
</div>
<div class="col-md-4 col-lg-1">
<div class="card p-3 shadow-sm stat-box"><div class="small text-muted">Requests</div><div class="fw-bold fs-4">{{ analytics.spot_requests }}</div></div>
</div>
<div class="col-md-6 col-lg-3">
<div class="card p-3 shadow-sm stat-box"><div class="small text-muted">Total Organizer Profit</div><div class="fw-bold fs-4">₹{{ analytics.total_profit }}</div></div>
</div>
<div class="col-md-6 col-lg-3">
<div class="card p-3 shadow-sm stat-box"><div class="small text-muted">Admin Commission (1%)</div><div class="fw-bold fs-4">₹{{ analytics.total_admin_commission }}</div></div>
</div>
</div>

<div class="row g-4">
<div class="col-12">
<div class="card p-3 shadow-sm">
<h6 class="fw-bold mb-3">Outside Booking Entries</h6>
{% if external_bookings %}
<div class="table-responsive">
<table class="table table-sm align-middle mb-0">
<thead>
<tr><th>Date</th><th>Tour</th><th>Traveler</th><th>Pax</th><th>Amount</th><th>Commission</th><th>Earning</th></tr>
</thead>
<tbody>
{% for eb in external_bookings[:20] %}
<tr>
<td>{{ eb.created_at }}</td>
<td>{{ eb.title }}</td>
<td>{{ eb.traveler_name }}</td>
<td>{{ eb.pax_count }}</td>
<td>₹{{ eb.amount_received }}</td>
<td>₹{{ eb.admin_commission }}</td>
<td>₹{{ eb.organizer_earning }}</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% else %}
<div class="text-muted small">No external bookings yet.</div>
{% endif %}
</div>
</div>
</div>
</div>

</main>
</div>
</div>

<div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="profileModalLabel">Profile Details</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">
<div class="mb-2"><strong>Name:</strong> {{ session.get('username', 'Organizer') }}</div>
<div class="mb-2"><strong>Role:</strong> {{ session.get('role', 'organizer')|capitalize }}</div>
<div><strong>Status:</strong> Active Session</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
</div>
</div>
</div>
</div>

<div class="modal fade" id="cityModal">
<div class="modal-dialog">
<form class="modal-content" method="POST">
<input type="hidden" name="action" value="add_city">
<div class="modal-header"><h5>Add City</h5></div>
<div class="modal-body">

<select name="state_id" class="form-select mb-3" required>
<option value="">Select State</option>
{% for s in states %}
<option value="{{ s.id }}">{{ s.state_name }}</option>
{% endfor %}
</select>

<input type="text" name="city_name" class="form-control" placeholder="Example: Udaipur" required>
</div>
<div class="modal-footer">
<button class="btn btn-primary">Save</button>
</div>
</form>
</div>
</div>

<div class="modal fade" id="spotModal">
<div class="modal-dialog">
<form class="modal-content" method="POST" enctype="multipart/form-data">
<input type="hidden" name="action" value="add_spot">

<div class="modal-header"><h5>Request Tourist Spot</h5></div>

<div class="modal-body">

<select id="spotCityState" class="form-select mb-2" required>
<option value="">Select State</option>
{% for s in states %}
<option value="{{ s.id }}">{{ s.state_name }}</option>
{% endfor %}
</select>

<select name="city_id" id="spotCity" class="form-select mb-3" data-require-state="1" required>
<option value="">Select City</option>
{% for c in cities %}
<option value="{{ c.id }}" data-state-id="{{ c.state_id }}">{{ c.city_name }} ({{ c.state_name }})</option>
{% endfor %}
</select>

<input type="text" name="spot_name" class="form-control mb-3" placeholder="Example: City Palace">

<div class="row g-2 mb-3">
<div class="col-md-6">
<input type="text" id="spotLatitudeInput" name="latitude" class="form-control" placeholder="Latitude (optional)">
</div>
<div class="col-md-6">
<input type="text" id="spotLongitudeInput" name="longitude" class="form-control" placeholder="Longitude (optional)">
</div>
</div>

<input type="file" name="spot_image" class="form-control" accept="image/*">
<input type="url" name="external_image_url" class="form-control mt-2" placeholder="Or paste external image URL (https://...)">
<div class="small text-muted mt-2">This request will be reviewed by admin before adding to database.</div>

</div>

<div class="modal-footer">
<button class="btn btn-primary">Submit Request</button>
</div>
</form>
</div>
</div>

<div class="modal fade" id="tourModal">
<div class="modal-dialog modal-lg">
<form class="modal-content" method="POST" enctype="multipart/form-data">
<input type="hidden" name="action" value="add_tour">

<div class="modal-header bg-primary text-white">
<h5>Create New Tour</h5>
</div>

<div class="modal-body">
<div class="tour-builder-single">
<h6 class="fw-bold mb-3">1. Basic Info</h6>
<div class="row g-3 mb-3">
<div class="col-md-6">
<input type="text" name="title" class="form-control" placeholder="Tour Name" required>
</div>
<div class="col-md-3">
<input type="number" name="price" class="form-control" placeholder="Adult Base Price" min="0" step="0.01" required>
</div>
<div class="col-md-3">
<input type="number" name="child_price_amount" id="childPriceAmount" class="form-control" placeholder="Children Price" min="0" step="0.01" required>
</div>
</div>
<input type="hidden" name="child_price_percent" id="childPricePercent" value="100">
<input type="hidden" name="start_point" id="startPointHidden">
<input type="hidden" name="end_point" id="endPointHidden">
<div class="small text-muted mb-3">Child fare ratio: <span id="childPercentPreview">0.00%</span> of adult fare.</div>
<textarea name="description" class="form-control mb-3" placeholder="Tour Description"></textarea>

<hr class="my-4">
<h6 class="fw-bold mb-3">2. Route & Schedule</h6>
<div class="row g-3 mb-3">
<div class="col-md-6">
<label class="form-label small fw-semibold">Primary Departure City</label>
<select name="pickup_city_id" id="pickupCity" class="form-select city-control" required>
<option value="">Select Pickup City</option>
{% for c in cities %}
<option value="{{ c.id }}" data-state-id="{{ c.state_id }}">{{ c.city_name }} ({{ c.state_name }})</option>
{% endfor %}
</select>
</div>
<div class="col-md-6">
<label class="form-label small fw-semibold">Destination City</label>
<select name="drop_city_id" id="dropCity" class="form-select city-control" required>
<option value="">Select Drop City</option>
{% for c in cities %}
<option value="{{ c.id }}" data-state-id="{{ c.state_id }}">{{ c.city_name }} ({{ c.state_name }})</option>
{% endfor %}
</select>
</div>
</div>

<div class="row g-3 mb-3">
<div class="col-md-4">
<label class="form-label small fw-semibold">Transport Vehicle Type</label>
<select name="travel_mode" class="form-select" required>
<option value="">Select Vehicle Type</option>
<option value="Bus">Bus</option>
<option value="Train">Train</option>
<option value="Flight">Flight</option>
<option value="Private Cab">Private Cab</option>
<option value="Mixed">Mixed</option>
</select>
</div>
<div class="col-md-4">
<label class="form-label small fw-semibold">Food Plan</label>
<select name="food_plan" class="form-select">
<option value="">Select Food Plan</option>
<option value="No Meals">No Meals</option>
<option value="Breakfast Only">Breakfast Only</option>
<option value="Breakfast + Dinner">Breakfast + Dinner</option>
<option value="All Meals">All Meals</option>
<option value="Custom">Custom</option>
</select>
</div>
<div class="col-md-4">
<label class="form-label small fw-semibold">Max Group Size</label>
<input type="number" name="max_group_size" class="form-control" min="1" placeholder="e.g. 20" required>
</div>
</div>

<div class="row g-3 mb-3">
<div class="col-md-4">
<label class="form-label small fw-semibold">Minimum People To Start Tour (Info Only)</label>
<input type="number" name="start_min_people" class="form-control" min="1" value="6">
</div>
<div class="col-md-4">
<label class="form-label small fw-semibold">Tour Departure Date & Time</label>
<input type="datetime-local" id="tourDepartureDateTime" name="departure_datetime" class="form-control" required>
</div>
<div class="col-md-4">
<label class="form-label small fw-semibold">Tour Return Date & Time</label>
<input type="datetime-local" id="tourReturnDateTime" name="return_datetime" class="form-control" required>
</div>
</div>

<div class="mb-3">
<label class="form-label small fw-semibold">Inclusions</label>
<input type="hidden" name="inclusions" id="inclusionsInput" value="">
<div class="row g-2">
<div class="col-md-4"><label class="form-check small"><input class="form-check-input inclusion-check" type="checkbox" name="inclusion_options[]" value="Hotel Stay"> Hotel Stay</label></div>
<div class="col-md-4"><label class="form-check small"><input class="form-check-input inclusion-check" type="checkbox" name="inclusion_options[]" value="Breakfast"> Breakfast</label></div>
<div class="col-md-4"><label class="form-check small"><input class="form-check-input inclusion-check" type="checkbox" name="inclusion_options[]" value="Dinner"> Dinner</label></div>
<div class="col-md-4"><label class="form-check small"><input class="form-check-input inclusion-check" type="checkbox" name="inclusion_options[]" value="Local Transport"> Local Transport</label></div>
<div class="col-md-4"><label class="form-check small"><input class="form-check-input inclusion-check" type="checkbox" name="inclusion_options[]" value="Sightseeing"> Sightseeing</label></div>
<div class="col-md-4"><label class="form-check small"><input class="form-check-input inclusion-check" type="checkbox" name="inclusion_options[]" value="Guide"> Guide</label></div>
<div class="col-md-4"><label class="form-check small"><input class="form-check-input inclusion-check" type="checkbox" name="inclusion_options[]" value="Entry Tickets"> Entry Tickets</label></div>
<div class="col-md-4"><label class="form-check small"><input class="form-check-input inclusion-check" type="checkbox" name="inclusion_options[]" value="Permits"> Permits</label></div>
<div class="col-md-4"><label class="form-check small"><input class="form-check-input inclusion-check" type="checkbox" name="inclusion_options[]" value="Pickup & Drop"> Pickup & Drop</label></div>
</div>
</div>
<div class="mb-3">
<label class="form-label small fw-semibold">Exclusions</label>
<textarea name="exclusions" class="form-control" rows="2" placeholder="Flights, personal expenses..."></textarea>
</div>
<div class="mt-3">
<label class="form-label small fw-semibold">Terms & Conditions (Minimum person, cancellation, etc.)</label>
<textarea name="terms_conditions" class="form-control" rows="3" placeholder="Mention minimum travelers required, cancellation policy, timing rules..."></textarea>
</div>

<hr class="my-4">
<h6 class="fw-bold mb-3">3. Partner Services</h6>
<h6 class="fw-bold mb-3">Partner Hotels (Destination State)</h6>
<div class="row g-2 mb-3">
<div class="col-md-12">
<select id="hotelFilterState" class="form-select" disabled>
<option value="">Filter Hotels by State</option>
{% for s in states %}
<option value="{{ s.id }}">{{ s.state_name }}</option>
{% endfor %}
</select>
</div>
</div>
<div class="small text-muted mb-2">Hotels are auto-restricted to destination state only.</div>
<div class="mb-4">
<label class="form-label small fw-semibold">Select Hotel</label>
<div class="input-group">
<select id="hotelSelect" class="form-select" disabled>
<option value="">Select Hotel</option>
{% if hotel_options %}
{% for h in hotel_options %}
<option value="{{ h.service_id }}" data-state-id="{{ h.state_id or '' }}">
{{ h.hotel_name }}{% if h.city_name %} - {{ h.city_name }}{% endif %}{% if h.state_name %}, {{ h.state_name }}{% endif %}{% if h.owner_email %} | Owner Email: {{ h.owner_email }}{% endif %}
</option>
{% endfor %}
{% else %}
<option value="" disabled>No published hotels found yet.</option>
{% endif %}
</select>
<button type="button" id="addHotelBtn" class="btn btn-outline-primary">Add</button>
</div>
<div class="small text-muted mt-1">Only destination-state hotels are available.</div>
<div id="selectedHotelList" class="border rounded p-2 mt-2">
<div id="selectedHotelEmpty" class="small text-muted">No hotel selected.</div>
</div>
</div>

<hr class="my-4">
<h6 class="fw-bold mb-3">4. Day-wise Spots & Media</h6>
<h6 class="fw-bold">Itinerary</h6>
<p class="small text-muted mb-2">Spots are auto-filtered from destination city only.</p>
<div class="row g-2 mb-2">
<div class="col-md-6">
<select id="spotFilterState" class="form-select" disabled>
<option value="">Filter Spots by State</option>
{% for s in states %}
<option value="{{ s.id }}">{{ s.state_name }}</option>
{% endfor %}
</select>
</div>
<div class="col-md-6">
<select id="spotFilterCity" class="form-select" data-require-state="1" disabled>
<option value="">Filter Spots by City</option>
{% for c in cities %}
<option value="{{ c.id }}" data-state-id="{{ c.state_id }}">{{ c.city_name }} ({{ c.state_name }})</option>
{% endfor %}
</select>
</div>
</div>
<div id="itinerary-list"></div>
<button type="button" class="btn btn-outline-primary mt-2" onclick="addItineraryRow()">+ Add Spot</button>

<div class="mt-3">
<label class="form-label small fw-semibold">Main Tour Image</label>
<input type="file" name="tour_image" class="form-control" accept="image/*" required>
</div>
</div>
</div>

</div>

<div class="modal-footer">
<button class="btn btn-success w-100">Publish Tour</button>
</div>

</form>
</div>
</div>

<script id="spots-json" type="application/json">{{ spots|tojson }}</script>
<script>
let SPOTS = [];
try{
const rawSpots = document.getElementById('spots-json');
SPOTS = rawSpots ? JSON.parse(rawSpots.textContent) : [];
}catch(err){
SPOTS = [];
}

function getValueById(id){
const el = document.getElementById(id);
return el ? el.value : '';
}

function bindChange(id, handler){
const el = document.getElementById(id);
if(el){
el.addEventListener('change', handler);
}
}

function updateCityOptions(stateId, citySelectRef){
const citySelect = typeof citySelectRef === 'string'
? document.getElementById(citySelectRef)
: citySelectRef;
if(!citySelect) return;
const normalizedStateId = String(stateId || '');
const requireState = citySelect.dataset.requireState === '1';
const hasState = !!normalizedStateId;
const options = citySelect.querySelectorAll('option[data-state-id]');
options.forEach(opt => {
const optionStateId = String(opt.dataset.stateId || '');
const visible = requireState ? (hasState && optionStateId === normalizedStateId) : (!hasState || optionStateId === normalizedStateId);
opt.hidden = !visible;
opt.disabled = !visible;
opt.style.display = visible ? '' : 'none';
});
if(requireState){
citySelect.disabled = !hasState;
if(!hasState){
citySelect.value = '';
}
}
if(citySelect.value){
const selected = citySelect.querySelector(`option[value="${citySelect.value}"]`);
if(selected && (selected.hidden || selected.disabled)){
citySelect.value = '';
}
}
}

function updateChildPriceMeta(){
const basePriceInput = document.querySelector('input[name="price"]');
const childPriceInput = document.getElementById('childPriceAmount');
const childPercentInput = document.getElementById('childPricePercent');
const preview = document.getElementById('childPercentPreview');
if(!basePriceInput || !childPriceInput || !childPercentInput){
return;
}
const base = Number.parseFloat(basePriceInput.value || '0');
const normalizedBase = Number.isFinite(base) && base > 0 ? base : 0;
const child = Number.parseFloat(childPriceInput.value || '0');
const normalizedChild = Number.isFinite(child) && child >= 0 ? child : 0;
const percent = normalizedBase > 0 ? (normalizedChild / normalizedBase) * 100 : 0;
const normalizedPercent = Number.isFinite(percent) && percent >= 0 ? percent : 0;
childPercentInput.value = normalizedPercent.toFixed(2);
if(preview){
preview.textContent = `${normalizedPercent.toFixed(2)}%`;
}
}

function syncInclusionsField(){
const inclusionsInput = document.getElementById('inclusionsInput');
if(!inclusionsInput){
return;
}
const values = Array.from(document.querySelectorAll('input[name="inclusion_options[]"]:checked'))
.map((el) => (el.value || '').trim())
.filter(Boolean);
inclusionsInput.value = values.join(', ');
}

function syncRoutePointFields(){
const pickupCity = document.getElementById('pickupCity');
const dropCity = document.getElementById('dropCity');
const startPoint = document.getElementById('startPointHidden');
const endPoint = document.getElementById('endPointHidden');
if(pickupCity && startPoint){
const selected = pickupCity.options[pickupCity.selectedIndex];
startPoint.value = selected && selected.value ? selected.textContent.trim() : '';
}
if(dropCity && endPoint){
const selected = dropCity.options[dropCity.selectedIndex];
endPoint.value = selected && selected.value ? selected.textContent.trim() : '';
}
}

function syncTourScheduleBounds(){
const departureInput = document.getElementById('tourDepartureDateTime');
const returnInput = document.getElementById('tourReturnDateTime');
if(!departureInput || !returnInput){
return;
}
returnInput.min = departureInput.value || '';
returnInput.setCustomValidity('');
if(departureInput.value && returnInput.value && returnInput.value <= departureInput.value){
returnInput.setCustomValidity('Return date/time must be after departure date/time.');
}
}

function validateTourScheduleBounds(event){
const departureInput = document.getElementById('tourDepartureDateTime');
const returnInput = document.getElementById('tourReturnDateTime');
if(!departureInput || !returnInput){
return true;
}
syncTourScheduleBounds();
if(departureInput.value && returnInput.value && returnInput.value <= departureInput.value){
if(event){
event.preventDefault();
}
returnInput.reportValidity();
return false;
}
return true;
}

function syncDestinationDrivenFilters(){
const dropCity = document.getElementById('dropCity');
const hotelState = document.getElementById('hotelFilterState');
const spotState = document.getElementById('spotFilterState');
const spotCity = document.getElementById('spotFilterCity');
if(!dropCity){
return;
}

const selectedOption = dropCity.options[dropCity.selectedIndex];
const destinationCityId = String(dropCity.value || '');
const destinationStateId = selectedOption ? String(selectedOption.dataset.stateId || '') : '';

if(!destinationCityId || !destinationStateId){
if(spotState){
spotState.value = '';
spotState.disabled = true;
}
if(spotCity){
updateCityOptions('', spotCity);
spotCity.value = '';
spotCity.disabled = true;
}
if(hotelState){
hotelState.value = '';
hotelState.disabled = true;
}
refreshItinerarySpotOptions();
filterHotelLinks();
return;
}

if(spotState){
spotState.value = destinationStateId;
spotState.disabled = true;
}
if(spotCity){
updateCityOptions(destinationStateId, spotCity);
spotCity.value = destinationCityId;
spotCity.disabled = true;
}

if(hotelState){
hotelState.value = destinationStateId;
hotelState.disabled = true;
}

refreshItinerarySpotOptions();
filterHotelLinks();
}

function filterHotelLinks(){
const stateId = getValueById('hotelFilterState');
const hotelSelect = document.getElementById('hotelSelect');
if(!hotelSelect){
return;
}
const hasState = !!stateId;
hotelSelect.disabled = !hasState;
Array.from(hotelSelect.options).forEach((opt) => {
const value = String(opt.value || '');
if(!value){
opt.hidden = false;
opt.disabled = false;
return;
}
const stateOk = hasState && String(opt.dataset.stateId || '') === stateId;
opt.hidden = !stateOk;
opt.disabled = !stateOk;
});
if(hotelSelect.value){
const selected = hotelSelect.querySelector(`option[value="${hotelSelect.value}"]`);
if(!selected || selected.disabled || selected.hidden){
hotelSelect.value = '';
}
}
pruneSelectedHotelsByState(stateId);
toggleSelectedHotelEmpty();
}

function getSelectedHotelIds(){
return Array.from(document.querySelectorAll('#selectedHotelList input[name="linked_hotels[]"]'))
.map((el) => String(el.value || ''));
}

function toggleSelectedHotelEmpty(){
const empty = document.getElementById('selectedHotelEmpty');
if(!empty){
return;
}
empty.style.display = getSelectedHotelIds().length ? 'none' : 'block';
}

function pruneSelectedHotelsByState(stateId){
const state = String(stateId || '');
document.querySelectorAll('#selectedHotelList .selected-hotel-item').forEach((item) => {
if(!state || String(item.dataset.stateId || '') !== state){
item.remove();
}
});
}

function addSelectedHotel(){
const hotelSelect = document.getElementById('hotelSelect');
const selectedHotelList = document.getElementById('selectedHotelList');
if(!hotelSelect || !selectedHotelList){
return;
}
const serviceId = String(hotelSelect.value || '');
if(!serviceId){
return;
}
if(getSelectedHotelIds().includes(serviceId)){
hotelSelect.value = '';
toggleSelectedHotelEmpty();
return;
}
const selectedOption = hotelSelect.querySelector(`option[value="${serviceId}"]`);
if(!selectedOption || selectedOption.disabled || selectedOption.hidden){
return;
}

const row = document.createElement('div');
row.className = 'selected-hotel-item d-flex justify-content-between align-items-center gap-2 border rounded px-2 py-1 mb-1';
row.dataset.stateId = String(selectedOption.dataset.stateId || '');

const label = document.createElement('span');
label.className = 'small';
label.textContent = selectedOption.textContent.trim();

const hidden = document.createElement('input');
hidden.type = 'hidden';
hidden.name = 'linked_hotels[]';
hidden.value = serviceId;

const removeBtn = document.createElement('button');
removeBtn.type = 'button';
removeBtn.className = 'btn btn-sm btn-outline-danger';
removeBtn.textContent = 'Remove';
removeBtn.addEventListener('click', () => {
row.remove();
toggleSelectedHotelEmpty();
});

row.appendChild(label);
row.appendChild(hidden);
row.appendChild(removeBtn);
selectedHotelList.appendChild(row);
hotelSelect.value = '';
toggleSelectedHotelEmpty();
}

function getSpotOptionsMarkup(selectedSpot){
const filterState = getValueById('spotFilterState');
const filterCity = getValueById('spotFilterCity');
const selectedSpotId = String(selectedSpot || '');
let options = '<option value="">Select Spot</option>';
let selectedVisible = false;
SPOTS.forEach((spot) => {
const stateOk = !filterState || String(spot.state_id) === String(filterState);
const cityOk = !filterCity || String(spot.city_id) === String(filterCity);
if(stateOk && cityOk){
const selected = selectedSpotId && selectedSpotId === String(spot.spot_id) ? ' selected' : '';
if(selected){
selectedVisible = true;
}
options += `<option value="${spot.spot_id}"${selected}>${spot.state_name} ➜ ${spot.city_name} ➜ ${spot.spot_name}</option>`;
}
});
if(selectedSpotId && !selectedVisible && !filterState && !filterCity){
const selectedSpotRow = SPOTS.find((spot) => String(spot.spot_id) === selectedSpotId);
if(selectedSpotRow){
options += `<option value="${selectedSpotRow.spot_id}" selected>${selectedSpotRow.state_name} ➜ ${selectedSpotRow.city_name} ➜ ${selectedSpotRow.spot_name} (selected)</option>`;
}
}
return options;
}

function refreshItinerarySpotOptions(){
document.querySelectorAll('#itinerary-list select[name="spots[]"]').forEach((selectEl) => {
const current = selectEl.value;
selectEl.innerHTML = getSpotOptionsMarkup(current);
});
}

function showSection(id){
document.querySelectorAll('.section-pane').forEach(el=>el.classList.add('d-none'));
document.getElementById(id).classList.remove('d-none');
document.querySelectorAll('.sidebar-link').forEach((btn) => {
btn.classList.toggle('active', btn.dataset.section === id);
});
}

function addItineraryRow(){
const container=document.getElementById('itinerary-list');
if(!container) return;
const row = document.createElement('div');
row.className = 'card p-3 mb-2';
row.innerHTML = `
<div class="row g-2">

<div class="col-md-2">
<input type="number" name="day_numbers[]" class="form-control" value="1" min="1" required>
</div>

<div class="col-md-4">
<select name="spots[]" class="form-select" required>
</select>
</div>

<div class="col-md-2">
<button type="button" class="btn btn-danger w-100" onclick="this.closest('.card').remove()">Remove</button>
</div>

</div>`;
container.appendChild(row);
const spotSelect = row.querySelector('select[name="spots[]"]');
if(spotSelect){
spotSelect.innerHTML = getSpotOptionsMarkup('');
}
}

document.addEventListener('DOMContentLoaded', function(){
bindChange('defaultCityState', function(){
updateCityOptions(this.value, 'defaultCity');
});
bindChange('spotCityState', function(){
updateCityOptions(this.value, 'spotCity');
});
bindChange('hotelFilterState', filterHotelLinks);
bindChange('pickupCity', syncRoutePointFields);
bindChange('dropCity', function(){
syncRoutePointFields();
syncDestinationDrivenFilters();
});
bindChange('spotFilterState', function(){
updateCityOptions(this.value, 'spotFilterCity');
refreshItinerarySpotOptions();
});
bindChange('spotFilterCity', refreshItinerarySpotOptions);
bindChange('childPriceAmount', updateChildPriceMeta);
bindChange('tourDepartureDateTime', syncTourScheduleBounds);
bindChange('tourReturnDateTime', function(){
syncTourScheduleBounds();
validateTourScheduleBounds();
});

const basePriceInput = document.querySelector('input[name="price"]');
if(basePriceInput){
basePriceInput.addEventListener('input', updateChildPriceMeta);
}
const addHotelBtn = document.getElementById('addHotelBtn');
if(addHotelBtn){
addHotelBtn.addEventListener('click', addSelectedHotel);
}
const hotelSelect = document.getElementById('hotelSelect');
if(hotelSelect){
hotelSelect.addEventListener('dblclick', addSelectedHotel);
}
const tourForm = document.querySelector('#tourModal form');
if(tourForm){
tourForm.addEventListener('submit', validateTourScheduleBounds);
}
document.querySelectorAll('input[name="inclusion_options[]"]').forEach((el) => {
el.addEventListener('change', syncInclusionsField);
});

updateCityOptions('', 'defaultCity');
updateCityOptions('', 'spotCity');
updateCityOptions('', 'pickupCity');
updateCityOptions('', 'dropCity');
updateCityOptions('', 'spotFilterCity');
syncRoutePointFields();
syncDestinationDrivenFilters();
filterHotelLinks();
updateChildPriceMeta();
syncTourScheduleBounds();
syncInclusionsField();
if(!document.querySelector('#itinerary-list .card')){
addItineraryRow();
}
});

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="{{ url_for('static', filename='js/theme.js') }}"></script>

</body>
</html>
