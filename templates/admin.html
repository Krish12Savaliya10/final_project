<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TourGen | Admin Command Center</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
</head>

<body>

    <nav id="sidebar">
        <ul class="nav flex-column gap-2">
            <li><a onclick="showSection('tours', this)" class="nav-link active"><i class="bi bi-map-fill me-2"></i>
                    Manage Tours</a></li>
            <li><a onclick="showSection('library', this)" class="nav-link"><i class="bi bi-geo-alt-fill me-2"></i>
                    Hierarchy Library</a></li>
            <li><a onclick="showSection('bookings', this)" class="nav-link"><i class="bi bi-journal-check me-2"></i>
                    Bookings</a></li>
            <li>
                <hr class="text-secondary mx-3">
            </li>
            <li><a href="{{ url_for('home') }}" class="nav-link"><i class="bi bi-box-arrow-up-right me-2"></i> Live
                    Website</a></li>
        </ul>
    </nav>

    <div id="main-content">
        <nav class="navbar navbar-dark bg-dark fixed-top shadow">
            <div class="container-fluid px-4">
                <a class="navbar-brand fw-bold"><i>TourGen</i> Admin Panel</a>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm">Logout</a>
            </div>
        </nav>

        {% with messages = get_flashed_messages() %}
        {% if messages %}
        {% for message in messages %}
        <div class="alert alert-info alert-dismissible fade show mb-4" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <div id="tours" class="section-content active">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold">Active Tour Packages</h3>
                <button class="btn btn-primary rounded-pill px-4 shadow" data-bs-toggle="modal"
                    data-bs-target="#tourModal">
                    <i class="bi bi-plus-lg me-2"></i>Build Detailed Tour
                </button>
            </div>
            <div class="row row-cols-1 row-cols-md-3 g-4">
                {% for tour in tours %}
                <div class="col">
                    <div class="card h-100 border-0 shadow-sm overflow-hidden">
                        <img src="{{ url_for('static', filename='uploads/' + (tour.image_path or 'demo.jpg')) }}"
                            class="card-img-top" style="height: 180px; object-fit: cover;">
                        <div class="card-body">
                            <h5 class="fw-bold">{{ tour.title }}</h5>
                            <p class="small text-muted mb-2">{{ tour.start_point }} ➔ {{ tour.end_point }}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-primary fw-bold">₹{{ tour.price }}</span>
                                <span class="badge bg-light text-dark border">{{ tour.start_date }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div id="library" class="section-content">
            <h3 class="fw-bold mb-4">Hierarchy Library</h3>
            <div class="row g-3 mb-4">
                <div class="col-md-4"><button class="btn btn-dark w-100" data-bs-toggle="modal"
                        data-bs-target="#stateModal">+ Add State</button></div>
                <div class="col-md-4"><button class="btn btn-dark w-100" data-bs-toggle="modal"
                        data-bs-target="#cityModal">+ Add City</button></div>
                <div class="col-md-4"><button class="btn btn-primary w-100" data-bs-toggle="modal"
                        data-bs-target="#spotModal">+ Add Spot</button></div>
            </div>
            <div class="card border-0 shadow-sm p-4">
                <table class="table table-hover align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>City</th>
                            <th>Spot Name</th>
                            <th>Image</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in spots %}
                        <tr>
                            <td><span class="badge bg-secondary">{{ s.city_name }}</span></td>
                            <td>{{ s.spot_name }}</td>
                            <td><img src="{{ url_for('static', filename='uploads/' + (s.image_url or 'demo.jpg')) }}"
                                    width="45" height="45" class="rounded"></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="bookings" class="section-content">
            <h3 class="fw-bold mb-4">Tour-wise Enrollments</h3>
            {% set grouped_bookings = {} %}
            {% for b in bookings %}
            {% if b.tour_title not in grouped_bookings %}{% set _ = grouped_bookings.update({b.tour_title: []}) %}{%
            endif %}
            {% set _ = grouped_bookings[b.tour_title].append(b) %}
            {% endfor %}
            {% for tour_name, travelers in grouped_bookings.items() %}
            <div class="card mb-4 border-0 shadow-sm">
                <div class="card-header bg-dark text-white fw-bold"><i class="bi bi-pin-map me-2"></i> {{ tour_name }}
                    ({{ travelers|length }})</div>
                <div class="table-responsive">
                    <table class="table align-middle mb-0">
                        <thead class="bg-light small text-uppercase">
                            <tr>
                                <th>Traveler</th>
                                <th>Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for t in travelers %}
                            <tr>
                                <td class="ps-4">{{ t.username }}</td>
                                <td>{{ t.date }}</td>
                                <td><span
                                        class="badge {{ 'bg-success' if t.status == 'paid' else 'bg-warning text-dark' }}">{{
                                        t.status }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="modal fade" id="stateModal" tabindex="-1">
        <div class="modal-dialog">
            <form class="modal-content" method="POST"><input type="hidden" name="action" value="add_state">
                <div class="modal-header">
                    <h5>Add New State</h5>
                </div>
                <div class="modal-body"><input type="text" name="state_name" class="form-control"
                        placeholder="State Name" required></div>
                <div class="modal-footer"><button class="btn btn-primary">Save State</button></div>
            </form>
        </div>
    </div>

    <div class="modal fade" id="cityModal" tabindex="-1">
        <div class="modal-dialog">
            <form class="modal-content" method="POST"><input type="hidden" name="action" value="add_city">
                <div class="modal-header">
                    <h5>Add New City</h5>
                </div>
                <div class="modal-body"><select name="state_id" class="form-select mb-3" required>
                        <option value="">Select State</option>{% for s in states %}<option value="{{ s.id }}">{{
                            s.state_name }}</option>{% endfor %}
                    </select><input type="text" name="city_name" class="form-control" placeholder="City Name" required>
                </div>
                <div class="modal-footer"><button class="btn btn-primary">Save City</button></div>
            </form>
        </div>
    </div>

    <div class="modal fade" id="spotModal" tabindex="-1">
        <div class="modal-dialog">
            <form class="modal-content" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="action" value="add_spot">

                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">Add New Destination</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Select City</label>
                        <select name="city_id" class="form-select" required>
                            <option value="">-- Choose a City --</option>
                            {% for c in cities %}
                            <option value="{{ c.id }}">{{ c.state_name }} ➔ {{ c.city_name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Spot Name</label>
                        <input type="text" name="spot_name" class="form-control"
                            placeholder="e.g. Kashi Vishwanath Temple" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Spot Image</label>
                        <input type="file" name="spot_image" class="form-control" accept="image/*">
                        <small class="text-muted">Upload a file from your computer</small>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save to Database</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal fade" id="tourModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <form class="modal-content border-0 shadow-lg" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="action" value="add_tour">
                <div class="modal-header bg-primary text-white">
                    <h5>Build Itinerary & Route</h5><button type="button" class="btn-close btn-close-white"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row g-3 mb-3">
                        <div class="col-md-8"><label class="form-label small fw-bold">Tour Title</label><input
                                type="text" name="title" class="form-control" required></div>
                        <div class="col-md-4"><label class="form-label small fw-bold">Base Price (₹)</label><input
                                type="number" name="price" class="form-control" required></div>
                    </div>
                    <div class="mb-3"><label class="form-label small fw-bold">Description</label><textarea
                            name="description" class="form-control" rows="2"></textarea></div>
                    <div class="row g-3 mb-3">
                        <div class="col-md-6"><label class="form-label small fw-bold">Start Point</label><input
                                type="text" name="start_point" class="form-control" required></div>
                        <div class="col-md-6"><label class="form-label small fw-bold">End Point</label><input
                                type="text" name="end_point" class="form-control" required></div>
                    </div>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6"><label class="form-label small fw-bold">Start Date</label><input
                                type="date" name="start_date" class="form-control" required></div>
                        <div class="col-md-6"><label class="form-label small fw-bold">End Date</label><input type="date"
                                name="end_date" class="form-control" required></div>
                    </div>

                    <hr>
                    <label class="form-label small fw-bold text-primary">Day-by-Day Itinerary Planner</label>
                    <div id="itinerary-list" class="mb-2"></div>
                    <button type="button" class="btn btn-outline-primary btn-sm rounded-pill"
                        onclick="addItineraryRow()">+ Add Spot</button>

                    <div class="mt-4"><label class="form-label small fw-bold">Banner Image</label><input type="file"
                            name="tour_image" class="form-control"></div>
                </div>
                <div class="modal-footer"><button type="submit" class="btn btn-primary w-100">Publish Tour</button>
                </div>
            </form>
        </div>
    </div>

    <div id="hierarchy-data" data-cities='{{ cities | tojson }}' data-spots='{{ spots | tojson }}'
        style="display:none;"></div>

    <script>
        // 1. Navigation Script
        function showSection(id, btn) {
            document.querySelectorAll('.section-content').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
        }

        // 2. Data Loading (The "Senior Dev" Way)
        // Pulls data from the hidden #hierarchy-data div to avoid editor errors
        const allCities = JSON.parse(document.getElementById('hierarchy-data').getAttribute('data-cities'));
        const allSpots = JSON.parse(document.getElementById('hierarchy-data').getAttribute('data-spots'));

        // 3. Dynamic Itinerary Row
        function addItineraryRow() {
            const container = document.getElementById('itinerary-list');
            const rowId = Date.now();
            const div = document.createElement('div');
            div.className = "card p-3 mb-3 border shadow-sm";
            div.innerHTML = `
            <div class="row g-2 align-items-end">
                <div class="col-md-2"><label class="small fw-bold">Day</label><input type="number" name="day_numbers[]" class="form-control" value="1" min="1" required></div>
                <div class="col-md-3"><label class="small fw-bold">State</label>
                    <select class="form-select" onchange="filterCities(this, ${rowId})"><option value="">-- State --</option>{% for s in states %}<option value="{{ s.id }}">{{ s.state_name }}</option>{% endfor %}</select>
                </div>
                <div class="col-md-3"><label class="small fw-bold">City</label><select class="form-select" id="city-${rowId}" onchange="filterSpots(this, ${rowId})" disabled><option value="">-- City --</option></select></div>
                <div class="col-md-3"><label class="small fw-bold">Spot</label><select name="spots[]" class="form-select" id="spot-${rowId}" disabled required><option value="">-- Spot --</option></select></div>
                <div class="col-md-1"><button type="button" class="btn btn-danger w-100" onclick="this.closest('.card').remove()">×</button></div>
            </div>`;
            container.appendChild(div);
        }

        // 4. Filter Logic (State -> City -> Spot)
        function filterCities(stateDropdown, rowId) {
            const stateId = stateDropdown.value; // Links to state_id in cities table
            const citySelect = document.getElementById(`city-${rowId}`);
            const spotSelect = document.getElementById(`spot-${rowId}`);

            citySelect.innerHTML = '<option value="">-- Select City --</option>';
            spotSelect.innerHTML = '<option value="">-- Select Spot --</option>';
            spotSelect.disabled = true;

            if (stateId) {
                // Filter cities linked to this state_id
                const filtered = allCities.filter(c => c.state_id == stateId);
                filtered.forEach(c => {
                    let opt = new Option(c.city_name, c.id);
                    citySelect.add(opt);
                });
                citySelect.disabled = false;
            } else {
                citySelect.disabled = true;
            }
        }

        function filterSpots(cityDropdown, rowId) {
            const cityId = cityDropdown.value; // Links to city_id in master_spots table
            const spotSelect = document.getElementById(`spot-${rowId}`);

            spotSelect.innerHTML = '<option value="">-- Select Spot --</option>';

            if (cityId) {
                // Filter spots linked to this city_id
                const filtered = allSpots.filter(s => s.city_id == cityId);
                filtered.forEach(s => {
                    let opt = new Option(s.spot_name, s.id);
                    spotSelect.add(opt);
                });
                spotSelect.disabled = false;
            } else {
                spotSelect.disabled = true;
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>