{% extends "layout.html" %}
{% block title %}{{ hotel.hotel_name }} | Hotel Details{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/hotel_detail.css') }}">
{% endblock %}

{% block content %}
<div class="container pb-5">
  {% with messages = get_flashed_messages() %}
  {% if messages %}
  <div class="alert alert-info border-0 shadow-sm mb-3">{{ messages[0] }}</div>
  {% endif %}
  {% endwith %}

  <div class="section-card p-3 mb-4">
    <div class="row g-3">
      <div class="col-lg-7">
        {% if images %}
        <div id="hotelHeroCarousel" class="carousel slide hero-carousel" data-bs-interval="false">
          <div class="carousel-inner">
            {% for img in images %}
            {% set hero_src = img.image_url if img.image_url and (img.image_url.startswith('http://') or img.image_url.startswith('https://')) else url_for('static', filename='uploads/' + (img.image_url or 'demo.jpg')) %}
            <div class="carousel-item {% if loop.first %}active{% endif %}">
              <img src="{{ hero_src }}" class="d-block w-100 hero-img hotel-photo-trigger"
                   alt="{{ hotel.hotel_name }}"
                   data-bs-toggle="modal"
                   data-bs-target="#allPhotosModal"
                   data-gallery-index="{{ loop.index0 }}"
                   onerror="this.onerror=null;this.src='{{ url_for('static', filename='uploads/demo.jpg') }}';">
            </div>
            {% endfor %}
          </div>
          {% if images|length > 1 %}
          <button class="carousel-control-prev" type="button" data-bs-target="#hotelHeroCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#hotelHeroCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
          </button>
          {% endif %}
        </div>
        {% else %}
        <img src="{{ url_for('static', filename='uploads/demo.jpg') }}" class="hero-img" alt="{{ hotel.hotel_name }}">
        {% endif %}
      </div>
      <div class="col-lg-5">
        <h2 class="fw-bold mb-1">{{ hotel.hotel_name }}</h2>
        <div class="star mb-2">{{ hotel.star_rating }}★ Hotel</div>
        <div class="text-muted mb-1">{{ hotel.address_line1 }}{% if hotel.locality %}, {{ hotel.locality }}{% endif %}</div>
        <div class="text-muted mb-3">{{ hotel.city_name or '-' }}, {{ hotel.state_name or '-' }}{% if hotel.pincode %} - {{ hotel.pincode }}{% endif %}</div>
        <div class="small mb-2">
          <b>Owner:</b> {{ hotel.owner_display_name or hotel.owner_name or '-' }}
          {% if hotel.owner_verified_badge %}
          <span class="badge bg-success ms-1">Verified</span>
          {% endif %}
        </div>

        <div class="small mb-1"><b>Check-in:</b> {{ hotel.check_in_time or '-' }}</div>
        <div class="small mb-1"><b>Check-out:</b> {{ hotel.check_out_time or '-' }}</div>

        <div class="mt-2 d-flex flex-wrap gap-2">
          {% if hotel.couple_friendly %}<span class="badge bg-success">Couple Friendly</span>{% endif %}
          {% if hotel.breakfast_available %}<span class="badge bg-info text-dark">Breakfast</span>{% endif %}
          {% if hotel.parking_available %}<span class="badge bg-secondary">Parking</span>{% endif %}
          {% if hotel.pets_allowed %}<span class="badge bg-dark">Pets Allowed</span>{% endif %}
        </div>

        <div class="d-flex flex-wrap gap-2 mt-3">
          <a href="{{ url_for('hotels') }}" class="btn btn-outline-primary rounded-pill">Back to Hotels</a>
          <button class="btn btn-dark rounded-pill" data-bs-toggle="modal" data-bs-target="#allPhotosModal">
            See All Photos
          </button>
        </div>
      </div>
    </div>

    {% if images|length > 1 %}
    <div class="row g-2 mt-2">
      {% for img in images[:8] %}
      <div class="col-4 col-md-2">
        {% set thumb_src = img.image_url if img.image_url and (img.image_url.startswith('http://') or img.image_url.startswith('https://')) else url_for('static', filename='uploads/' + (img.image_url or 'demo.jpg')) %}
        <button type="button"
                class="thumb-btn {% if loop.first %}is-active{% endif %}"
                data-bs-target="#hotelHeroCarousel"
                data-bs-slide-to="{{ loop.index0 }}"
                aria-label="Hotel photo {{ loop.index }}">
          <img src="{{ thumb_src }}" class="thumb-img" alt="{{ hotel.hotel_name }}"
               onerror="this.onerror=null;this.src='{{ url_for('static', filename='uploads/demo.jpg') }}';">
        </button>
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </div>

  <div class="row g-4">
    <div class="col-lg-8">
      <div class="section-card p-3 mb-4">
        <h5 class="fw-bold">About Hotel</h5>
        <p class="text-muted mb-2">{{ hotel.hotel_description or 'No description available.' }}</p>
        {% if hotel.house_rules %}
        <h6 class="fw-bold mt-3">House Rules</h6>
        <p class="text-muted mb-0">{{ hotel.house_rules }}</p>
        {% endif %}
      </div>

      <div class="section-card p-3 mb-4">
        <h5 class="fw-bold mb-3">Complete Hotel Details</h5>
        {% if images %}
        <div id="hotelDetailsCarousel" class="carousel slide details-carousel mb-3" data-bs-interval="false">
          <div class="carousel-inner">
            {% for img in images %}
            {% set details_src = img.image_url if img.image_url and (img.image_url.startswith('http://') or img.image_url.startswith('https://')) else url_for('static', filename='uploads/' + (img.image_url or 'demo.jpg')) %}
            <div class="carousel-item {% if loop.first %}active{% endif %}">
              <img src="{{ details_src }}" class="d-block w-100 details-carousel-img" alt="{{ hotel.hotel_name }}"
                   onerror="this.onerror=null;this.src='{{ url_for('static', filename='uploads/demo.jpg') }}';">
            </div>
            {% endfor %}
          </div>
          {% if images|length > 1 %}
          <button class="carousel-control-prev" type="button" data-bs-target="#hotelDetailsCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#hotelDetailsCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
          </button>
          {% endif %}
        </div>
        {% endif %}
        <div class="row g-2 details-grid">
          <div class="col-md-6"><div class="detail-pill"><span>Service Name</span><strong>{{ hotel.service_name or '-' }}</strong></div></div>
          <div class="col-md-6"><div class="detail-pill"><span>Brand</span><strong>{{ hotel.brand_name or '-' }}</strong></div></div>
          <div class="col-md-6"><div class="detail-pill"><span>Hotel Name</span><strong>{{ hotel.hotel_name or '-' }}</strong></div></div>
          <div class="col-md-6"><div class="detail-pill"><span>Star Rating</span><strong>{{ hotel.star_rating or 0 }}★</strong></div></div>
          <div class="col-md-6"><div class="detail-pill"><span>Owner</span><strong>{{ hotel.owner_display_name or hotel.owner_name or '-' }}</strong></div></div>
          <div class="col-md-6"><div class="detail-pill"><span>Owner Badge</span><strong>{{ 'Verified' if hotel.owner_verified_badge else 'Not Verified' }}</strong></div></div>
          <div class="col-md-6"><div class="detail-pill"><span>Address Line 1</span><strong>{{ hotel.address_line1 or '-' }}</strong></div></div>
          <div class="col-md-6"><div class="detail-pill"><span>Address Line 2</span><strong>{{ hotel.address_line2 or '-' }}</strong></div></div>
          <div class="col-md-6"><div class="detail-pill"><span>Locality</span><strong>{{ hotel.locality or '-' }}</strong></div></div>
          <div class="col-md-6"><div class="detail-pill"><span>Landmark</span><strong>{{ hotel.landmark or '-' }}</strong></div></div>
          <div class="col-md-4"><div class="detail-pill"><span>City</span><strong>{{ hotel.city_name or '-' }}</strong></div></div>
          <div class="col-md-4"><div class="detail-pill"><span>State</span><strong>{{ hotel.state_name or '-' }}</strong></div></div>
          <div class="col-md-4"><div class="detail-pill"><span>Pincode</span><strong>{{ hotel.pincode or '-' }}</strong></div></div>
          <div class="col-md-6"><div class="detail-pill"><span>Check-In Time</span><strong>{{ hotel.check_in_time or '-' }}</strong></div></div>
          <div class="col-md-6"><div class="detail-pill"><span>Check-Out Time</span><strong>{{ hotel.check_out_time or '-' }}</strong></div></div>
          <div class="col-md-3"><div class="detail-pill"><span>Couple Friendly</span><strong>{{ 'Yes' if hotel.couple_friendly else 'No' }}</strong></div></div>
          <div class="col-md-3"><div class="detail-pill"><span>Breakfast</span><strong>{{ 'Yes' if hotel.breakfast_available else 'No' }}</strong></div></div>
          <div class="col-md-3"><div class="detail-pill"><span>Parking</span><strong>{{ 'Yes' if hotel.parking_available else 'No' }}</strong></div></div>
          <div class="col-md-3"><div class="detail-pill"><span>Pets Allowed</span><strong>{{ 'Yes' if hotel.pets_allowed else 'No' }}</strong></div></div>
          <div class="col-md-6"><div class="detail-pill"><span>Latitude</span><strong>{{ hotel.latitude if hotel.latitude is not none else '-' }}</strong></div></div>
          <div class="col-md-6"><div class="detail-pill"><span>Longitude</span><strong>{{ hotel.longitude if hotel.longitude is not none else '-' }}</strong></div></div>
        </div>
      </div>

      <div class="section-card p-3">
        <h5 class="fw-bold mb-3">Room Availability (Type-wise)</h5>
        {% if room_types %}
        <div class="table-responsive">
          <table class="table align-middle mb-0">
            <thead>
              <tr>
                <th>Room Type</th>
                <th>Guests</th>
                <th>Price</th>
                <th>Total</th>
                <th>Available</th>
              </tr>
            </thead>
            <tbody>
              {% for r in room_types %}
              <tr>
                <td>
                  <strong>{{ r.room_type_name }}</strong><br>
                  <small class="text-muted">{{ r.bed_type or '-' }}</small>
                </td>
                <td>{{ r.max_guests }}</td>
                <td>Rs {{ r.base_price }}</td>
                <td>{{ r.total_rooms }}</td>
                <td>
                  {% if r.available_rooms > 0 %}
                    <span class="badge bg-success">{{ r.available_rooms }}</span>
                  {% else %}
                    <span class="badge bg-danger">Sold Out</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="alert alert-light border mb-0">Room types are not published yet.</div>
        {% endif %}
      </div>
    </div>

    <div class="col-lg-4">
      <div class="section-card p-3 mb-4">
        <h6 class="fw-bold">Amenities</h6>
        {% if amenities %}
          <div class="d-flex flex-wrap gap-2">
            {% for a in amenities %}
            <span class="badge bg-light text-dark border"><i class="bi {{ a.amenity_icon or 'bi-check2' }}"></i> {{ a.amenity_name }}</span>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted mb-0">No amenities added.</p>
        {% endif %}
      </div>

      {% if session.get('role') in ['customer', 'organizer'] %}
      <div class="section-card p-3 mb-4">
        <h6 class="fw-bold">Book This Hotel</h6>
        <form method="POST" class="row g-2">
          <div class="col-12">
            <label class="form-label small">Room Type</label>
            <select name="room_type_id" class="form-select" required>
              <option value="">Select room type</option>
              {% for r in room_types %}
              <option value="{{ r.id }}" {% if r.available_rooms <= 0 %}disabled{% endif %}>
                {{ r.room_type_name }} | Rs {{ r.base_price }} | Available {{ r.available_rooms }}
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-6">
            <label class="form-label small">Check-In</label>
            <input type="date" name="check_in_date" class="form-control" required>
          </div>
          <div class="col-6">
            <label class="form-label small">Check-Out</label>
            <input type="date" name="check_out_date" class="form-control" required>
          </div>
          <div class="col-12">
            <label class="form-label small">Guests</label>
            <input type="number" name="guests_count" min="1" value="2" class="form-control" required>
          </div>
          <div class="col-6">
            <label class="form-label small">ID Proof Type</label>
            <select name="id_proof_type" class="form-select" required>
              <option value="">Select ID proof</option>
              {% for proof_type in id_proof_types %}
              <option value="{{ proof_type }}">{{ proof_type }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-6">
            <label class="form-label small">ID Proof Number</label>
            <input type="text" name="id_proof_number" maxlength="120" class="form-control" required>
          </div>
          <div class="col-12">
            <button class="btn btn-success w-100">Book Now</button>
          </div>
        </form>
      </div>
      {% elif not session.get('user_id') %}
      <div class="section-card p-3 mb-4">
        <h6 class="fw-bold">Book This Hotel</h6>
        <p class="text-muted small mb-3">Login is required to complete hotel booking.</p>
        <a href="{{ url_for('login') }}" class="btn btn-primary w-100">Login to Book</a>
      </div>
      {% endif %}

      <div class="section-card p-3">
        <h6 class="fw-bold">Recent Inventory Updates</h6>
        {% if inventory_updates %}
        <div class="small">
          {% for item in inventory_updates %}
          <div class="border-bottom py-2">
            <div><b>{{ item.room_type_name }}</b></div>
            <div class="text-muted">{{ item.old_available }} -> {{ item.new_available }} by {{ item.changed_by_name }}</div>
            <div class="text-muted">{{ item.created_at }}</div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <p class="text-muted mb-0">No updates yet.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="allPhotosModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ hotel.hotel_name }} - All Photos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {% if images %}
        <div id="allPhotosCarousel" class="carousel slide" data-bs-interval="false">
          <div class="carousel-inner">
            {% for img in images %}
            {% set modal_src = img.image_url if img.image_url and (img.image_url.startswith('http://') or img.image_url.startswith('https://')) else url_for('static', filename='uploads/' + (img.image_url or 'demo.jpg')) %}
            <div class="carousel-item {% if loop.first %}active{% endif %}">
              <img src="{{ modal_src }}" class="d-block w-100 rounded modal-img" alt="{{ hotel.hotel_name }}"
                   onerror="this.onerror=null;this.src='{{ url_for('static', filename='uploads/demo.jpg') }}';">
            </div>
            {% endfor %}
          </div>
          {% if images|length > 1 %}
          <button class="carousel-control-prev" type="button" data-bs-target="#allPhotosCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#allPhotosCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
          </button>
          {% endif %}
        </div>
        {% else %}
        <img src="{{ url_for('static', filename='uploads/demo.jpg') }}" class="d-block w-100 rounded modal-img" alt="{{ hotel.hotel_name }}">
        {% endif %}
      </div>
    </div>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function(){
  const modalEl = document.getElementById('allPhotosModal');
  const modalCarouselEl = document.getElementById('allPhotosCarousel');
  const heroCarouselEl = document.getElementById('hotelHeroCarousel');
  const thumbButtons = Array.from(document.querySelectorAll('.thumb-btn[data-bs-target="#hotelHeroCarousel"]'));
  if(!modalEl || !modalCarouselEl || typeof bootstrap === 'undefined') return;

  const modalCarousel = bootstrap.Carousel.getOrCreateInstance(modalCarouselEl, { interval: false, ride: false, wrap: true });
  const heroCarousel = heroCarouselEl ? bootstrap.Carousel.getOrCreateInstance(heroCarouselEl, { interval: false, ride: false, wrap: true }) : null;

  function setActiveThumb(index){
    thumbButtons.forEach((btn, i) => btn.classList.toggle('is-active', i === index));
  }

  function getActiveHeroIndex(){
    if(!heroCarouselEl) return 0;
    const slides = Array.from(heroCarouselEl.querySelectorAll('.carousel-item'));
    const active = heroCarouselEl.querySelector('.carousel-item.active');
    const idx = slides.indexOf(active);
    return idx >= 0 ? idx : 0;
  }

  if(heroCarouselEl && heroCarousel){
    setActiveThumb(getActiveHeroIndex());
    heroCarouselEl.addEventListener('slid.bs.carousel', function(event){
      setActiveThumb(Number(event.to || 0));
    });
    thumbButtons.forEach((btn) => {
      btn.addEventListener('click', function(){
        setActiveThumb(Number(btn.dataset.bsSlideTo || 0));
      });
    });
  }

  modalEl.addEventListener('show.bs.modal', function(event){
    const trigger = event.relatedTarget;
    if(trigger && trigger.dataset && trigger.dataset.galleryIndex){
      modalCarousel.to(Number(trigger.dataset.galleryIndex || 0));
      return;
    }
    modalCarousel.to(getActiveHeroIndex());
  });
});
</script>
{% endblock %}
